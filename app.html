<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanguard Bingo Analytics</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Vanguard">
    <link rel="apple-touch-icon" href="./vanguard_logo.png">
    
    <!-- PWA Service Worker Registration -->
    <script>
        // PWA Install prompt handling
        let deferredPrompt;
        let installButton;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            console.log('Install prompt captured - PWA can be installed');
            
            // Show install button if it exists
            if (installButton) {
                installButton.style.display = 'block';
            }
            
            // Also show a notification in console
            console.log('%c📱 This app can be installed! Look for the install button in the header.', 'color: #3b82f6; font-weight: bold; font-size: 14px;');
        });
        
        // Handle successful installation
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed successfully!');
            // Hide install button if it exists
            if (installButton) {
                installButton.style.display = 'none';
            }
            deferredPrompt = null;
        });
        
        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                        
                        // Check for updates immediately and every hour
                        registration.update();
                        setInterval(() => {
                            registration.update();
                        }, 3600000);
                        
                        // Listen for new service worker waiting
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New update available
                                    console.log('New version available! Please close and reopen the app to update.');
                                    if (window.showUpdateNotification) {
                                        window.showUpdateNotification();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => console.log('ServiceWorker registration failed:', err));
            });
            
            // Listen for data updates from service worker
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'DATA_UPDATED') {
                    console.log('Data updated via background sync');
                    // Refresh the dashboard with new data
                    if (window.VanguardData) {
                        window.VanguardData.updateDashboard();
                    }
                }
            });
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Light Mode */
        body.light-mode {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .light-mode .top-nav {
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .light-mode .nav-brand {
            color: #1e293b;
        }

        .light-mode .nav-tab {
            color: #64748b;
        }

        .light-mode .nav-tab.active {
            background: #f1f5f9;
            color: #1e293b;
            border-color: #cbd5e1;
        }

        .light-mode .nav-tab:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .light-mode .visual-analytics {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .light-mode .visual-event-title {
            color: #1e293b;
        }

        .light-mode .visual-meta-item {
            color: #64748b;
        }

        .light-mode .visual-select {
            background: rgba(241, 245, 249, 0.8);
            border: 1px solid rgba(203, 213, 225, 0.6);
            color: #1e293b;
        }

        .light-mode .event-btn {
            background: linear-gradient(135deg, rgba(241, 245, 249, 0.9), rgba(226, 232, 240, 0.9));
            border: 1px solid rgba(203, 213, 225, 0.6);
            color: #475569;
        }

        .light-mode .event-btn:hover {
            background: linear-gradient(135deg, rgba(226, 232, 240, 1), rgba(203, 213, 225, 1));
        }

        .light-mode .dropdown-menu {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(203, 213, 225, 0.6);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .light-mode .dropdown-item {
            color: #475569;
        }

        .light-mode .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #1e293b;
        }

        .light-mode .spotlight-card {
            background: rgba(241, 245, 249, 0.8);
            border: 1px solid rgba(203, 213, 225, 0.3);
        }

        .light-mode .spotlight-card.highlight {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.05), rgba(167, 139, 250, 0.05));
            border-color: rgba(96, 165, 250, 0.2);
        }

        .light-mode .spotlight-label {
            color: #64748b;
        }

        .light-mode .spotlight-value {
            color: #1e293b;
        }

        .light-mode .chart-container {
            background: rgba(241, 245, 249, 0.8);
            border: 1px solid rgba(203, 213, 225, 0.3);
        }

        .light-mode .chart-title {
            color: #475569;
        }

        .light-mode .chart-selector {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(203, 213, 225, 0.6);
            color: #1e293b;
        }

        .light-mode .donut-center {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
        }

        .light-mode .donut-total {
            color: #1e293b;
        }

        .light-mode .donut-label {
            color: #64748b;
        }

        .light-mode .legend-item {
            color: #475569;
        }

        .light-mode .comp-card {
            background: rgba(241, 245, 249, 0.8);
            border: 1px solid rgba(203, 213, 225, 0.3);
        }

        .light-mode .comp-card-title {
            color: #475569;
        }

        .light-mode .comp-metric-label {
            color: #64748b;
        }

        .light-mode .location-btn,
        .light-mode .period-btn {
            background: rgba(241, 245, 249, 0.8);
            border: 1px solid rgba(203, 213, 225, 0.6);
            color: #475569;
        }

        .light-mode .location-btn:hover,
        .light-mode .period-btn:hover {
            background: rgba(226, 232, 240, 0.9);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .theme-toggle-icon {
            font-size: 18px;
        }

        .theme-toggle-text {
            color: #cbd5e1;
            font-size: 14px;
            font-weight: 500;
        }

        .light-mode .theme-toggle {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .light-mode .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .light-mode .theme-toggle-text {
            color: #475569;
        }

        /* Top Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #1a1a2e;
            padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 85px;
        }

        .nav-brand {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
        }

        .nav-tab {
            padding: 8px 20px;
            background: transparent;
            color: #8892b0;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-tab.active {
            background: #2d3748;
            color: white;
            border-color: #4a5568;
        }

        .nav-tab:hover {
            background: #2d3748;
            color: white;
        }

        /* Container Styles */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 85px;
        }

        .visual-analytics {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        /* Visual Header */
        .visual-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .visual-event-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .separator {
            width: 1px;
            height: 20px;
            background: rgba(255,255,255,0.2);
        }

        .visual-event-meta {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .visual-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-size: 14px;
        }

        .visual-meta-item .icon {
            font-size: 16px;
        }

        .visual-controls {
            display: flex;
            gap: 10px;
        }

        .visual-select {
            padding: 10px 15px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .visual-select:hover {
            background: rgba(51, 65, 85, 0.8);
            border-color: rgba(148, 163, 184, 0.5);
        }

        /* Event Selector */
        .style-selector {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 0 20px;
        }

        .event-selector-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* ===== CLEAN HEADER LAYOUT ===== */
        .event-header-clean {
            background: #f8f9fa;
            padding: 20px;
            margin: -30px -30px 20px -30px;
            border-radius: 20px 20px 12px 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        
        .event-header-clean .header-row-1 {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .event-header-clean .header-row-2 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .event-info-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .visual-event-meta {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .event-header-clean .comparison-controls-box {
            background: white;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .comparison-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }
        
        .title-section {
            font-size: 20px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }
        
        .buttons-section {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .compare-label {
            color: #60a5fa;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
        }
        
        .metadata-section {
            display: flex;
            gap: 16px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .controls-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .period-buttons {
            display: flex;
            gap: 4px;
        }
        
        .compare-btn {
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .compare-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .event-btn {
            padding: 7px 14px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            color: rgba(255,255,255,0.85);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            white-space: nowrap;
        }

        .event-btn:hover:not(.active) {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.25);
        }

        .event-btn.active {
            background: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        /* Dropdown */
        .dropdown-container {
            position: relative;
        }

        .dropdown-trigger {
            position: relative;
            padding-right: 30px;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            margin-top: 5px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.2);
            color: white;
        }

        /* Spotlight Metrics */
        .spotlight-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .spotlight-card {
            background: rgba(241, 245, 249, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .spotlight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .spotlight-card.expanded {
            z-index: 100;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }
        
        .spotlight-expansion {
            display: none;
            position: absolute;
            top: 100%;
            left: -1px;
            right: -1px;
            background: rgba(241, 245, 249, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 0 0 12px 12px;
            padding: 15px;
            margin-top: -1px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .spotlight-card.expanded .spotlight-expansion {
            display: block;
        }
        
        .expansion-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .expansion-value {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .expansion-count {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        .spotlight-card.highlight {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(167, 139, 250, 0.1));
            border-color: rgba(96, 165, 250, 0.3);
        }

        .spotlight-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .spotlight-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .spotlight-change {
            font-size: 13px;
            font-weight: 600;
        }

        .change-positive {
            color: #34d399;
        }

        .change-negative {
            color: #f87171;
        }

        /* Chart Section */
        .visual-chart-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: flex-start;
        }
        
        /* Mobile Responsive Styles */
        /* Header-specific isolated styles */
        .event-header-clean .visual-event-title {
            font-size: 20px !important;
            font-weight: 600 !important;
            color: #212529 !important;
            margin: 0 !important;
        }
        
        .event-header-clean .visual-meta-item {
            color: #6c757d !important;
            font-size: 13px !important;
        }
        
        .event-header-clean .event-btn {
            padding: 8px 14px !important;
            background: white !important;
            color: #495057 !important;
            border: 1px solid #dee2e6 !important;
            font-weight: 500 !important;
        }
        
        .event-header-clean .event-btn:hover:not(.active) {
            background: #f8f9fa !important;
            border-color: #adb5bd !important;
            transform: translateY(-1px);
        }
        
        .event-header-clean .event-btn.active {
            background: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }
        
        .event-header-clean .compare-label {
            color: #0066cc !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }
        
        .event-header-clean .period-buttons {
            display: flex;
            gap: 4px;
        }
        
        .event-header-clean .period-buttons button {
            padding: 4px 10px;
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .event-header-clean .period-buttons button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .event-header-clean .checkbox-label {
            font-size: 11px;
            color: #495057;
        }
        
        .event-header-clean #hotballFilter {
            padding: 3px 8px;
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .event-header-clean .pool-count {
            font-size: 11px;
            color: #6c757d;
        }
        
        .event-header-clean .pool-count strong {
            color: #28a745;
            font-weight: 600;
        }
        
        .event-header-clean .separator {
            width: 1px;
            height: 16px;
            background: #dee2e6;
        }
        
        @media (max-width: 768px) {
            /* Stack charts vertically on mobile */
            .visual-chart-section {
                flex-direction: column !important;
                gap: 20px;
            }
            
            /* Make chart containers full width */
            .chart-container {
                width: 100% !important;
                max-width: 100% !important;
                margin-right: 0 !important;
            }
            
            /* Hotball indicator full width */
            .hotball-indicator {
                width: 100% !important;
                margin-right: 0 !important;
                margin-bottom: 20px;
            }
            
            /* Header responsive */
            .header-row-1 > div {
                flex-direction: column !important;
                gap: 15px;
                align-items: stretch !important;
            }
            
            .visual-event-title {
                font-size: 20px !important;
                text-align: center;
            }
            
            /* Stack event buttons vertically */
            .event-selector-group {
                width: 100%;
            }
            
            .event-selector-group > div {
                flex-direction: column !important;
                width: 100%;
            }
            
            .event-btn {
                width: 100% !important;
                text-align: left !important;
                padding: 10px 12px !important;
            }
            
            /* Row 2 responsive */
            .header-row-2 > div {
                flex-direction: column !important;
                gap: 12px;
                align-items: stretch !important;
            }
            
            .visual-event-meta {
                justify-content: center;
                font-size: 12px;
            }
            
            /* Comparison controls responsive */
            .comparison-controls-inline {
                width: 100%;
                flex-wrap: wrap !important;
                justify-content: space-between;
                gap: 8px !important;
                padding: 12px !important;
            }
            
            .comparison-controls-inline > span:first-child {
                width: 100%;
                text-align: center;
                margin-bottom: 8px;
            }
            
            .period-buttons {
                flex: 1;
                justify-content: center;
            }
            
            /* Spotlight cards responsive */
            .spotlight-metrics {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .spotlight-card {
                padding: 12px !important;
            }
            
            .spotlight-value {
                font-size: 20px !important;
            }
            
            /* Donut charts side by side on mobile */
            .donut-chart {
                width: 120px !important;
                height: 120px !important;
            }
            
            /* Navigation responsive */
            .nav-container {
                padding: 10px !important;
            }
            
            .nav-tabs {
                gap: 5px !important;
            }
            
            .nav-tab {
                padding: 8px 12px !important;
                font-size: 13px !important;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small screens */
            .spotlight-metrics {
                grid-template-columns: 1fr !important;
            }
            
            .period-buttons button {
                padding: 6px 8px !important;
                font-size: 10px !important;
            }
            
            #hotballFilter {
                font-size: 10px !important;
            }
        }
        
        /* NEW: Comprehensive responsive fixes for narrow screens */
        @media (max-width: 700px) {
            /* Hide event title section on narrow screens to make room for buttons */
            .event-info-section {
                display: none !important;
            }
            
            /* Fix header wrapping - make it more compact */
            .top-nav {
                flex-direction: column;
                height: auto !important;
                padding: 10px 5px;
                gap: 5px;
            }
            
            .nav-brand {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .nav-brand img {
                height: 40px !important;
                margin-right: 8px !important;
            }
            
            .nav-brand span {
                font-size: 16px !important;
            }
            
            /* Fix navigation layout */
            .top-nav > div:last-child {
                width: 100%;
                flex-direction: column;
                gap: 5px;
            }
            
            .nav-tabs {
                justify-content: center;
                width: 100%;
                gap: 2px !important;
            }
            
            .nav-tab {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }
            
            /* Fix event buttons - 2x2 grid layout WITH Previous Events visible */
            .header-row-1 {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 5px !important;
                padding: 5px !important;
                padding-top: 25px !important; /* More top padding to push further below header */
                margin-top: 20px !important; /* More margin to separate from header */
                justify-content: space-between !important;
                position: relative !important;
                z-index: 1 !important; /* Lower z-index than header */
            }
            
            /* Force ALL event buttons to be visible with proper height */
            .header-row-1 .event-btn {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                min-height: 40px !important; /* Bigger minimum height */
                height: auto !important;
                background: white !important;
                border: 1px solid #e5e7eb !important;
                box-sizing: border-box !important;
            }
            
            /* Make all 4 buttons sized correctly - remove any height restrictions */
            .header-row-1 > button:nth-child(1),
            .header-row-1 > button:nth-child(2),
            .header-row-1 > button:nth-child(3),
            .header-row-1 .dropdown-trigger {
                display: block !important;
                flex: 0 0 48% !important;
                min-width: 0 !important;
                min-height: 40px !important;
                height: auto !important;
                margin: 0 !important;
                font-size: 11px !important;
                padding: 10px 5px !important; /* More padding for height */
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                line-height: 1.4 !important;
            }
            
            /* Hide ONLY the 4th regular button */
            .header-row-1 > button:nth-child(4):not(.dropdown-trigger) {
                display: none !important;
            }
            
            /* Show Previous Events dropdown as 4th item */
            .dropdown-container {
                display: block !important;
                flex: 0 0 48% !important;
                min-width: 0 !important;
                margin: 0 !important;
            }
            
            .dropdown-trigger {
                width: 100% !important;
                font-size: 11px !important;
                padding: 8px 5px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
            
            /* Fix the second row (header-row-2) - center when broken */
            .header-row-2 {
                flex-wrap: wrap !important;
                gap: 10px !important;
                padding: 5px !important;
                justify-content: center !important; /* Center the elements */
            }
            
            .header-row-2 > div {
                flex: 0 0 48% !important;  /* Each element takes 48% width */
                min-width: 0 !important;
            }
            
            /* When second row breaks, center the bottom elements */
            .header-row-2 > div:nth-child(3),
            .header-row-2 > div:nth-child(4) {
                flex: 0 0 48% !important;
            }
            
            /* If there are only 2 elements in bottom row, center them */
            .header-row-2 > div:only-child,
            .header-row-2 > div:nth-last-child(2):first-child {
                margin: 0 auto !important;
            }
            
            /* Fix Compare To section - make it stack vertically */
            .comparison-controls-box {
                width: 100% !important;
                padding: 10px !important;
                margin: 5px !important;
            }
            
            .comparison-controls {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 10px !important;
            }
            
            .period-buttons {
                justify-content: center !important;
            }
            
            .separator {
                display: none !important;
            }
            
            .checkbox-label {
                justify-content: center !important;
                font-size: 12px !important;
            }
            
            /* Fix metric cards to be properly responsive */
            .spotlight-metrics {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
                padding: 8px !important;
            }
            
            .spotlight-card {
                min-height: auto !important;
                padding: 10px !important;
            }
            
            .spotlight-label {
                font-size: 10px !important;
            }
            
            .spotlight-value {
                font-size: 18px !important;
            }
            
            /* Fix charts for narrow screens - make them scrollable and right-aligned */
            #monthly-chart-container {
                overflow-x: auto !important;
                overflow-y: hidden !important;
                max-width: 100% !important;
                padding: 0 !important;
                direction: rtl !important; /* Makes scroll start from right */
            }
            
            #monthly-chart-container > div {
                min-width: 700px !important; /* Minimum width for readability */
                overflow: visible !important;
                direction: ltr !important; /* Reset text direction inside */
            }
            
            #monthly-chart-container svg {
                width: 700px !important; /* Fixed width for consistency */
                height: 250px !important;
            }
            
            /* Chart container should have horizontal scroll */
            .chart-placeholder {
                overflow-x: auto !important;
                overflow-y: hidden !important;
            }
            
            /* Fix donut chart container */
            .chart-container {
                padding: 10px !important;
                margin: 5px !important;
                max-width: 100% !important;
            }
            
            /* Fix Hotball status bar */
            .hotball-indicator {
                padding: 10px !important;
                margin: 5px !important;
            }
            
            .progress-bar {
                height: 25px !important;
            }
            
            /* Fix chart controls */
            .chart-title {
                font-size: 14px !important;
            }
            
            #chartTypeSelector {
                font-size: 11px !important;
                padding: 4px 6px !important;
            }
        }
        
        @media (max-width: 600px) {
            /* Even smaller screens */
            .nav-brand img {
                height: 40px !important;
            }
            
            .nav-brand span {
                font-size: 16px !important;
            }
            
            .nav-tabs button {
                padding: 8px 12px !important;
                font-size: 12px !important;
            }
            
            /* Stack event buttons vertically */
            .event-selector-buttons button {
                flex: 1 1 100%;
                max-width: none;
            }
            
            /* Single column metrics on very small screens */
            .spotlight-metrics {
                grid-template-columns: 1fr !important;
            }
            
            /* Adjust chart selector dropdown */
            #chartTypeSelector {
                font-size: 11px !important;
                padding: 4px 8px !important;
            }
            
            /* Adjust data labels checkbox */
            #dataLabelsToggle + span {
                font-size: 11px !important;
            }
        }

        .chart-container {
            background: rgba(241, 245, 249, 0.8);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-placeholder {
            margin-top: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 14px;
        }

        .chart-selector {
            padding: 6px 12px;
            background: rgba(241, 245, 249, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 6px;
            color: #475569;
            font-size: 12px;
            cursor: pointer;
        }

        /* Donut Chart */
        .donut-chart {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            position: relative;
            margin: 10px 0;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            width: 110px;
            height: 110px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .donut-total {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .donut-label {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        /* Revenue Legend */
        .revenue-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #475569;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
        }

        /* Comparison Cards */
        .comparison-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .comp-card {
            background: rgba(241, 245, 249, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .comp-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .comp-metrics {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .comp-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.05);
        }

        .comp-metric-label {
            font-size: 13px;
            color: #64748b;
        }

        .comp-metric-change {
            font-size: 13px;
            font-weight: 600;
        }

        .arrow-up {
            color: #34d399;
        }

        .arrow-down {
            color: #f87171;
        }

        /* Hotball Indicator */
        .hotball-circle {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 5px 20px rgba(251, 191, 36, 0.4);
            }
            50% {
                box-shadow: 0 5px 30px rgba(251, 191, 36, 0.6);
            }
        }
        
        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* View Container */
        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        /* Dashboard Specific Styles */
        .location-btn, .period-btn {
            padding: 10px 20px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #cbd5e1;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .location-btn:hover, .period-btn:hover {
            background: rgba(51, 65, 85, 0.6);
        }

        .location-btn.active, .period-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        /* Product Performance Box Styles */
        .product-box {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .product-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .product-box.expanded {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }
        
        .product-expansion {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 300px;
            }
        }
        
        @keyframes highlightFade {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.8), 0 0 20px 5px rgba(59, 130, 246, 0.6);
                border-color: #3b82f6;
                transform: scale(1.02);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0), 0 0 30px 10px rgba(59, 130, 246, 0.4);
                border-color: #3b82f6;
                transform: scale(1.01);
            }
            100% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0), 0 2px 8px rgba(0, 0, 0, 0.1);
                border-color: #e5e7eb;
                transform: scale(1);
            }
        }
        
        .comparison-controls-box.highlight-animation {
            animation: highlightFade 2s ease-out;
        }
        
        @media (max-width: 768px) {
            .product-boxes-container {
                grid-template-columns: 1fr !important;
            }
        }

        /* Projection tooltip hover effect */
        .projection-tooltip {
            opacity: 0 !important;
            visibility: hidden !important;
            transition: opacity 0.2s, visibility 0.2s !important;
        }
        
        span[style*="cursor: help"]:hover .projection-tooltip {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Metric box tooltip hover effect */
        .metric-tooltip {
            opacity: 0 !important;
            visibility: hidden !important;
            transition: opacity 0.2s, visibility 0.2s !important;
        }
        
        div[style*="cursor: help"]:hover .metric-tooltip {
            opacity: 1 !important;
            visibility: visible !important;
        }
    </style>
    <script>
        // Sound System
        const AppSounds = {
            audioContext: null,
            enabled: true,
            volume: 0.3, // Default volume 30%
            
            init() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            },
            
            play(soundType) {
                if (!this.enabled || !this.audioContext) return;
                
                switch(soundType) {
                    case 'welcome':
                        this.playWelcomeChime();
                        break;
                    case 'click':
                        this.playSoftClick();
                        break;
                    case 'navigate':
                        this.playSwoosh();
                        break;
                    case 'refresh':
                        this.playDataSync();
                        break;
                    case 'success':
                        this.playSuccessDing();
                        break;
                    case 'event':
                        this.playCasinoChip();
                        break;
                }
            },
            
            playWelcomeChime() {
                // Three ascending notes with reverb-like delay
                const notes = [392, 523.25, 659.25]; // G4, C5, E5
                notes.forEach((freq, i) => {
                    setTimeout(() => {
                        const osc = this.audioContext.createOscillator();
                        const gain = this.audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(this.audioContext.destination);
                        osc.type = 'sine';
                        osc.frequency.value = freq;
                        gain.gain.value = this.volume * (0.6 - i * 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.4);
                        osc.start();
                        osc.stop(this.audioContext.currentTime + 0.4);
                    }, i * 100);
                });
            },
            
            playSoftClick() {
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                osc.connect(gain);
                gain.connect(this.audioContext.destination);
                osc.frequency.value = 800;
                gain.gain.value = this.volume * 0.2;
                gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.05);
                osc.start();
                osc.stop(this.audioContext.currentTime + 0.05);
            },
            
            playSwoosh() {
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                const filter = this.audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 1000;
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.audioContext.destination);
                osc.type = 'sawtooth';
                osc.frequency.value = 200;
                osc.frequency.exponentialRampToValueAtTime(50, this.audioContext.currentTime + 0.1);
                filter.frequency.exponentialRampToValueAtTime(200, this.audioContext.currentTime + 0.1);
                gain.gain.value = this.volume * 0.15;
                gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                osc.start();
                osc.stop(this.audioContext.currentTime + 0.1);
            },
            
            playDataSync() {
                // Quick ascending beeps
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const osc = this.audioContext.createOscillator();
                        const gain = this.audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(this.audioContext.destination);
                        osc.type = 'square';
                        osc.frequency.value = 400 + (i * 200);
                        gain.gain.value = this.volume * 0.15;
                        gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.05);
                        osc.start();
                        osc.stop(this.audioContext.currentTime + 0.05);
                    }, i * 80);
                }
            },
            
            playSuccessDing() {
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                osc.connect(gain);
                gain.connect(this.audioContext.destination);
                osc.frequency.value = 523.25; // C5
                osc.frequency.setValueAtTime(659.25, this.audioContext.currentTime + 0.05); // E5
                gain.gain.value = this.volume * 0.3;
                gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.15);
                osc.start();
                osc.stop(this.audioContext.currentTime + 0.15);
            },
            
            playCasinoChip() {
                // Two quick ticks
                for (let i = 0; i < 2; i++) {
                    setTimeout(() => {
                        const osc = this.audioContext.createOscillator();
                        const gain = this.audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(this.audioContext.destination);
                        osc.frequency.value = 1000 + (i * 200);
                        gain.gain.value = this.volume * 0.25;
                        gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.03);
                        osc.start();
                        osc.stop(this.audioContext.currentTime + 0.03);
                    }, i * 30);
                }
            }
        };
        
        // Welcome Popup Functions
        function showWelcomePopup() {
            const popup = document.getElementById('welcomePopup');
            const overlay = document.getElementById('welcomeOverlay');
            const titleEl = document.getElementById('welcomeTitle');
            const messageEl = document.getElementById('welcomeMessage');
            
            // Check if first visit ever
            const lastVisit = localStorage.getItem('vanguard_last_visit');
            const eventCount = window.VanguardData?.getAllEvents()?.length || 0;
            
            if (!lastVisit) {
                // First visit ever
                titleEl.textContent = 'Welcome to Vanguard Charity Bingo Reporting';
                messageEl.textContent = `Events Loaded: ${eventCount}`;
                localStorage.setItem('vanguard_first_visit', new Date().toISOString());
            } else {
                // Returning user
                const lastVisitDate = new Date(lastVisit);
                const eventsSinceLastVisit = calculateNewEvents(lastVisitDate);
                titleEl.textContent = 'Welcome Back!';
                messageEl.textContent = eventsSinceLastVisit > 0 
                    ? `${eventsSinceLastVisit} events added since your last visit`
                    : 'No new events since your last visit';
            }
            
            // Update last visit time
            localStorage.setItem('vanguard_last_visit', new Date().toISOString());
            
            // Show popup with animation
            setTimeout(() => {
                overlay.classList.add('show');
                popup.classList.add('show');
                AppSounds.play('welcome');
            }, 500);
        }
        
        function closeWelcomePopup() {
            const popup = document.getElementById('welcomePopup');
            const overlay = document.getElementById('welcomeOverlay');
            
            AppSounds.play('click');
            popup.classList.remove('show');
            overlay.classList.remove('show');
            
            setTimeout(() => {
                popup.style.display = 'none';
                overlay.style.display = 'none';
            }, 300);
        }
        
        function calculateNewEvents(lastVisitDate) {
            const events = window.VanguardData?.getAllEvents() || [];
            let newCount = 0;
            
            // Count events that we haven't seen before (compare with last known event count)
            const lastEventCount = parseInt(localStorage.getItem('vanguard_last_event_count') || '0');
            const currentEventCount = events.length;
            
            if (currentEventCount > lastEventCount) {
                newCount = currentEventCount - lastEventCount;
            }
            
            // Update the stored count
            localStorage.setItem('vanguard_last_event_count', currentEventCount.toString());
            
            return newCount;
        }
        
        // Define critical functions early
        function switchView(view) {
            // Will be fully implemented after DOM loads
        }
    </script>
    <style>
        /* Welcome Popup Styles */
        .welcome-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10000;
            text-align: center;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 500px;
        }
        
        .welcome-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .welcome-popup h2 {
            margin: 0 0 15px 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .welcome-popup p {
            margin: 0 0 25px 0;
            font-size: 18px;
            opacity: 0.95;
        }
        
        .welcome-popup button {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .welcome-popup button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .welcome-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>
<body class="light-mode">
    <!-- Welcome Popup -->
    <div class="welcome-overlay" id="welcomeOverlay"></div>
    <div class="welcome-popup" id="welcomePopup">
        <img src="./vanguard_logo.png" alt="Vanguard" style="height: 195px; margin-bottom: 10px;">
        <h2 id="welcomeTitle" style="margin-top: 0; margin-bottom: 10px;">Welcome to Vanguard</h2>
        <p id="welcomeMessage" style="margin-bottom: 15px;">Loading...</p>
        <button onclick="closeWelcomePopup()">Get Started</button>
    </div>
    
    <!-- Refresh Popup -->
    <div class="welcome-overlay" id="refreshOverlay" style="display: none;"></div>
    <div class="welcome-popup" id="refreshPopup" style="display: none;">
        <img src="./vanguard_logo.png" alt="Vanguard" style="height: 195px; margin-bottom: 10px;">
        <h2 id="refreshTitle" style="margin-top: 0; margin-bottom: 10px;">Refresh Data</h2>
        <p id="refreshMessage" style="margin-bottom: 15px;">Force download all data from server? This will replace your local cached data.</p>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
            <button onclick="confirmRefresh()" style="background: #3b82f6; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">Yes, Refresh</button>
            <button onclick="closeRefreshPopup()" style="background: #6b7280; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
        </div>
    </div>
    
    <!-- Success Popup -->
    <div class="welcome-overlay" id="successOverlay" style="display: none;"></div>
    <div class="welcome-popup" id="successPopup" style="display: none;">
        <img src="./vanguard_logo.png" alt="Vanguard" style="height: 195px; margin-bottom: 10px;">
        <h2 id="successTitle" style="margin-top: 0; margin-bottom: 10px;">Success!</h2>
        <p id="successMessage" style="margin-bottom: 15px;">Data refreshed successfully!</p>
        <button onclick="closeSuccessPopup()">Continue</button>
    </div>
    
    <!-- Error Popup -->
    <div class="welcome-overlay" id="errorOverlay" style="display: none;"></div>
    <div class="welcome-popup" id="errorPopup" style="display: none;">
        <img src="./vanguard_logo.png" alt="Vanguard" style="height: 195px; margin-bottom: 10px;">
        <h2 style="color: #dc2626; margin-top: 0; margin-bottom: 10px;">Error</h2>
        <p id="errorMessage" style="margin-bottom: 15px;">Failed to refresh data. Please try again.</p>
        <button onclick="closeErrorPopup()" style="background: #dc2626;">Close</button>
    </div>
    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="nav-brand">
            <img src="./vanguard_logo.png" alt="Vanguard" style="height: 65px; margin-right: 18px; vertical-align: middle;">
            <span style="vertical-align: middle; font-size: 22px; font-weight: 600;">Bingo Analytics</span>
            <span style="vertical-align: middle; font-size: 11px; color: #94a3b8; margin-left: 8px; font-weight: 400;">v1.1.1</span>
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchView('events')">Events</button>
                <!-- <button class="nav-tab" onclick="switchView('month-over-month')">Monthly</button> -->
                <button class="nav-tab" onclick="switchView('reporting')">Reporting</button>
                <button class="nav-tab" onclick="switchView('data')">Data</button>
            </div>
            <button id="installButton" onclick="installPWA()" style="display: none; padding: 6px 12px; background: #16a34a; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;" title="Install as app">📱 Install</button>
            <button onclick="forceDataRefresh()" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; margin-left: 10px;" title="Force refresh data from server">↻ Refresh</button>
        </div>
    </div>

    <!-- Events View - Updated 2025-08-17: Added event selection buttons and info tooltips -->
    <div id="events-view" class="view-container active">
        <!-- Main Visual Analytics View -->
        <div id="visual" class="container visual-analytics">
            <div class="event-header-clean">
                <!-- ROW 1: Event Buttons -->
                <div class="header-row-1">
                    <button class="event-btn" onclick="window.selectEvent('latest')" title="View the most recent event data">Loading...</button>
                    <button class="event-btn" onclick="window.selectEvent('second-latest')" title="Second most recent event">Loading...</button>
                    <button class="event-btn" onclick="window.selectEvent('third-latest')" title="Third most recent event">Loading...</button>
                    <button class="event-btn" onclick="window.selectEvent('fourth-latest')" title="Fourth most recent event">Loading...</button>
                    <div class="dropdown-container">
                        <button class="event-btn dropdown-trigger" onclick="toggleDropdown()" title="View older events">
                            Previous Events ▼
                        </button>
                        <div class="dropdown-menu" id="eventDropdown">
                            <!-- Dropdown items populated dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- ROW 2: Event Title & Metadata LEFT | Comparison Controls RIGHT -->
                <div class="header-row-2">
                    <!-- LEFT: Event Title and Metadata -->
                    <div class="event-info-section">
                        <div class="visual-event-title">Loading...</div>
                        <div class="visual-event-meta">
                            <span class="visual-meta-item">
                                <span class="icon">📅</span> <span class="meta-value">-</span>
                            </span>
                            <span class="visual-meta-item">
                                <span class="icon">🕐</span> <span class="meta-value">-</span>
                            </span>
                            <span class="visual-meta-item">
                                <span class="icon">📍</span> <span class="meta-value">-</span>
                            </span>
                        </div>
                    </div>
                    
                    <!-- RIGHT: Compare To Box -->
                    <div class="comparison-controls-box" id="compareToBox" style="position: relative;">
                        <div class="compare-label">
                            COMPARE TO LOCATION AND:
                        </div>
                        <span style="
                            position: absolute;
                            top: 8px;
                            right: 8px;
                            width: 18px;
                            height: 18px;
                            background: rgba(107, 114, 128, 0.1);
                            color: #6b7280;
                            border-radius: 50%;
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 11px;
                            font-style: italic;
                            cursor: help;
                            transition: all 0.2s;
                            border: 1px solid rgba(107, 114, 128, 0.2);
                        " 
                        onmouseover="
                            this.style.background='rgba(107, 114, 128, 0.2)';
                            var tooltip = this.querySelector('.tooltip-content');
                            if (tooltip) tooltip.style.display = 'block';
                        " 
                        onmouseout="
                            this.style.background='rgba(107, 114, 128, 0.1)';
                            var tooltip = this.querySelector('.tooltip-content');
                            if (tooltip) tooltip.style.display = 'none';
                        ">
                            i
                            <div class="tooltip-content" style="
                                display: none;
                                position: absolute;
                                top: 100%;
                                right: 0;
                                margin-top: 5px;
                                background: rgba(0, 0, 0, 0.9);
                                color: white;
                                padding: 12px 15px;
                                border-radius: 8px;
                                font-size: 11px;
                                font-style: normal;
                                font-weight: normal;
                                text-align: left;
                                white-space: pre-line;
                                line-height: 1.5;
                                z-index: 10000;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                                min-width: 320px;
                                max-width: 380px;
                            ">Compare To Box Elements:

Location Matching: Always matches events from the same location (SC or RWC). This is automatic and cannot be changed.

Time Period (1M/3M/1Y): Selects events from 1 month, 3 months, or 1 year ago to compare against. Creates your comparison pool from this historical timeframe.

Day Only: When checked, only compares to events on the exact same day of week and session type. For example, Monday events only compare to other Mondays, Late Saturday only compares to other Late Saturday sessions.

Hotball Filter: Matches events by their Hotball jackpot amount:
  • None: Includes all events regardless of Hotball
  • Category: Groups by similar Hotball ranges
  • 10%/20%: Only events within ±10% or ±20% of current Hotball amount

Pool: Shows the number of historical events that match all your selected filters. This is your comparison group.</div>
                        </span>
                        <div class="comparison-controls">
                            <div class="period-buttons">
                                <button data-period="1M" onclick="window.EventManager.setComparisonPeriod('1M')" title="Compare to events from 30-60 days ago">1M</button>
                                <button data-period="3M" onclick="window.EventManager.setComparisonPeriod('3M')" class="active" title="Compare to events from 30-120 days ago">3M</button>
                                <button data-period="1Y" onclick="window.EventManager.setComparisonPeriod('1Y')" title="Compare to events from 30-395 days ago">1Y</button>
                            </div>
                            
                            <div class="separator"></div>
                            
                            <label class="checkbox-label" title="Only compare to same day/session type">
                                <input type="checkbox" id="dayOnlyFilter" onchange="window.EventManager.setDayOnlyFilter(this.checked)">
                                <span>Day Only</span>
                            </label>
                            
                            <div class="separator"></div>
                            
                            <select id="hotballFilter" onchange="window.EventManager.setHotballFilter(this.value)" title="Filter by Hotball amount">
                                <option value="none">Hotball: None</option>
                                <option value="category">Category Match</option>
                                <option value="10%">10% Match</option>
                                <option value="20%">20% Match</option>
                            </select>
                            
                            <div class="separator"></div>
                            
                            <span class="pool-count">
                                Pool: <strong id="comparisonPoolCount">0</strong>
                            </span>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Spotlight Metrics -->
            <div class="spotlight-metrics">
                <div class="spotlight-card highlight expandable" data-metric="net-sales">
                    <div class="spotlight-label">Net Sales</div>
                    <div class="spotlight-value">-</div>
                    <div class="spotlight-change">-</div>
                    <div class="spotlight-expansion">
                        <div class="expansion-value">-</div>
                        <div class="expansion-count">-</div>
                    </div>
                </div>
                <div class="spotlight-card highlight expandable" data-metric="rpa">
                    <div class="spotlight-label">RPA</div>
                    <div class="spotlight-value">-</div>
                    <div class="spotlight-change">-</div>
                    <div class="spotlight-expansion">
                        <div class="expansion-value">-</div>
                        <div class="expansion-count">-</div>
                    </div>
                </div>
                <div class="spotlight-card expandable" data-metric="total-sales">
                    <div class="spotlight-label">Total Sales</div>
                    <div class="spotlight-value">-</div>
                    <div class="spotlight-change">-</div>
                    <div class="spotlight-expansion">
                        <div class="expansion-value">-</div>
                        <div class="expansion-count">-</div>
                    </div>
                </div>
                <div class="spotlight-card expandable" data-metric="payouts">
                    <div class="spotlight-label">Payouts</div>
                    <div class="spotlight-value">-</div>
                    <div class="spotlight-change">-</div>
                    <div class="spotlight-expansion">
                        <div class="expansion-value">-</div>
                        <div class="expansion-count">-</div>
                    </div>
                </div>
                <div class="spotlight-card expandable" data-metric="margin">
                    <div class="spotlight-label">Margin</div>
                    <div class="spotlight-value">-</div>
                    <div class="spotlight-change">-</div>
                    <div class="spotlight-expansion">
                        <div class="expansion-value">-</div>
                        <div class="expansion-count">-</div>
                    </div>
                </div>
                <div class="spotlight-card expandable" data-metric="attendance">
                    <div class="spotlight-label">Attendance</div>
                    <div class="spotlight-value">-</div>
                    <div class="spotlight-change">-</div>
                    <div class="spotlight-expansion">
                        <div class="expansion-value">-</div>
                        <div class="expansion-count">-</div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="visual-chart-section">
                <!-- Hotball Indicator - Updated 2025-08-17: Added Events since Hotball display -->
                <div class="hotball-indicator" style="display: flex; flex-direction: column; align-items: center; padding: 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 16px; border: 1px solid rgba(59, 130, 246, 0.15); margin-right: 20px;">
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px;">Hotball Status</div>
                    <div id="hotballCircle" class="hotball-circle" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(to top, #fbbf24 0%, #fbbf24 70%, #ffffff 70%, #ffffff 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 20px rgba(251, 191, 36, 0.4); position: relative; border: 2px solid #f59e0b;">
                        <span id="hotballValue" style="font-size: 24px; font-weight: 700; color: #1a202c;">$0</span>
                    </div>
                    <div id="hotballStatus" style="margin-top: 10px; font-size: 14px; font-weight: 700; color: #fbbf24; text-transform: uppercase;">LOADING</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #64748b;">Events since Hotball: <span id="eventsSinceHotball" style="font-weight: 600; color: #1e293b;">-</span></div>
                </div>
                
                <div class="chart-container" style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 12px 0; position: relative; z-index: 10; min-height: 40px;">
                        <div class="chart-title" style="white-space: nowrap; margin-right: 20px;">Charts</div>
                        <div style="display: flex; gap: 15px; align-items: center; flex-shrink: 0;">
                            <!-- Location Toggle Buttons -->
                            <div style="display: flex; gap: 4px; background: #f1f5f9; padding: 3px; border-radius: 6px;">
                                <button onclick="updateChartLocation('combined')" id="chart-loc-combined" style="padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; transition: all 0.2s;">Combined</button>
                                <button onclick="updateChartLocation('SC')" id="chart-loc-sc" style="padding: 5px 10px; background: transparent; color: #64748b; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; transition: all 0.2s;">SC</button>
                                <button onclick="updateChartLocation('RWC')" id="chart-loc-rwc" style="padding: 5px 10px; background: transparent; color: #64748b; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; transition: all 0.2s;">RWC</button>
                            </div>
                            <select id="chartTypeSelector" onchange="updateChartDisplay(this.value)" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; background: white; cursor: pointer;">
                                <option value="ytd">YTD Gross and Net Revenue</option>
                                <option value="12months">12 Months Revenue</option>
                            </select>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="dataLabelsToggle" checked onchange="toggleDataLabels(this.checked)" style="width: 16px; height: 16px; cursor: pointer;">
                                <span>Data Labels</span>
                            </label>
                        </div>
                    </div>
                    <div class="chart-placeholder" id="monthly-chart-container" style="position: relative; min-height: 300px;">
                        <!-- Chart will be dynamically created here -->
                    </div>
                </div>
                
                <!-- Revenue Distribution Donut Chart -->
                <div class="chart-container" style="max-width: 350px; overflow: hidden;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="chart-title">Revenue Distribution</div>
                        <select id="donutSelector" class="chart-selector" style="background: #ffffff; color: #374151; border: 1px solid #d1d5db;" onchange="switchDonutChart(this.value)">
                            <option value="revenue">Revenue</option>
                            <option value="payouts">Payouts</option>
                        </select>
                    </div>
                    <!-- Dynamic revenue donut container -->
                    <div class="revenue-donut" id="revenueDonut">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <!-- Dynamic payouts donut container -->
                    <div class="revenue-donut" id="payoutsDonut" style="display: none; position: relative;">
                        <!-- Will be populated dynamically -->
                                <div class="legend-item" style="font-size: 9px; margin: 2px;">
                                    <span class="legend-color" style="background: #ef4444; width: 8px; height: 8px;"></span>
                                    <span style="font-size: 9px;">Strip 30%</span>
                                </div>
                                <div class="legend-item" style="font-size: 9px; margin: 2px;">
                                    <span class="legend-color" style="background: #f59e0b; width: 8px; height: 8px;"></span>
                                    <span style="font-size: 9px;">Paper 15%</span>
                                </div>
                                <div class="legend-item" style="font-size: 9px; margin: 2px;">
                                    <span class="legend-color" style="background: #fbbf24; width: 8px; height: 8px;"></span>
                                    <span style="font-size: 9px;">Flash Pay 15%</span>
                                </div>
                                <div class="legend-item" style="font-size: 9px; margin: 2px;">
                                    <span class="legend-color" style="background: #84cc16; width: 8px; height: 8px;"></span>
                                    <span style="font-size: 9px;">Numbers 10%</span>
                                </div>
                                <div class="legend-item" style="font-size: 9px; margin: 2px;">
                                    <span class="legend-color" style="background: #22c55e; width: 8px; height: 8px;"></span>
                                    <span style="font-size: 9px;">Dbl Action 8%</span>
                                </div>
                                <div class="legend-item" style="font-size: 9px; margin: 2px;">
                                    <span class="legend-color" style="background: #10b981; width: 8px; height: 8px;"></span>
                                    <span style="font-size: 9px;">Winnem 6%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Per Attendee Metrics - REMOVED per user request -->
            <!-- <div class="chart-container" style="margin-bottom: 25px;">
                <div class="chart-title">Per Attendee Revenue Analysis</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">Flash/Attendee</div>
                        <div style="font-size: 24px; font-weight: 700; color: #60a5fa;">$264.66</div>
                        <div style="font-size: 12px; color: #34d399; margin-top: 5px;">↑ 7.7%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">Strip/Attendee</div>
                        <div style="font-size: 24px; font-weight: 700; color: #a78bfa;">$189.82</div>
                        <div style="font-size: 12px; color: #34d399; margin-top: 5px;">↑ 6.3%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">Total RPA</div>
                        <div style="font-size: 24px; font-weight: 700; color: #fbbf24;">$476.10</div>
                        <div style="font-size: 12px; color: #34d399; margin-top: 5px;">↑ 8.8%</div>
                    </div>
                </div>
            </div> -->

            <!-- Comparison Cards - REMOVED per user request -->
            <!-- <div class="comparison-cards">
                <div class="comp-card" style="position: relative;">
                    <div style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: help; border: 1px solid #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05);" title="Compare to the average of the last 4 similar events">
                        <span style="font-size: 11px; color: #475569; font-weight: 600;">i</span>
                    </div>
                    <div class="comp-card-title">Compare to Recent</div>
                    <div class="comp-metrics">
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Net Sales</span>
                            <span class="comp-metric-change arrow-up">↑ 13.2%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">RPA</span>
                            <span class="comp-metric-change arrow-up">↑ 8.8%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Total Sales</span>
                            <span class="comp-metric-change arrow-up">↑ 15.2%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Attendance</span>
                            <span class="comp-metric-change arrow-up">↑ 6.5%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Margin</span>
                            <span class="comp-metric-change arrow-down">↓ 0.5pp</span>
                        </div>
                    </div>
                </div>
                <div class="comp-card" style="position: relative;">
                    <div style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: help; border: 1px solid #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05);" title="Compare to 3-month rolling average performance">
                        <span style="font-size: 11px; color: #475569; font-weight: 600;">i</span>
                    </div>
                    <div class="comp-card-title">Compare to 3 months</div>
                    <div class="comp-metrics">
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Net Sales</span>
                            <span class="comp-metric-change arrow-up">↑ 18.6%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">RPA</span>
                            <span class="comp-metric-change arrow-up">↑ 12.0%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Total Sales</span>
                            <span class="comp-metric-change arrow-up">↑ 21.3%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Attendance</span>
                            <span class="comp-metric-change arrow-up">↑ 10.7%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Margin</span>
                            <span class="comp-metric-change arrow-down">↓ 0.6pp</span>
                        </div>
                    </div>
                </div>
                <div class="comp-card" style="position: relative;">
                    <div style="position: absolute; top: 8px; right: 8px; width: 18px; height: 18px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: help; border: 1px solid #cbd5e1; box-shadow: 0 1px 2px rgba(0,0,0,0.05);" title="Compare to 12-month rolling average performance">
                        <span style="font-size: 11px; color: #475569; font-weight: 600;">i</span>
                    </div>
                    <div class="comp-card-title">Compare to Year</div>
                    <div class="comp-metrics">
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Net Sales</span>
                            <span class="comp-metric-change arrow-up">↑ 25.9%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">RPA</span>
                            <span class="comp-metric-change arrow-up">↑ 16.1%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Total Sales</span>
                            <span class="comp-metric-change arrow-up">↑ 27.4%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Attendance</span>
                            <span class="comp-metric-change arrow-up">↑ 16.9%</span>
                        </div>
                        <div class="comp-metric-row">
                            <span class="comp-metric-label">Margin</span>
                            <span class="comp-metric-change arrow-down">↓ 0.3pp</span>
                        </div>
                    </div>
                </div>
            </div> -->
            
            <!-- Product Performance Boxes Section -->
            <div class="product-boxes-section" style="margin-top: 30px; padding: 0 20px;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 style="font-size: 18px; font-weight: 700; color: #1e293b;">Product Performance - <span id="productBoxEventInfo" style="font-size: 16px; font-weight: 500; color: #475569;">Loading...</span></h3>
                        <div style="font-size: 12px; color: #64748b;">Click boxes to expand details</div>
                    </div>
                    <div style="font-size: 13px; color: #64748b; display: flex; align-items: center; gap: 10px;">
                        <span>Compared to: <span id="productBoxComparisonInfo" style="font-weight: 500; color: #475569;">No comparison</span></span>
                        <button id="changeComparisonBtn" style="padding: 2px 8px; font-size: 11px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">Change</button>
                    </div>
                </div>
                
                <div class="product-boxes-container" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <!-- Flash Product Box -->
                    <div class="product-box expandable" data-product="flash" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #fbbf24; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; position: relative;">
                        <div class="product-header">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="font-size: 14px; font-weight: 600; color: #92400e;">FLASH</span>
                                <span style="font-size: 12px; color: #92400e; opacity: 0.9;" id="flashEventPercent">% of Event - 0%</span>
                            </div>
                            <div class="product-metrics">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #92400e;">Revenue</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px; font-weight: 600; color: #78350f;" id="flashRevenue">$0</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="flashRevenueChange">-</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #92400e;">Payouts</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px; font-weight: 600; color: #78350f;" id="flashPayouts">$0</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="flashPayoutsChange">-</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid rgba(251, 191, 36, 0.3); margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #92400e; font-weight: 600;">Net Revenue</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px; font-weight: 700; color: #78350f;" id="flashNet">$0</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="flashNetChange">-</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid rgba(251, 191, 36, 0.3);">
                                    <span style="font-size: 13px; color: #92400e;">Margin</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 18px; font-weight: 700; color: #78350f;" id="flashMargin">0%</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="flashMarginChange">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="product-expansion" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(251, 191, 36, 0.3);">
                            <div style="font-size: 12px; color: #92400e; margin-bottom: 10px; font-weight: 600;">Comparison Pool Average</div>
                            <div id="flashComparisonDetails" style="font-size: 11px; color: #78350f;">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Strip Product Box -->
                    <div class="product-box expandable" data-product="strip" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); border: 1px solid #ec4899; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; position: relative;">
                        <div class="product-header">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="font-size: 14px; font-weight: 600; color: #831843;">STRIP</span>
                                <span style="font-size: 12px; color: #831843; opacity: 0.9;" id="stripEventPercent">% of Event - 0%</span>
                            </div>
                            <div class="product-metrics">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #831843;">Revenue</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px; font-weight: 600; color: #701a75;" id="stripRevenue">$0</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="stripRevenueChange">-</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #831843;">Payouts</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px; font-weight: 600; color: #701a75;" id="stripPayouts">$0</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="stripPayoutsChange">-</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid rgba(236, 72, 153, 0.3); margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #831843; font-weight: 600;">Net Revenue</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px; font-weight: 700; color: #701a75;" id="stripNet">$0</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="stripNetChange">-</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid rgba(236, 72, 153, 0.3);">
                                    <span style="font-size: 13px; color: #831843;">Margin</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 18px; font-weight: 700; color: #701a75;" id="stripMargin">0%</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="stripMarginChange">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="product-expansion" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(236, 72, 153, 0.3);">
                            <div style="font-size: 12px; color: #831843; margin-bottom: 10px; font-weight: 600;">Comparison Pool Average</div>
                            <div id="stripComparisonDetails" style="font-size: 11px; color: #701a75;">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Other Product Box -->
                    <div class="product-box expandable" data-product="other" style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); border: 1px solid #6366f1; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; position: relative;">
                        <div class="product-header">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="font-size: 14px; font-weight: 600; color: #312e81;">OTHER</span>
                                <span style="font-size: 12px; color: #312e81; opacity: 0.9;" id="otherEventPercent">% of Event - 0%</span>
                            </div>
                            <div class="product-metrics">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #312e81;">Revenue</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px; font-weight: 600; color: #1e1b4b;" id="otherRevenue">$0</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="otherRevenueChange">-</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #312e81;">Payouts</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px; font-weight: 600; color: #1e1b4b;" id="otherPayouts">$0</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="otherPayoutsChange">-</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid rgba(99, 102, 241, 0.3); margin-bottom: 8px;">
                                    <span style="font-size: 13px; color: #312e81; font-weight: 600;">Net Revenue</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 16px; font-weight: 700; color: #1e1b4b;" id="otherNet">$0</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="otherNetChange">-</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid rgba(99, 102, 241, 0.3);">
                                    <span style="font-size: 13px; color: #312e81;">Margin</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 18px; font-weight: 700; color: #1e1b4b;" id="otherMargin">N/A</span>
                                        <span style="font-size: 11px; font-weight: 500;" id="otherMarginChange">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="product-expansion" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(99, 102, 241, 0.3);">
                            <div style="font-size: 12px; color: #312e81; margin-bottom: 10px; font-weight: 600;">Comparison Pool Average</div>
                            <div id="otherComparisonDetails" style="font-size: 11px; color: #1e1b4b;">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div><!-- End Events View -->


    <!-- Monthly View - Disabled -->
    <div id="month-over-month-view" style="display: none;"></div>
    
    <!-- Monthly View HTML removed - was causing rendering issues -->
    <!-- TODO: If Monthly view is needed later, recreate from scratch -->
    <!-- All Monthly view HTML has been removed -->
    <div id="reporting-view" class="view-container" style="display: none;">
        <div class="container" style="padding: 20px;">
            <!-- Header with Navigation in light mode -->
            <div style="background: #ffffff; border-radius: 16px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button onclick="scrollReportingMonths('left')" style="padding: 10px 15px; background: #f8fafc; color: #1e293b; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 20px; cursor: pointer; transition: all 0.2s;">
                        ←
                    </button>
                    
                    <h2 id="reportingTitle" style="font-size: 24px; font-weight: 700; color: #1e293b; margin-top: 25px; margin-bottom: 10px; padding-top: 10px;">Monthly Reporting Overview</h2>
                    
                    <button onclick="scrollReportingMonths('right')" style="padding: 10px 15px; background: #f8fafc; color: #1e293b; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 20px; cursor: pointer; transition: all 0.2s;">
                        →
                    </button>
                </div>
                
                <!-- View Toggle, Location Filter and Month Range -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <!-- View and Location Toggle Buttons -->
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <!-- View Mode Toggle -->
                        <div style="display: flex; gap: 4px; background: #f1f5f9; padding: 4px; border-radius: 8px;">
                            <button onclick="setReportingViewMode('monthly')" id="viewModeMonthly" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;">Monthly</button>
                            <button onclick="setReportingViewMode('quarterly')" id="viewModeQuarterly" style="padding: 8px 16px; background: transparent; color: #64748b; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;">Quarterly</button>
                        </div>
                        
                        <!-- Location Toggle -->
                        <div style="display: flex; gap: 4px; background: #f1f5f9; padding: 4px; border-radius: 8px;">
                            <button onclick="setReportingLocation('SC')" id="reportingLocSC" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;">SC</button>
                            <button onclick="setReportingLocation('RWC')" id="reportingLocRWC" style="padding: 8px 16px; background: transparent; color: #64748b; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;">RWC</button>
                            <button onclick="setReportingLocation('COMBINED')" id="reportingLocCombined" style="padding: 8px 16px; background: transparent; color: #64748b; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;">Combined</button>
                        </div>
                    </div>
                    
                    <!-- Month/Quarter Range Display - Hidden as redundant -->
                    <span id="reportingMonthRange" style="display: none;">Loading...</span>
                </div>
            </div>
            
            <!-- Scrollable Month Container -->
            <div style="position: relative; overflow: hidden;">
                <div id="reportingMonthsContainer" style="display: flex; gap: 25px; transition: transform 0.3s ease; width: max-content; padding: 0 10px;">
                    <!-- Months will be dynamically generated here -->
                </div>
            </div>
        </div>
    </div><!-- End Reporting View -->
    
    <!-- Data View - Exact Google Sheets Format -->
    <div id="data-view" class="view-container" style="display: none;">
        <div class="container" style="padding: 20px;">
            <div style="background: white; border: 1px solid #d1d5db; border-radius: 8px; padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 id="dataViewTitle" style="color: #1e293b; font-size: 18px; margin: 0;">Master Sheet View - SC Daily</h2>
                    <div style="display: flex; gap: 10px;">
                        <!-- Subview selector for Daily/Monthly/Data Test -->
                        <select id="dataSubviewFilter" onchange="updateDataSubview()" style="padding: 6px 10px; background: white; color: #1e293b; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px;">
                            <option value="daily">Daily</option>
                            <option value="monthly">Monthly</option>
                            <option value="datatest">Data Test</option>
                        </select>
                        <select id="dataLocationFilter" onchange="updateSheetsView()" style="padding: 6px 10px; background: white; color: #1e293b; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px;">
                            <option value="SC">SC</option>
                            <option value="RWC">RWC</option>
                        </select>
                        <button onclick="exportSheetsView()" style="padding: 6px 12px; background: #0f9d58; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Export to CSV</button>
                    </div>
                </div>
                
                <div style="overflow: auto; max-height: 75vh; border: 1px solid #e5e7eb;">
                    <table id="sheetsTable" style="border-collapse: collapse; font-family: Arial, sans-serif; font-size: 11px; background: white;">
                        <!-- Table will be populated by JavaScript -->
                    </table>
                </div>
            </div>
        </div>
    </div><!-- End Data View -->

    <script>
        // ============================================================
        // VANGUARD BINGO ANALYTICS - CODE ORGANIZATION MAP
        // ============================================================
        // MAJOR SECTIONS IN THIS FILE:
        // 
        // 1. DATA MODELS (Lines ~2569-2660)
        //    - BingoEvent class: Event data structure
        //    - Row mappings: Date(3), Day(4), HotballChange(35), HotballTotal(36)
        //
        // 2. EVENT MANAGER (Lines ~2665-3560) 
        //    - Main controller class for all event operations
        //    - Key methods: selectEvent(), updateHotballDisplay(), getEventsSince()
        //    - Handles comparisons, filtering, and UI updates
        //
        // 3. UI UPDATE FUNCTIONS (Lines ~3850-4300)
        //    - DUPLICATES TO REMOVE: updateHotballDisplay, updateEventMetrics, updateEventTitle
        //    - These are being replaced by EventManager methods
        //
        // 4. VIEW HANDLERS (Lines ~4000-5600)
        //    - switchView(): Tab switching logic
        //    - updateMonthlyView(): Monthly tab updates  
        //    - updateSheetsView(): Data tab updates
        //
        // 5. INITIALIZATION (Lines ~5700-5950)
        //    - Data loading from Google Sheets
        //    - EventManager initialization
        //    - UI population
        //
        // TECHNICAL DEBT NOTES:
        // - Multiple duplicate update functions (being removed)
        // - Mixed use of VanguardData and EventManager (standardizing on EventManager)
        // - Inconsistent event access patterns (fixing)
        // ============================================================
        
        // ============================================
        // EVENT SYSTEM ARCHITECTURE - COMPLETE REWRITE
        // ============================================
        
        // ============================================
        // TOOLTIP HELPER FUNCTIONS - Consistent tooltips across app
        // ============================================
        const TooltipHelpers = {
            // Create info icon with tooltip (grey circle with lowercase i)
            createInfoIcon: function(tooltipContent) {
                return `
                    <span style="
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        width: 18px;
                        height: 18px;
                        background: rgba(107, 114, 128, 0.1);
                        color: #6b7280;
                        border-radius: 50%;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                        font-style: italic;
                        cursor: help;
                        transition: all 0.2s;
                        border: 1px solid rgba(107, 114, 128, 0.2);
                    " 
                    onmouseover="
                        this.style.background='rgba(107, 114, 128, 0.2)';
                        var tooltip = this.querySelector('.tooltip-content');
                        if (tooltip) tooltip.style.display = 'block';
                    " 
                    onmouseout="
                        this.style.background='rgba(107, 114, 128, 0.1)';
                        var tooltip = this.querySelector('.tooltip-content');
                        if (tooltip) tooltip.style.display = 'none';
                    ">
                        i
                        <div class="tooltip-content" style="
                            display: none;
                            position: absolute;
                            top: 100%;
                            right: 0;
                            margin-top: 5px;
                            background: rgba(0, 0, 0, 0.9);
                            color: white;
                            padding: 12px 15px;
                            border-radius: 8px;
                            font-size: 11px;
                            font-style: normal;
                            font-weight: normal;
                            text-align: left;
                            white-space: pre-line;
                            line-height: 1.5;
                            z-index: 10000;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            min-width: 280px;
                            max-width: 380px;
                        ">${tooltipContent}</div>
                    </span>
                `;
            },
            
            // Create projection tooltip for metric boxes
            createMetricTooltip: function(tooltipContent) {
                return `
                    <div style="
                        position: absolute;
                        top: 0;
                        right: calc(100% + 10px);
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 10px 15px;
                        border-radius: 8px;
                        font-size: 11px;
                        white-space: pre-line;
                        line-height: 1.5;
                        z-index: 10000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        min-width: 250px;
                        max-width: 350px;
                        opacity: 0;
                        visibility: hidden;
                        transition: opacity 0.2s, visibility 0.2s;
                        pointer-events: none;
                    " 
                    onmouseover="this.style.opacity='1'; this.style.visibility='visible';"
                    onmouseout="this.style.opacity='0'; this.style.visibility='hidden';"
                    >${tooltipContent}</div>
                `;
            }
        };
        
        // Simple VanguardData stub to provide compatibility without external JS file
        window.VanguardData = {
            data: {
                sc: { columns: [], rows: {} },
                rwc: { columns: [], rows: {} },
                scMonthly: { columns: [], rows: {} },
                rwcMonthly: { columns: [], rows: {} }
            },
            
            // Row mappings from Google Sheets (from vanguard-data-integration.js)
            ROWS: {
                DATE_WITH_LATE: 3,
                DAY_OF_WEEK: 4,
                FLASH: 6,
                CHERRIES: 7,
                PAPER: 8,
                STRIPS: 9,
                MERCH: 10,
                TOTAL_SALES: 12,
                STRIP_PAYOUTS: 16,
                PAPER_PAYOUTS: 17,
                FLASH_PAYOUTS: 18,
                NUMBERS_PAYOUTS: 19,
                DOUBLE_ACTION: 20,
                WINNEMUCCA: 21,
                RWB: 22,
                COLOR: 23,
                FAST5: 24,
                WILD1: 25,
                BONANZA: 26,
                SUPER_PAYOUT: 27,
                TOTAL_PAYOUTS: 29,
                NET_SALES: 31,
                HOTBALL_CHANGE: 35,
                HOTBALL_TOTAL: 36,
                ATTENDANCE: 40
            },
            
            // Load data from localStorage cache if available
            loadFromCache() {
                try {
                    const cached = localStorage.getItem('vanguard_data_cache');
                    if (cached) {
                        const cacheData = JSON.parse(cached);
                        this.data = cacheData.data || this.data;
                        // Data loaded from cache
                        return true;
                    }
                } catch (e) {
                    console.error('Cache load error:', e);
                }
                return false;
            },
            
            // Get all events (compatibility method) - matches vanguard-data-integration.js structure
            getAllEvents() {
                const events = [];
                let skippedColumns = 0;
                let scProcessed = 0;
                let rwcProcessed = 0;
                
                // Get SC events (matching original JS logic)
                if (this.data?.sc?.columns) {
                    console.log('Processing SC columns:', this.data.sc.columns.length);
                    this.data.sc.columns.forEach(col => {
                        const dateHeader = col.header;
                        
                        // Skip average/total columns that don't represent actual events
                        if (dateHeader && (
                            dateHeader.toLowerCase().includes('average') || 
                            dateHeader.toLowerCase().includes('total') ||
                            dateHeader.toLowerCase().includes('avg') ||
                            dateHeader.toLowerCase().includes('sum')
                        )) {
                            skippedColumns++;
                            return; // Skip this column
                        }
                        
                        const row3Data = col.data?.row3;
                        const row4Data = col.data?.row4;
                        
                        const dateValue = row3Data?.value || row3Data;
                        let dayValue = row4Data?.value || row4Data;
                        
                        // Check if Late event
                        let isLate = dateHeader && (dateHeader.includes('Late') || dateHeader.includes('LATE') || dateHeader.includes('PM'));
                        
                        // Clean day value if it contains (Late)
                        let cleanDay = dayValue;
                        if (dayValue && typeof dayValue === 'string') {
                            if (dayValue.includes('Late') || dayValue.includes('LATE')) {
                                isLate = true;
                                cleanDay = dayValue.split('(')[0].trim();
                            }
                            // Normalize Saturday Late variations
                            if (cleanDay === 'Saturday' && isLate) {
                                // Force consistent format
                                dayValue = 'Saturday (Late)';
                            }
                        }
                        
                        // If no good day, derive from date
                        if (!cleanDay || cleanDay === 'Unknown' || cleanDay === '') {
                            if (dateValue) {
                                // Parse the date more carefully
                                let date;
                                if (typeof dateValue === 'string') {
                                    // Handle different date formats
                                    if (dateValue.includes('/')) {
                                        // MM/DD/YYYY format
                                        const parts = dateValue.split('/');
                                        if (parts.length === 3) {
                                            // new Date(year, monthIndex, day) - month is 0-based
                                            date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                                        }
                                    } else {
                                        date = new Date(dateValue);
                                    }
                                } else {
                                    date = new Date(dateValue);
                                }
                                
                                if (date && !isNaN(date.getTime())) {
                                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                                    const dayIndex = date.getDay();
                                    cleanDay = days[dayIndex];
                                    console.log(`${this.location || 'Location'}: Parsed '${dateValue}' -> ${date.toDateString()} -> ${cleanDay} (index: ${dayIndex})`);
                                } else {
                                    console.log(`${this.location || 'Location'}: Failed to parse date '${dateValue}'`);
                                }
                            }
                        }
                        
                        if (dateHeader) {
                            // For Late events, append (Late) to the day for display
                            const displayDay = isLate && cleanDay && cleanDay !== 'Unknown' 
                                ? `${cleanDay} (Late)` 
                                : cleanDay || 'Unknown';
                            
                            scProcessed++;
                            const scEvent = {
                                location: 'SC',
                                date: dateHeader,
                                dateValue: dateValue || dateHeader,
                                day: displayDay,
                                isLate: isLate,
                                columnIndex: col.index,
                                index: col.index,  // For compatibility
                                columnData: col.data
                            };
                            
                            // Log SC events with day issues
                            if (displayDay === 'Unknown' || !displayDay || displayDay.includes('undefined')) {
                                console.log('SC Event with day issue:', {
                                    header: dateHeader,
                                    dateValue: dateValue,
                                    row4: row4Data,
                                    derivedDay: cleanDay,
                                    displayDay: displayDay
                                });
                            }
                            
                            events.push(scEvent);
                        }
                    });
                    console.log(`SC: Processed ${scProcessed} events from ${this.data.sc.columns.length} columns (skipped ${skippedColumns})`);
                }
                
                // Get RWC events (same logic)
                let rwcSkipped = 0;
                if (this.data?.rwc?.columns) {
                    console.log('Processing RWC columns:', this.data.rwc.columns.length);
                    this.data.rwc.columns.forEach(col => {
                        const dateHeader = col.header;
                        
                        // Skip average/total columns that don't represent actual events
                        if (dateHeader && (
                            dateHeader.toLowerCase().includes('average') || 
                            dateHeader.toLowerCase().includes('total') ||
                            dateHeader.toLowerCase().includes('avg') ||
                            dateHeader.toLowerCase().includes('sum')
                        )) {
                            rwcSkipped++;
                            return; // Skip this column
                        }
                        
                        const row3Data = col.data?.row3;
                        const row4Data = col.data?.row4;
                        
                        const dateValue = row3Data?.value || row3Data;
                        let dayValue = row4Data?.value || row4Data;
                        
                        // Check if Late event
                        let isLate = dateHeader && (dateHeader.includes('Late') || dateHeader.includes('LATE') || dateHeader.includes('PM'));
                        
                        // Clean day value if it contains (Late)
                        let cleanDay = dayValue;
                        if (dayValue && typeof dayValue === 'string') {
                            if (dayValue.includes('Late') || dayValue.includes('LATE')) {
                                isLate = true;
                                cleanDay = dayValue.split('(')[0].trim();
                            }
                            // Normalize Saturday Late variations
                            if (cleanDay === 'Saturday' && isLate) {
                                // Force consistent format
                                dayValue = 'Saturday (Late)';
                            }
                        }
                        
                        // If no good day, derive from date
                        if (!cleanDay || cleanDay === 'Unknown' || cleanDay === '') {
                            if (dateValue) {
                                // Parse the date more carefully
                                let date;
                                if (typeof dateValue === 'string') {
                                    // Handle different date formats
                                    if (dateValue.includes('/')) {
                                        // MM/DD/YYYY format
                                        const parts = dateValue.split('/');
                                        if (parts.length === 3) {
                                            // new Date(year, monthIndex, day) - month is 0-based
                                            date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                                        }
                                    } else {
                                        date = new Date(dateValue);
                                    }
                                } else {
                                    date = new Date(dateValue);
                                }
                                
                                if (date && !isNaN(date.getTime())) {
                                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                                    const dayIndex = date.getDay();
                                    cleanDay = days[dayIndex];
                                    console.log(`${this.location || 'Location'}: Parsed '${dateValue}' -> ${date.toDateString()} -> ${cleanDay} (index: ${dayIndex})`);
                                } else {
                                    console.log(`${this.location || 'Location'}: Failed to parse date '${dateValue}'`);
                                }
                            }
                        }
                        
                        if (dateHeader) {
                            // For Late events, append (Late) to the day for display
                            const displayDay = isLate && cleanDay && cleanDay !== 'Unknown' 
                                ? `${cleanDay} (Late)` 
                                : cleanDay || 'Unknown';
                            
                            rwcProcessed++;
                            const rwcEvent = {
                                location: 'RWC',
                                date: dateHeader,
                                dateValue: dateValue || dateHeader,
                                day: displayDay,
                                isLate: isLate,
                                columnIndex: col.index,
                                index: col.index,  // For compatibility
                                columnData: col.data
                            };
                            
                            // Log RWC events with day issues
                            if (displayDay === 'Unknown' || !displayDay || displayDay.includes('undefined')) {
                                console.log('RWC Event with day issue:', {
                                    header: dateHeader,
                                    dateValue: dateValue,
                                    row4: row4Data,
                                    derivedDay: cleanDay,
                                    displayDay: displayDay
                                });
                            }
                            
                            events.push(rwcEvent);
                        }
                    });
                    console.log(`RWC: Processed ${rwcProcessed} events from ${this.data.rwc.columns.length} columns (skipped ${rwcSkipped})`);
                }
                
                // Sort by date (most recent first) - events might be in wrong order
                events.sort((a, b) => {
                    const dateA = new Date(a.dateValue);
                    const dateB = new Date(b.dateValue);
                    return dateB - dateA;
                });
                
                console.log(`TOTAL: Returning ${events.length} events (SC: ${events.filter(e => e.location === 'SC').length}, RWC: ${events.filter(e => e.location === 'RWC').length})`);
                
                // Log first few events to verify data structure
                if (events.length > 0) {
                    console.log('Sample events:', events.slice(0, 3).map(e => ({
                        location: e.location,
                        date: e.date,
                        dateValue: e.dateValue,
                        day: e.day,
                        hasData: !!e.columnData
                    })));
                }
                
                return events;
            },
            
            getEventValue(event, rowNum) {
                if (!event || !event.columnData) return 0;
                
                const rowKey = `row${rowNum}`;
                const value = event.columnData[rowKey]?.value;
                
                // Parse and return the value
                if (value !== null && value !== '' && value !== undefined) {
                    return parseFloat(value) || value;
                }
                
                // Handle calculated fields if empty (matching original logic)
                if (rowNum === 12) {
                    // Calculate Total Sales from components (rows 6-10)
                    const flash = parseFloat(event.columnData.row6?.value) || 0;
                    const cherries = parseFloat(event.columnData.row7?.value) || 0;
                    const paper = parseFloat(event.columnData.row8?.value) || 0;
                    const strips = parseFloat(event.columnData.row9?.value) || 0;
                    const merch = parseFloat(event.columnData.row10?.value) || 0;
                    return flash + cherries + paper + strips + merch;
                }
                
                if (rowNum === 29) {
                    // Calculate Total Payouts from components (rows 16-27)
                    let total = 0;
                    for (let i = 16; i <= 27; i++) {
                        const val = parseFloat(event.columnData[`row${i}`]?.value) || 0;
                        total += val;
                    }
                    return total;
                }
                
                if (rowNum === 31) {
                    // Calculate Net Sales (Total Sales - Total Payouts)
                    const totalSales = this.getEventValue(event, 12);
                    const totalPayouts = this.getEventValue(event, 29);
                    return totalSales - totalPayouts;
                }
                
                return 0;
            },
            
            getLatestEvent() {
                const events = this.getAllEvents();
                return events.length > 0 ? events[0] : null;
            },
            
            // Stub for updateDashboard (not used in v3)
            updateDashboard() {
                // Handled by EventManager
            },
            
            // Fetch data from Google Sheets API
            async fetchData() {
                const API_URL = 'https://script.google.com/macros/s/AKfycbzbmJqRgd4kpZFNrpnKH3I7md6fM8eOsOoukEc2Mp_rDzUQNkpJ7u5msmZ1zJweTKij/exec';
                
                return new Promise((resolve, reject) => {
                    try {
                        console.log('Fetching data from Google Sheets...');
                        
                        // Create unique callback name
                        const callbackName = 'jsonpCallback_' + Date.now();
                        
                        // Create callback function
                        window[callbackName] = (data) => {
                            // Clean up
                            delete window[callbackName];
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                            
                            // Check for errors
                            if (data && data.error) {
                                console.error('API error:', data);
                                reject(new Error(data.message || 'API error'));
                                return;
                            }
                            
                            // Save to cache
                            if (data) {
                                this.data = data;
                                const cacheData = {
                                    data: data,
                                    timestamp: Date.now()
                                };
                                localStorage.setItem('vanguard_data_cache', JSON.stringify(cacheData));
                                console.log('Data fetched and cached successfully');
                                
                                // Reload page to initialize with new data
                                location.reload();
                            }
                            
                            resolve(data);
                        };
                        
                        // Create script tag for JSONP
                        const script = document.createElement('script');
                        script.src = `${API_URL}?callback=${callbackName}`;
                        script.onerror = () => {
                            delete window[callbackName];
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                            reject(new Error('Failed to load data from Google Sheets'));
                        };
                        
                        // Add script to page
                        document.head.appendChild(script);
                        
                        // Timeout after 30 seconds
                        setTimeout(() => {
                            if (window[callbackName]) {
                                delete window[callbackName];
                                if (script.parentNode) {
                                    script.parentNode.removeChild(script);
                                }
                                reject(new Error('Request timeout'));
                            }
                        }, 30000);
                        
                    } catch (error) {
                        reject(error);
                    }
                });
            }
        };
        
        // ============================================================
        // SECTION: BINGO EVENT CLASS (DATA MODEL)
        // ============================================================
        // Event data structure - Maps spreadsheet rows to event properties
        // Key rows: 3=Date, 4=Day, 35=HotballChange, 36=HotballTotal
        class BingoEvent {
            constructor(location, columnIndex, columnData, rowData) {
                this.location = location;
                this.columnIndex = columnIndex;
                this.columnData = columnData;
                this.rowData = rowData;
                
                // Parse event properties from data
                // Clean date - remove any timestamp
                const rawDate = this.getRowValue(3);
                if (typeof rawDate === 'string') {
                    if (rawDate.includes('T')) {
                        // Handle ISO date format with timestamp (e.g., "2025-08-11T07:00:00.000Z")
                        const datePart = rawDate.split('T')[0];
                        // Convert from YYYY-MM-DD to MM/DD/YYYY
                        const [year, month, day] = datePart.split('-');
                        this.date = `${parseInt(month)}/${parseInt(day)}/${year}`;
                    } else if (rawDate.includes(' ')) {
                        // Handle date with time like "8/11/2025 8:00:00 AM"
                        this.date = rawDate.split(' ')[0];
                    } else {
                        this.date = rawDate;
                    }
                } else {
                    this.date = rawDate;
                }
                this.dayInfo = this.getRowValue(4) || '';
                
                // Parse day and Late status from row 4
                // Clean up the dayInfo - remove any parentheses and extra spaces
                const cleanDayInfo = String(this.dayInfo).replace(/\s*\([^)]*\)/g, '').trim();
                const dayParts = cleanDayInfo.split(/\s+/);
                let day = dayParts[0] || '';
                
                // Fix common typos and normalize day names
                const originalDay = day;
                const dayLower = day.toLowerCase();
                if (dayLower === 'tthursday' || dayLower === 'thhursday' || dayLower === 'thurday') {
                    day = 'Thursday';
                    console.log(`🔧 Fixed typo: "${originalDay}" -> "Thursday" for event on ${this.date} at ${location}`);
                } else if (dayLower === 'wednessday' || dayLower === 'wednsday') {
                    day = 'Wednesday';
                    console.log(`🔧 Fixed typo: "${originalDay}" -> "Wednesday" for event on ${this.date} at ${location}`);
                } else if (dayLower === 'tueday' || dayLower === 'tusday') {
                    day = 'Tuesday';
                    console.log(`🔧 Fixed typo: "${originalDay}" -> "Tuesday" for event on ${this.date} at ${location}`);
                }
                
                // Log if we still have the typo
                if (day.toLowerCase() === 'tthursday') {
                    console.error(`⚠️ TYPO NOT FIXED: Day is still "${day}" for event on ${this.date} at ${location}`);
                }
                
                this.day = day;
                this.isLate = this.dayInfo.includes('Late') || 
                             this.dayInfo.includes('LATE') || 
                             this.dayInfo.includes('PM');
                
                // Create unique ID
                const dateStr = String(this.date).replace(/\//g, '-').split('T')[0];
                this.id = `${this.location}-${dateStr}-${this.isLate ? 'L' : 'D'}`;
                
                // Cache commonly accessed metrics
                this.cacheMetrics();
            }
            
            getRowValue(rowNumber) {
                // Get value for specific row from this event's column
                if (this.columnData && this.columnData.data) {
                    const rowData = this.columnData.data[`row${rowNumber}`];
                    return rowData ? rowData.value : null;
                }
                return null;
            }
            
            cacheMetrics() {
                // Pre-calculate common metrics
                this.totalSales = parseFloat(this.getRowValue(12)) || 0;
                this.totalPayouts = parseFloat(this.getRowValue(29)) || 0;
                this.netSales = parseFloat(this.getRowValue(31)) || 0;
                this.attendance = parseFloat(this.getRowValue(40)) || 0;
                this.hotballTotal = parseFloat(this.getRowValue(36)) || 0;
                this.hotballChange = parseFloat(this.getRowValue(35)) || 0;
                
                // Debug: Check if netSales from spreadsheet matches calculated
                const calculatedNet = this.totalSales - this.totalPayouts;
                if (Math.abs(this.netSales - calculatedNet) > 1) {
                    console.warn('Net Sales mismatch:', {
                        event: this.id,
                        fromSpreadsheet: this.netSales,
                        calculated: calculatedNet,
                        totalSales: this.totalSales,
                        payouts: this.totalPayouts,
                        difference: this.netSales - calculatedNet
                    });
                }
                
                // Debug margin calculation
                console.log('Event margin calc:', {
                    event: this.id,
                    totalSales: this.totalSales,
                    payouts: this.totalPayouts,
                    netSales: this.netSales,
                    marginFromNet: (this.netSales / this.totalSales * 100).toFixed(2),
                    marginFromCalc: ((this.totalSales - this.totalPayouts) / this.totalSales * 100).toFixed(2)
                });
                
                // Calculated metrics
                this.margin = this.totalSales > 0 ? (this.netSales / this.totalSales * 100) : 0;
                this.rpa = this.attendance > 0 ? (this.totalSales / this.attendance) : 0;
                
                // Product sales
                this.flash = parseFloat(this.getRowValue(6)) || 0;
                this.cherries = parseFloat(this.getRowValue(7)) || 0;
                this.paper = parseFloat(this.getRowValue(8)) || 0;
                this.strips = parseFloat(this.getRowValue(9)) || 0;
            }
            
            getDisplayDate() {
                // Remove timestamp if present (e.g., "8/3/2025 8:00:00 AM" -> "8/3/2025")
                const dateStr = String(this.date).split(' ')[0];
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) {
                    // If date is invalid, try to extract from the date string
                    if (typeof this.date === 'string' && this.date.includes('/')) {
                        return this.date.split(' ')[0]; // Return the date part before any timestamp
                    }
                    return this.date || 'Unknown';
                }
                return `${d.getMonth() + 1}/${d.getDate()}`;
            }
            
            getDisplayName() {
                const locationLabel = this.location === 'SC' ? 'SC' : 'RWC';
                return `${locationLabel} - ${this.day} ${this.getDisplayDate()}${this.isLate ? ' Late' : ''}`;
            }
        }
        
        // ============================================================
        // SECTION: EVENT MANAGER CLASS (MAIN CONTROLLER)
        // ============================================================
        // Primary controller for events, comparisons, and UI updates
        // Methods: selectEvent(), updateHotballDisplay(), getEventsSince(), etc.
        class EventManager {
            constructor() {
                this.events = [];
                this.eventsById = {};
                this.eventsByLocation = { SC: [], RWC: [] };
                this.currentEvent = null;
            }
            
            loadFromVanguardData() {
                // CHECK IF ALREADY LOADED
                if (this.events.length > 0) {
                    // Events already loaded
                    return true;
                }
                
                if (!window.VanguardData || !window.VanguardData.data) {
                    console.error('VanguardData not available');
                    return false;
                }
                
                // Loading events from cache
                
                // Clear existing events
                this.events = [];
                this.eventsById = {};
                this.eventsByLocation = { SC: [], RWC: [] };
                
                // Load SC events - columns are in chronological order (oldest to newest)
                if (window.VanguardData.data.sc && window.VanguardData.data.sc.columns) {
                    const scColumns = [...window.VanguardData.data.sc.columns];
                    scColumns.forEach((column, index) => {
                        const event = new BingoEvent('SC', index, column, window.VanguardData.data.sc.rows);
                        this.addEvent(event);
                    });
                }
                
                // Load RWC events - columns are in chronological order (oldest to newest)
                if (window.VanguardData.data.rwc && window.VanguardData.data.rwc.columns) {
                    const rwcColumns = [...window.VanguardData.data.rwc.columns];
                    rwcColumns.forEach((column, index) => {
                        const event = new BingoEvent('RWC', index, column, window.VanguardData.data.rwc.rows);
                        this.addEvent(event);
                    });
                }
                
                // Sort events by date (OLDEST FIRST for consistency)
                this.events.sort((a, b) => {
                    // Parse dates properly - handle M/D/YYYY format
                    const parseDate = (dateStr) => {
                        if (!dateStr) return new Date(0);
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            // M/D/YYYY format
                            return new Date(parts[2], parts[0] - 1, parts[1]);
                        }
                        return new Date(dateStr);
                    };
                    return parseDate(a.date) - parseDate(b.date); // CHANGED: oldest first
                });
                
                // Log RWC day distribution
                if (this.rwcDayCount) {
                    console.log('RWC Events by Day:', this.rwcDayCount);
                    console.log(`Total RWC events: ${this.eventsByLocation.RWC.length}`);
                    
                    // Check for data issues
                    const thursdays = this.eventsByLocation.RWC.filter(e => e.day.toLowerCase().includes('thu'));
                    console.log(`RWC Thursday events: ${thursdays.length}`);
                    if (thursdays.length > 0) {
                        console.log('Sample Thursday events:', thursdays.slice(0, 5).map(e => ({
                            date: e.date,
                            day: e.day,
                            dayInfo: e.dayInfo
                        })));
                    }
                }
                
                // Events loaded successfully
                return true;
            }
            
            addEvent(event) {
                this.events.push(event);
                this.eventsById[event.id] = event;
                this.eventsByLocation[event.location].push(event);
                
                // Debug RWC day values
                if (event.location === 'RWC') {
                    if (!this.rwcDayCount) this.rwcDayCount = {};
                    const dayKey = event.day || 'Unknown';
                    this.rwcDayCount[dayKey] = (this.rwcDayCount[dayKey] || 0) + 1;
                    
                    // Log Thursday events specifically
                    if (dayKey.toLowerCase().includes('thu')) {
                        console.log('RWC Thursday found:', event.date, event.day, event.dayInfo);
                    }
                }
            }
            
            getLatestEvent() {
                // Latest is now the LAST element (newest)
                return this.events[this.events.length - 1] || null;
            }
            
            getEventById(id) {
                return this.eventsById[id] || null;
            }
            
            getEventByIndex(index) {
                return this.events[index] || null;
            }
            
            getEventsByLocation(location) {
                if (location === 'COMBINED' || location === 'ALL') {
                    return this.events;
                }
                return this.eventsByLocation[location] || [];
            }
            
            getEventsSince(event) {
                // Get count of events since last Hotball hit for this location
                // This counts BACKWARDS in time from the current event
                const locationEvents = [...this.getEventsByLocation(event.location)];
                
                // Events are already sorted oldest-first globally
                // No need to re-sort
                
                const eventIndex = locationEvents.findIndex(e => e.id === event.id);
                
                if (eventIndex < 0) return null;
                
                let count = 0;
                // Start from current event and count backwards in time
                // Since events are sorted oldest first: lower indices = older events
                // Don't count the current event itself - start from the previous one
                for (let i = eventIndex - 1; i >= 0; i--) {
                    const olderEvent = locationEvents[i];
                    // Check if this older event had a hotball hit (negative row 35)
                    if (olderEvent.hotballChange < 0) {
                        console.log(`Events since hotball for ${event.date}: ${count} (hit on ${olderEvent.date})`);
                        return count; // Found when hotball was last hit
                    }
                    count++;
                }
                
                console.log(`Events since hotball for ${event.date}: ${count}+ (never hit)`);
                return count; // Never hit in recorded history
            }
            
            // Filter methods for event selection
            filterByLocation(location) {
                if (location === 'ALL') {
                    return this.events;
                }
                return this.eventsByLocation[location] || [];
            }
            
            filterByDayType(events, dayType) {
                if (dayType === 'ALL') return events;
                
                return events.filter(event => {
                    switch(dayType) {
                        case 'MON': return event.day === 'Mon';
                        case 'TUE': return event.day === 'Tue';
                        case 'WED': return event.day === 'Wed';
                        case 'THU': return event.day === 'Thu';
                        case 'FRI': return event.day === 'Fri';
                        case 'SAT': return event.day === 'Sat';
                        case 'SUN': return event.day === 'Sun';
                        case 'WEEKDAY': return ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].includes(event.day);
                        case 'WEEKEND': return ['Sat', 'Sun'].includes(event.day);
                        default: return true;
                    }
                });
            }
            
            filterBySessionType(events, sessionType) {
                if (sessionType === 'ALL') return events;
                
                return events.filter(event => {
                    if (sessionType === 'REGULAR') return !event.isLate;
                    if (sessionType === 'LATE') return event.isLate;
                    return true;
                });
            }
            
            filterByDateRange(events, startDate, endDate) {
                if (!startDate && !endDate) return events;
                
                return events.filter(event => {
                    const eventDate = new Date(event.date);
                    if (startDate && eventDate < new Date(startDate)) return false;
                    if (endDate && eventDate > new Date(endDate)) return false;
                    return true;
                });
            }
            
            filterByPerformance(events, metric, threshold, comparison) {
                if (!metric || !threshold) return events;
                
                return events.filter(event => {
                    const value = event.getMetric(metric);
                    const thresholdValue = parseFloat(threshold);
                    
                    switch(comparison) {
                        case 'gt': return value > thresholdValue;
                        case 'gte': return value >= thresholdValue;
                        case 'lt': return value < thresholdValue;
                        case 'lte': return value <= thresholdValue;
                        case 'eq': return value === thresholdValue;
                        default: return true;
                    }
                });
            }
            
            applyFilters(filters = {}) {
                let filtered = this.events;
                
                // Apply location filter
                if (filters.location) {
                    filtered = this.filterByLocation(filters.location);
                }
                
                // Apply day type filter
                if (filters.dayType) {
                    filtered = this.filterByDayType(filtered, filters.dayType);
                }
                
                // Apply session type filter
                if (filters.sessionType) {
                    filtered = this.filterBySessionType(filtered, filters.sessionType);
                }
                
                // Apply date range filter
                if (filters.startDate || filters.endDate) {
                    filtered = this.filterByDateRange(filtered, filters.startDate, filters.endDate);
                }
                
                // Apply performance filter
                if (filters.performanceMetric) {
                    filtered = this.filterByPerformance(
                        filtered,
                        filters.performanceMetric,
                        filters.performanceThreshold,
                        filters.performanceComparison
                    );
                }
                
                return filtered;
            }
            
            selectEvent(eventIdentifier) {
                let event = null;
                
                if (eventIdentifier === 'latest') {
                    event = this.getLatestEvent();
                } else if (eventIdentifier === 'second-latest') {
                    // Get 2nd most recent event (events are now oldest-first, so count from end)
                    const len = this.events.length;
                    event = len > 1 ? this.events[len - 2] : null;
                } else if (eventIdentifier === 'third-latest') {
                    // Get 3rd most recent event
                    const len = this.events.length;
                    event = len > 2 ? this.events[len - 3] : null;
                } else if (eventIdentifier === 'fourth-latest') {
                    // Get 4th most recent event
                    const len = this.events.length;
                    event = len > 3 ? this.events[len - 4] : null;
                } else if (typeof eventIdentifier === 'number') {
                    event = this.getEventByIndex(eventIdentifier);
                } else if (typeof eventIdentifier === 'string') {
                    // Try as ID first
                    event = this.getEventById(eventIdentifier);
                    
                    // Try to match old button IDs to indices
                    if (!event) {
                        const buttonMap = {
                            'tuesday-17': 0,
                            'wednesday-16': 1,
                            'friday-14-late': 2,
                            'thursday-13': 3,
                            'wednesday-12-late': 4,
                            'tuesday-11': 5,
                            'monday-10': 6,
                            'sunday-9-late': 7,
                            'saturday-8': 8,
                            'friday-7-late': 9,
                            'thursday-6': 10,
                            'wednesday-5': 11,
                            'tuesday-4-late': 12,
                            'monday-3': 13,
                            'sunday-2': 14,
                            'saturday-1-late': 15
                        };
                        
                        if (buttonMap[eventIdentifier] !== undefined) {
                            event = this.getEventByIndex(buttonMap[eventIdentifier]);
                        }
                    }
                }
                
                if (event) {
                    this.currentEvent = event;
                    this.updateAllDisplays();
                    return event;
                }
                
                console.error('Event not found:', eventIdentifier);
                return null;
            }
            
            updateAllDisplays() {
                if (!this.currentEvent) {
                    return;
                }
                
                // Update all UI elements with current event data
                this.updateHotballDisplay();
                this.updateEventMetrics();
                this.updateEventTitle();
                this.updateRevenueDistribution();
                this.updatePayoutDistribution();
                this.updateLineChart();
                this.updateComparisons(); // Update comparisons when event changes
                
                // Update VanguardData if it has the method
                if (window.VanguardData && window.VanguardData.currentEvent) {
                    // Keep VanguardData in sync for other parts of the system
                    window.VanguardData.currentEvent = {
                        date: this.currentEvent.date,
                        location: this.currentEvent.location,
                        day: this.currentEvent.day,
                        isLate: this.currentEvent.isLate
                    };
                    
                    // VanguardData.updateDashboard() not needed - handled by EventManager
                }
            }
            
            updateHotballDisplay() {
                const event = this.currentEvent;
                if (!event) return;
                
                // Debug: Let's see what values we're getting
                console.log('=== HOTBALL DEBUG ===');
                console.log('Event:', event.id, event.getDisplayName());
                console.log('Row 35 (hotballChange):', event.hotballChange);
                console.log('Row 36 (hotballTotal):', event.hotballTotal);
                console.log('Raw Row 35:', event.getRowValue(35));
                console.log('Raw Row 36:', event.getRowValue(36));
                
                // Use Row 36 directly as the Hotball Total (no adjustments needed)
                let adjustedHotballTotal = event.hotballTotal;
                console.log('Hotball Total from row 36:', adjustedHotballTotal);
                
                // Update Hotball value with ADJUSTED total
                const hotballValueEl = document.getElementById('hotballValue');
                if (hotballValueEl) {
                    hotballValueEl.textContent = '$' + adjustedHotballTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }
                
                // Determine color and fill based on ADJUSTED value
                const hotballCircle = document.getElementById('hotballCircle');
                const hotballStatus = document.getElementById('hotballStatus');
                
                let fillPercent = 0;
                let gradientColor = '';
                let borderColor = '';
                let statusText = '';
                let glowColor = '';
                
                if (adjustedHotballTotal < 5000) {
                    // Green: Under $5,000
                    // Fill percentage relative to the green range (0-5000)
                    fillPercent = (adjustedHotballTotal / 5000) * 100;
                    gradientColor = '#22c55e';
                    borderColor = '#16a34a';
                    statusText = 'LOW';
                    glowColor = 'rgba(34, 197, 94, 0.4)';
                } else if (adjustedHotballTotal < 10000) {
                    // Yellow: $5,000 - $9,999
                    // Fill percentage relative to the yellow range (5000-10000)
                    fillPercent = ((adjustedHotballTotal - 5000) / 5000) * 100;
                    gradientColor = '#fbbf24';
                    borderColor = '#f59e0b';
                    statusText = 'MEDIUM';
                    glowColor = 'rgba(251, 191, 36, 0.4)';
                } else {
                    // Red: $10,000+
                    // Always completely full for red
                    fillPercent = 100;
                    gradientColor = '#ef4444';
                    borderColor = '#dc2626';
                    statusText = 'HIGH';
                    glowColor = 'rgba(239, 68, 68, 0.6)';
                }
                
                // Apply styles
                if (hotballCircle) {
                    fillPercent = Math.min(100, Math.max(0, fillPercent));
                    hotballCircle.style.background = `linear-gradient(to top, ${gradientColor} 0%, ${gradientColor} ${fillPercent}%, #ffffff ${fillPercent}%, #ffffff 100%)`;
                    hotballCircle.style.border = `2px solid ${borderColor}`;
                    hotballCircle.style.boxShadow = `0 5px 20px ${glowColor}`;
                    hotballCircle.style.animation = adjustedHotballTotal >= 10000 ? 'pulse 1.5s ease-in-out infinite' : '';
                }
                
                if (hotballStatus) {
                    hotballStatus.textContent = statusText;
                    hotballStatus.style.color = gradientColor;
                }
                
                // Update Events since Hotball
                const eventsSince = this.getEventsSince(event);
                const eventsSinceEl = document.getElementById('eventsSinceHotball');
                if (eventsSinceEl) {
                    if (eventsSince === null) {
                        eventsSinceEl.textContent = 'N/A';
                    } else {
                        eventsSinceEl.textContent = eventsSince;
                    }
                }
            }
            
            updateEventMetrics() {
                const event = this.currentEvent;
                if (!event) return;
                
                // Update event title and metadata
                const titleEl = document.querySelector('.visual-event-title');
                if (titleEl) {
                    titleEl.textContent = event.getDisplayName();
                }
                
                const metaEls = document.querySelectorAll('.visual-meta-item .meta-value');
                if (metaEls.length >= 3) {
                    // Format the date properly
                    const dateStr = event.getDisplayDate ? event.getDisplayDate() : event.date;
                    metaEls[0].textContent = dateStr;
                    metaEls[1].textContent = event.isLate ? 'Late Session' : 'Regular Session';
                    metaEls[2].textContent = event.location === 'SC' ? 'Santa Clara' : 'Redwood City';
                }
                
                // Update spotlight metrics
                const cards = document.querySelectorAll('.spotlight-card');
                cards.forEach(card => {
                    const label = card.querySelector('.spotlight-label')?.textContent;
                    const valueEl = card.querySelector('.spotlight-value');
                    
                    if (!label || !valueEl) return;
                    
                    switch(label) {
                        case 'Net Sales':
                            valueEl.textContent = '$' + event.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                            break;
                        case 'Total Sales':
                            valueEl.textContent = '$' + event.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                            break;
                        case 'Payouts':
                            valueEl.textContent = '$' + event.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                            break;
                        case 'Margin':
                            valueEl.textContent = event.margin.toFixed(1) + '%';
                            break;
                        case 'RPA':
                            valueEl.textContent = '$' + event.rpa.toFixed(0);
                            break;
                        case 'Attendance':
                            // Calculate percentage based on max attendance
                            const maxAttendance = event.location === 'SC' ? 430 : 200;
                            const attendancePercent = (event.attendance / maxAttendance * 100).toFixed(0);
                            valueEl.textContent = `${attendancePercent}%/${event.attendance.toFixed(0)}`;
                            break;
                    }
                });
                
                // Product boxes will be updated by updateComparisons() which runs after this
            }
            
            updateEventTitle() {
                // Update any title displays
                const event = this.currentEvent;
                if (!event) return;
                
                console.log('Current event:', event.id, event.getDisplayName());
            }
            
            updateRevenueDistribution() {
                console.log('=== updateRevenueDistribution called ===');
                const event = this.currentEvent;
                if (!event) {
                    console.log('No current event!');
                    return;
                }
                
                // Get paper sales data
                const flash = event.flash || 0;
                const strips = event.strips || 0;
                const cherries = event.cherries || 0;
                const paper = event.paper || 0;
                const other = cherries + paper;
                
                // console.log('Revenue data:', { flash, strips, cherries, paper, other });
                
                const total = flash + strips + other;
                if (total <= 0) {
                    console.log('Total is 0 or negative:', total);
                    return;
                }
                
                // Calculate percentages
                const flashPercent = (flash / total) * 100;
                const stripsPercent = (strips / total) * 100;
                const otherPercent = (other / total) * 100;
                
                // console.log('Percentages:', { flashPercent, stripsPercent, otherPercent });
                
                // Clear and rebuild the entire revenue donut
                const revenueContainer = document.getElementById('revenueDonut');
                console.log('Revenue container found:', !!revenueContainer);
                console.log('Revenue container element:', revenueContainer);
                if (!revenueContainer) {
                    console.error('Revenue container NOT FOUND!');
                    return;
                }
                
                console.log('Container innerHTML before update:', revenueContainer.innerHTML.substring(0, 100));
                console.log('About to update with values:', { flash, strips, other, total });
                
                const flashDeg = flashPercent * 3.6;
                const stripsDeg = stripsPercent * 3.6;
                
                revenueContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: -20px; padding: 0 5px;">
                        <div class="donut-chart" style="background: conic-gradient(
                            #60a5fa 0deg ${flashDeg}deg,
                            #fbbf24 ${flashDeg}deg ${flashDeg + stripsDeg}deg,
                            #34d399 ${flashDeg + stripsDeg}deg 360deg
                        ); flex-shrink: 0; width: 160px; height: 160px;">
                            <div class="donut-center">
                                <div class="donut-total" style="font-size: 22px;">$${(total / 1000).toFixed(1)}K</div>
                                <div class="donut-label" style="font-size: 10px;">Total Sales</div>
                            </div>
                        </div>
                        <div class="revenue-legend" style="position: static; transform: none; bottom: auto; left: auto; flex-direction: column; gap: 5px; font-size: 10px; flex: 1; min-width: 0;">
                            <div class="legend-item" style="font-size: 11px; margin: 3px;">
                                <span class="legend-color" style="background: #60a5fa; width: 10px; height: 10px;"></span>
                                <span style="font-size: 11px;">Flash ${flashPercent.toFixed(1)}%</span>
                            </div>
                            <div class="legend-item" style="font-size: 11px; margin: 3px;">
                                <span class="legend-color" style="background: #fbbf24; width: 10px; height: 10px;"></span>
                                <span style="font-size: 11px;">Strips ${stripsPercent.toFixed(1)}%</span>
                            </div>
                            <div class="legend-item" style="font-size: 11px; margin: 3px;">
                                <span class="legend-color" style="background: #34d399; width: 10px; height: 10px;"></span>
                                <span style="font-size: 11px;">Other ${otherPercent.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                `;
                console.log('Container innerHTML after update:', revenueContainer.innerHTML.substring(0, 100));
                
                // Set a flag to detect if it gets overwritten
                revenueContainer.setAttribute('data-updated-by', 'EventManager');
                
                // Check if it gets overwritten after a delay
                setTimeout(() => {
                    const stillThere = document.getElementById('revenueDonut');
                    console.log('After 100ms, container still has our update?:', 
                               stillThere?.getAttribute('data-updated-by') === 'EventManager');
                    console.log('After 100ms, innerHTML:', stillThere?.innerHTML.substring(0, 100));
                }, 100);
            }
            
            updatePayoutDistribution() {
                const event = this.currentEvent;
                if (!event) return;
                
                // Get payout values from correct rows:
                // Row 16: Strip Payouts
                // Row 27 + Row 18: Flash Payouts (combined)
                // Row 29 - Row 16 - Row 27 - Row 18: Other Payouts
                
                const stripPayouts = parseFloat(event.getRowValue(16)) || 0;
                const flashPayouts = (parseFloat(event.getRowValue(27)) || 0) + (parseFloat(event.getRowValue(18)) || 0);
                const totalPayouts = parseFloat(event.getRowValue(29)) || 0;
                const otherPayouts = totalPayouts - stripPayouts - flashPayouts;
                
                // Use similar colors to Revenue chart for consistency
                const colors = ['#fbbf24', '#60a5fa', '#34d399']; // Strip (yellow), Flash (blue), Other (green)
                
                const payouts = [];
                if (stripPayouts > 0) {
                    payouts.push({
                        value: stripPayouts,
                        name: 'Strip',
                        color: colors[0]
                    });
                }
                if (flashPayouts > 0) {
                    payouts.push({
                        value: flashPayouts,
                        name: 'Flash',
                        color: colors[1]
                    });
                }
                if (otherPayouts > 0) {
                    payouts.push({
                        value: otherPayouts,
                        name: 'Other',
                        color: colors[2]
                    });
                }
                
                const total = payouts.reduce((sum, p) => sum + p.value, 0);
                if (total <= 0) return;
                
                // Clear and rebuild the entire payouts donut
                const payoutsContainer = document.getElementById('payoutsDonut');
                if (!payoutsContainer) return;
                
                // Build gradient string
                let gradientStr = '';
                let currentDeg = 0;
                let legendHTML = '';
                
                payouts.forEach((payout, i) => {
                    const percent = (payout.value / total) * 100;
                    const degrees = percent * 3.6;
                    
                    if (i === 0) {
                        gradientStr = `${payout.color} 0deg ${degrees}deg`;
                    } else {
                        gradientStr += `, ${payout.color} ${currentDeg}deg ${currentDeg + degrees}deg`;
                    }
                    currentDeg += degrees;
                    
                    // Add to legend
                    legendHTML += `
                        <div class="legend-item" style="font-size: 11px; margin: 3px;">
                            <span class="legend-color" style="background: ${payout.color}; width: 10px; height: 10px;"></span>
                            <span style="font-size: 11px;">${payout.name} ${percent.toFixed(1)}%</span>
                        </div>
                    `;
                });
                
                payoutsContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: -20px; padding: 0 5px;">
                        <div class="donut-chart" style="background: conic-gradient(${gradientStr}); flex-shrink: 0; width: 160px; height: 160px;">
                            <div class="donut-center">
                                <div class="donut-total" style="font-size: 22px;">$${(total / 1000).toFixed(1)}K</div>
                                <div class="donut-label" style="font-size: 10px;">Total Payouts</div>
                            </div>
                        </div>
                        <div class="revenue-legend" style="position: static; transform: none; bottom: auto; left: auto; flex-direction: column; gap: 5px; font-size: 10px; flex: 1; min-width: 0;">
                            ${legendHTML}
                        </div>
                    </div>
                `;
            }
            
            updateLineChart() {
                // DISABLED - This was interfering with the monthly revenue chart
                return;
                
                const event = this.currentEvent;
                if (!event) return;
                
                // Get last 7 events for trend
                const allEvents = this.getEventsByLocation(event.location);
                const eventIndex = allEvents.findIndex(e => e.id === event.id);
                const startIndex = Math.max(0, eventIndex - 6);
                const trendEvents = allEvents.slice(startIndex, eventIndex + 1);
                
                // Update line chart SVG
                const svgLine = document.querySelector('.data-line');
                if (svgLine && trendEvents.length > 1) {
                    const points = trendEvents.map((e, i) => {
                        const revenue = e.getMetric('Revenue');
                        const maxRevenue = Math.max(...trendEvents.map(ev => ev.getMetric('Revenue')));
                        const minRevenue = Math.min(...trendEvents.map(ev => ev.getMetric('Revenue')));
                        const range = maxRevenue - minRevenue || 1;
                        
                        const x = 60 + (i * (780 / (trendEvents.length - 1)));
                        const y = 240 - ((revenue - minRevenue) / range * 180);
                        
                        return `${x},${y}`;
                    });
                    
                    svgLine.setAttribute('points', points.join(' '));
                }
                
                // Update x-axis labels
                const xLabels = document.querySelectorAll('.x-label');
                trendEvents.forEach((e, i) => {
                    if (xLabels[i]) {
                        const date = e.date.split('T')[0];
                        const parts = date.split('-');
                        xLabels[i].textContent = `${parts[1]}/${parts[2]}`;
                    }
                });
            }
            
            // COMPARISON SYSTEM METHODS
            setComparisonPeriod(period) {
                this.comparisonPeriod = period; // '1M', '3M', '1Y'
                
                // Update button active states
                const buttons = document.querySelectorAll('[data-period]');
                buttons.forEach(btn => {
                    if (btn.dataset.period === period) {
                        btn.style.background = '#3b82f6';
                        btn.style.color = 'white';
                        btn.style.borderColor = '#3b82f6';
                        btn.classList.add('active');
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = '#1e293b';
                        btn.style.borderColor = '#cbd5e1';
                        btn.classList.remove('active');
                    }
                });
                
                this.updateComparisons();
            }
            
            setDayOnlyFilter(enabled) {
                this.dayOnlyFilter = enabled;
                this.updateComparisons();
            }
            
            setHotballFilter(filter) {
                this.hotballFilter = filter; // 'none', 'category', '10%', '20%'
                this.updateComparisons();
            }
            
            getComparisonPool() {
                if (!this.currentEvent) return [];
                
                // Parse date properly from MM/DD/YYYY format
                const parseDate = (dateStr) => {
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        // MM/DD/YYYY format
                        return new Date(parts[2], parts[0] - 1, parts[1]);
                    }
                    return new Date(dateStr);
                };
                
                const currentDate = parseDate(this.currentEvent.date);
                let startDate = new Date(currentDate);
                
                // Set start date based on comparison period
                switch(this.comparisonPeriod) {
                    case '1M':
                        startDate.setDate(startDate.getDate() - 30);
                        break;
                    case '3M':
                        startDate.setDate(startDate.getDate() - 90);
                        break;
                    case '1Y':
                        startDate.setDate(startDate.getDate() - 365);
                        break;
                    default:
                        startDate.setDate(startDate.getDate() - 90); // Default to 3M
                }
                
                // Filter events by location (ALWAYS filter by location)
                let pool = this.eventsByLocation[this.currentEvent.location] || [];
                console.log(`Starting pool: ${pool.length} ${this.currentEvent.location} events total`);
                console.log(`Date range: ${startDate.toLocaleDateString()} to ${currentDate.toLocaleDateString()}`);
                
                // Filter by date range
                pool = pool.filter(event => {
                    const eventDate = parseDate(event.date);
                    const inRange = eventDate >= startDate && eventDate < currentDate && event.id !== this.currentEvent.id;
                    return inRange;
                });
                console.log(`After date filter: ${pool.length} events in ${this.comparisonPeriod} range`);
                
                // Apply Day Only filter if enabled
                if (this.dayOnlyFilter) {
                    console.log('=== DAY ONLY FILTER DEBUG ===');
                    console.log('Current Event:', {
                        day: this.currentEvent.day,
                        isLate: this.currentEvent.isLate,
                        location: this.currentEvent.location
                    });
                    
                    // Count events by day BEFORE filtering
                    const dayCount = {};
                    pool.forEach(e => {
                        const day = e.day || 'Unknown';
                        dayCount[day] = (dayCount[day] || 0) + 1;
                    });
                    console.log('Pool events by day BEFORE filter:', dayCount);
                    console.log(`Total in pool: ${pool.length}`);
                    
                    pool = pool.filter(event => {
                        // Normalize day strings for comparison
                        let currentDay = (this.currentEvent.day || '').toLowerCase().replace(/[^a-z]/g, '');
                        let eventDay = (event.day || '').toLowerCase().replace(/[^a-z]/g, '');
                        
                        // Extract just the day name without (Late) suffix BEFORE fixing typos
                        let currentDayBase = currentDay.replace('late', '').trim();
                        let eventDayBase = eventDay.replace('late', '').trim();
                        
                        // Fix common typos in comparison
                        if (currentDayBase === 'tthursday') currentDayBase = 'thursday';
                        if (eventDayBase === 'tthursday') eventDayBase = 'thursday';
                        
                        const matches = currentDayBase === eventDayBase && 
                                      event.isLate === this.currentEvent.isLate;
                        
                        if (event.location === 'RWC' && !matches) {
                            console.log('RWC Event filtered out:', {
                                eventDay: event.day,
                                eventDayNorm: eventDayBase,
                                currentDayNorm: currentDayBase,
                                isLate: event.isLate,
                                date: event.date
                            });
                        }
                        
                        return matches;
                    });
                }
                
                // Apply Hotball filter
                if (this.hotballFilter && this.hotballFilter !== 'none') {
                    const currentHotball = this.currentEvent.hotballTotal + 
                        (this.currentEvent.hotballChange < 0 ? Math.abs(this.currentEvent.hotballChange) : 0);
                    
                    pool = pool.filter(event => {
                        const eventHotball = event.hotballTotal + 
                            (event.hotballChange < 0 ? Math.abs(event.hotballChange) : 0);
                        
                        switch(this.hotballFilter) {
                            case 'category':
                                // Same color category (green/yellow/red)
                                const currentCategory = currentHotball < 5000 ? 'green' : 
                                                       currentHotball < 10000 ? 'yellow' : 'red';
                                const eventCategory = eventHotball < 5000 ? 'green' : 
                                                     eventHotball < 10000 ? 'yellow' : 'red';
                                return currentCategory === eventCategory;
                            case '10%':
                                // Within 10% of current hotball
                                const diff10 = Math.abs(eventHotball - currentHotball);
                                return diff10 <= currentHotball * 0.1;
                            case '20%':
                                // Within 20% of current hotball
                                const diff20 = Math.abs(eventHotball - currentHotball);
                                return diff20 <= currentHotball * 0.2;
                            default:
                                return true;
                        }
                    });
                }
                
                return pool;
            }
            
            updateComparisons() {
                const pool = this.getComparisonPool();
                
                // Store the comparison pool for use by product boxes
                this.comparisonEvents = pool;
                console.log('[DEBUG] Updated comparison pool with', pool.length, 'events');
                
                // Update pool counter
                const poolCounter = document.getElementById('comparisonPoolCount');
                if (poolCounter) {
                    poolCounter.textContent = pool.length;
                }
                
                // Removed total events counter - we only show pool count
                
                // If no comparison events, show N/A
                if (pool.length === 0) {
                    this.clearComparisons();
                    // Update product boxes even with empty pool
                    if (document.getElementById('events-view').style.display !== 'none' && this.currentEvent) {
                        updateProductBoxes(this.currentEvent, []);
                    }
                    return;
                }
                
                // Calculate averages from pool
                const totals = {
                    netSales: pool.reduce((sum, e) => sum + e.netSales, 0),
                    totalSales: pool.reduce((sum, e) => sum + e.totalSales, 0),
                    totalPayouts: pool.reduce((sum, e) => sum + e.totalPayouts, 0),
                    attendance: pool.reduce((sum, e) => sum + e.attendance, 0)
                };
                
                const averages = {
                    netSales: totals.netSales / pool.length,
                    totalSales: totals.totalSales / pool.length,
                    totalPayouts: totals.totalPayouts / pool.length,
                    margin: 0, // Will recalculate below
                    rpa: 0, // Will recalculate below
                    attendance: totals.attendance / pool.length
                };
                
                // Calculate margin from TOTALS not averages
                const totalMargin = totals.totalSales > 0 ? 
                    ((totals.totalSales - totals.totalPayouts) / totals.totalSales * 100) : 0;
                    
                // Debug the calculation
                console.log('Margin Calculation:', {
                    currentEvent: this.currentEvent.id,
                    poolSize: pool.length,
                    totalSales: totals.totalSales,
                    totalPayouts: totals.totalPayouts,
                    netFromTotals: totals.totalSales - totals.totalPayouts,
                    marginFromTotals: totalMargin,
                    avgMarginMethod: averages.totalSales > 0 ? 
                        ((averages.totalSales - averages.totalPayouts) / averages.totalSales * 100) : 0
                });
                
                // Use the margin calculated from totals
                averages.margin = totalMargin;
                averages.rpa = averages.attendance > 0 ? 
                    (averages.totalSales / averages.attendance) : 0;
                
                // Update spotlight cards with comparisons
                const cards = document.querySelectorAll('.spotlight-card');
                cards.forEach(card => {
                    const label = card.querySelector('.spotlight-label')?.textContent;
                    const changeEl = card.querySelector('.spotlight-change');
                    
                    if (!label || !changeEl || !this.currentEvent) return;
                    
                    let currentValue, avgValue, percentChange;
                    
                    switch(label) {
                        case 'Net Sales':
                            currentValue = this.currentEvent.netSales;
                            avgValue = averages.netSales;
                            break;
                        case 'Total Sales':
                            currentValue = this.currentEvent.totalSales;
                            avgValue = averages.totalSales;
                            break;
                        case 'Payouts':
                            currentValue = this.currentEvent.totalPayouts;
                            avgValue = averages.totalPayouts;
                            break;
                        case 'Margin':
                            currentValue = this.currentEvent.margin;
                            avgValue = averages.margin;
                            break;
                        case 'RPA':
                            currentValue = this.currentEvent.rpa;
                            avgValue = averages.rpa;
                            break;
                        case 'Attendance':
                            currentValue = this.currentEvent.attendance;
                            avgValue = averages.attendance;
                            break;
                    }
                    
                    if (currentValue !== undefined && avgValue !== undefined) {
                        percentChange = ((currentValue - avgValue) / avgValue) * 100;
                        
                        // Debug margin specifically
                        if (label === 'Margin') {
                            console.log('Margin Comparison Debug:', {
                                currentEvent: this.currentEvent.id,
                                currentMargin: currentValue,
                                avgMargin: avgValue,
                                percentChange: percentChange,
                                calculation: `(${currentValue} - ${avgValue}) / ${avgValue} * 100 = ${percentChange}`
                            });
                        }
                        
                        // Update change display
                        const arrow = percentChange >= 0 ? '↑' : '↓';
                        let color;
                        
                        // Payouts are neutral - neither good nor bad
                        if (label === 'Payouts') {
                            color = '#64748b'; // Neutral gray color
                        } else {
                            color = percentChange >= 0 ? '#22c55e' : '#ef4444';
                        }
                        
                        // For Margin, show both percentage change and pp difference
                        if (label === 'Margin') {
                            const ppDiff = (currentValue - avgValue).toFixed(1);
                            const ppSign = currentValue >= avgValue ? '+' : '';
                            // Make container position relative for absolute positioning
                            card.style.position = 'relative';
                            changeEl.innerHTML = `${arrow} ${Math.abs(percentChange).toFixed(1)}%`;
                            
                            // Add pp indicator in upper right of card
                            const ppIndicator = document.createElement('span');
                            ppIndicator.style.cssText = `
                                position: absolute;
                                top: 8px;
                                right: 12px;
                                font-size: 11px;
                                font-weight: 600;
                                color: ${color}CC;
                            `;
                            ppIndicator.textContent = `${ppSign}${ppDiff}pp`;
                            
                            // Remove any existing pp indicator
                            const existingPp = card.querySelector('.pp-indicator');
                            if (existingPp) existingPp.remove();
                            
                            ppIndicator.className = 'pp-indicator';
                            card.appendChild(ppIndicator);
                        } else {
                            changeEl.innerHTML = `${arrow} ${Math.abs(percentChange).toFixed(1)}%`;
                        }
                        changeEl.style.color = color;
                        
                        // Update expansion data if this is an expandable card
                        if (card.classList.contains('expandable')) {
                            const expansionValue = card.querySelector('.expansion-value');
                            const expansionCount = card.querySelector('.expansion-count');
                            
                            if (expansionValue && expansionCount) {
                                // Format the comparison value
                                let formattedAvg = '';
                                if (label === 'Margin') {
                                    formattedAvg = avgValue.toFixed(1) + '%';
                                } else if (label === 'Attendance') {
                                    formattedAvg = avgValue.toFixed(0);
                                } else if (label === 'RPA') {
                                    formattedAvg = '$' + avgValue.toFixed(0);
                                } else {
                                    formattedAvg = '$' + avgValue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                                }
                                
                                // Update expansion content
                                expansionValue.textContent = `${label}: ${formattedAvg}`;
                                expansionCount.textContent = `(${pool.length} events)`;
                            }
                        }
                    }
                });
                
                // Update product boxes with the new comparison pool
                if (document.getElementById('events-view').style.display !== 'none' && this.currentEvent) {
                    updateProductBoxes(this.currentEvent, this.comparisonEvents);
                }
            }
            
            clearComparisons() {
                // Clear all comparison displays
                const changeEls = document.querySelectorAll('.spotlight-change');
                changeEls.forEach(el => {
                    el.innerHTML = 'N/A';
                    el.style.color = '#94a3b8';
                });
            }
            
            initializeComparisons() {
                // Initialize comparison system with defaults
                this.comparisonPeriod = '3M';
                this.dayOnlyFilter = false;
                this.hotballFilter = 'none';
                
                // Set up event listeners for comparison controls
                const periodButtons = document.querySelectorAll('[data-period]');
                periodButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Remove active from all
                        periodButtons.forEach(b => b.classList.remove('active'));
                        // Add active to clicked
                        btn.classList.add('active');
                        // Update period
                        this.setComparisonPeriod(btn.dataset.period);
                    });
                });
                
                const dayOnlyCheckbox = document.getElementById('dayOnlyFilter');
                if (dayOnlyCheckbox) {
                    dayOnlyCheckbox.addEventListener('change', (e) => {
                        this.setDayOnlyFilter(e.target.checked);
                    });
                }
                
                const hotballSelect = document.getElementById('hotballFilter');
                if (hotballSelect) {
                    hotballSelect.addEventListener('change', (e) => {
                        this.setHotballFilter(e.target.value);
                    });
                }
                
                // Set up expandable spotlight cards
                const expandableCards = document.querySelectorAll('.spotlight-card.expandable');
                expandableCards.forEach(card => {
                    card.addEventListener('click', (e) => {
                        e.stopPropagation();
                        
                        // Close all other expanded cards
                        expandableCards.forEach(c => {
                            if (c !== card) c.classList.remove('expanded');
                        });
                        
                        // Toggle this card
                        card.classList.toggle('expanded');
                    });
                });
                
                // Click anywhere else to close expanded cards
                document.addEventListener('click', () => {
                    expandableCards.forEach(card => {
                        card.classList.remove('expanded');
                    });
                });
                
                // Initial comparison update
                this.updateComparisons();
            }
        }
        
        // Create global EventManager instance
        window.EventManager = new EventManager();
        
        // Diagnostic function to check data availability
        window.diagnoseData = function() {
            console.log('=== VANGUARD DATA DIAGNOSTIC ===');
            
            // Check VanguardData structure
            console.log('1. VanguardData.data structure:');
            console.log('   - sc:', window.VanguardData.data.sc ? 
                `${Object.keys(window.VanguardData.data.sc.rows || {}).length} rows, ${(window.VanguardData.data.sc.columns || []).length} columns` : 
                'MISSING');
            console.log('   - rwc:', window.VanguardData.data.rwc ? 
                `${Object.keys(window.VanguardData.data.rwc.rows || {}).length} rows, ${(window.VanguardData.data.rwc.columns || []).length} columns` : 
                'MISSING');
            console.log('   - scMonthly:', window.VanguardData.data.scMonthly ? 
                `${Object.keys(window.VanguardData.data.scMonthly.rows || {}).length} rows, ${(window.VanguardData.data.scMonthly.columns || []).length} columns` : 
                'MISSING');
            console.log('   - rwcMonthly:', window.VanguardData.data.rwcMonthly ? 
                `${Object.keys(window.VanguardData.data.rwcMonthly.rows || {}).length} rows, ${(window.VanguardData.data.rwcMonthly.columns || []).length} columns` : 
                'MISSING');
            
            // Check getAllEvents
            console.log('\n2. VanguardData.getAllEvents():');
            const events = window.VanguardData.getAllEvents();
            console.log('   - Total events:', events.length);
            console.log('   - SC events:', events.filter(e => e.location === 'SC').length);
            console.log('   - RWC events:', events.filter(e => e.location === 'RWC').length);
            if (events.length > 0) {
                console.log('   - Sample event:', events[0]);
            }
            
            // Check EventManager
            console.log('\n3. EventManager:');
            console.log('   - Events loaded:', window.EventManager.events.length);
            console.log('   - Current event:', window.EventManager.currentEvent?.id || 'NONE');
            
            // Check cache
            console.log('\n4. localStorage cache:');
            const cache = localStorage.getItem('vanguard_data_cache');
            if (cache) {
                try {
                    const parsed = JSON.parse(cache);
                    console.log('   - Cache exists, timestamp:', new Date(parsed.timestamp));
                    console.log('   - Cache has sc:', !!parsed.data?.sc);
                    console.log('   - Cache has rwc:', !!parsed.data?.rwc);
                    console.log('   - Cache has scMonthly:', !!parsed.data?.scMonthly);
                    console.log('   - Cache has rwcMonthly:', !!parsed.data?.rwcMonthly);
                } catch(e) {
                    console.log('   - Cache parse error:', e);
                }
            } else {
                console.log('   - NO CACHE FOUND');
            }
            
            // Check current view settings
            console.log('\n5. Current Data tab settings:');
            console.log('   - Location filter:', document.getElementById('dataLocationFilter')?.value);
            console.log('   - Subview filter:', document.getElementById('dataSubviewFilter')?.value);
            
            console.log('\n=== END DIAGNOSTIC ===');
            return 'Run diagnoseData() again after making changes';
        };
        
        // Test Monthly view data
        window.testMonthlyView = function() {
            console.log('=== TESTING MONTHLY VIEW ===');
            
            // Switch to Monthly tab
            switchView('month-over-month');
            
            // Check what buildMonthlyTable would receive
            const location = 'SC';
            const monthlyData = window.VanguardData.data.scMonthly;
            
            console.log('Monthly data for SC:');
            console.log('  - Columns:', monthlyData?.columns);
            console.log('  - Rows available:', monthlyData?.rows ? Object.keys(monthlyData.rows) : 'NONE');
            console.log('  - Sample row 12 (Total Sales):', monthlyData?.rows?.[12]);
            
            // Check if the expand functions are working
            const salesBox = document.querySelector('.expandable-box');
            if (salesBox) {
                console.log('Sales box found, onclick:', salesBox.onclick);
            } else {
                console.log('ERROR: Sales box not found!');
            }
            
            return 'Check console for Monthly view data';
        };
        
        // Helper to copy cache from one browser to another
        window.copyCache = function() {
            const cache = localStorage.getItem('vanguard_data_cache');
            if (cache) {
                const compressed = cache.substring(0, 100) + '...[DATA]...' + cache.substring(cache.length - 100);
                console.log('Cache found! Size:', (cache.length / 1024 / 1024).toFixed(2) + 'MB');
                console.log('Preview:', compressed);
                console.log('\nCache copied to clipboard!');
                navigator.clipboard.writeText(cache);
                return 'Paste in other browser with: pasteCache(data)';
            } else {
                return 'No cache found in this browser';
            }
        };
        
        // Helper to paste cache data
        window.pasteCache = function(cacheData) {
            try {
                // Validate it's valid JSON
                const parsed = JSON.parse(cacheData);
                if (parsed.data && parsed.timestamp) {
                    localStorage.setItem('vanguard_data_cache', cacheData);
                    console.log('Cache loaded! Refreshing page...');
                    location.reload();
                } else {
                    console.error('Invalid cache format');
                }
            } catch(e) {
                console.error('Failed to parse cache:', e);
            }
        };
        
        // Override the selectEvent function to use EventManager
        window.selectEvent = function(eventId) {
            const buttons = document.querySelectorAll('.event-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                // Also remove inline styles that might override CSS
                btn.style.background = '';
                btn.style.color = '';
            });
            
            // Update button states
            if (window.event && window.event.target) {
                if (window.event.target.classList.contains('dropdown-item')) {
                    document.querySelector('.dropdown-trigger').classList.add('active');
                } else {
                    window.event.target.classList.add('active');
                }
            } else {
                // No event.target (called programmatically), find the right button to activate
                // Find button by onclick attribute since text may not be updated yet
                if (eventId === 'latest') {
                    const latestBtn = Array.from(buttons).find(btn => 
                        btn.getAttribute('onclick')?.includes("'latest'") || 
                        btn.textContent.includes('Latest'));
                    if (latestBtn) latestBtn.classList.add('active');
                } else if (eventId === 'second-latest') {
                    const btn = Array.from(buttons).find(btn => 
                        btn.getAttribute('onclick')?.includes("'second-latest'") || 
                        btn.textContent.includes('Event 2'));
                    if (btn) btn.classList.add('active');
                } else if (eventId === 'third-latest') {
                    const btn = Array.from(buttons).find(btn => 
                        btn.getAttribute('onclick')?.includes("'third-latest'") || 
                        btn.textContent.includes('Event 3'));
                    if (btn) btn.classList.add('active');
                } else if (eventId === 'fourth-latest') {
                    const btn = Array.from(buttons).find(btn => 
                        btn.getAttribute('onclick')?.includes("'fourth-latest'") || 
                        btn.textContent.includes('Event 4'));
                    if (btn) btn.classList.add('active');
                }
            }
            
            // Close dropdown
            const dropdown = document.getElementById('eventDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
            
            // Use EventManager to select and update
            const selectedEvent = window.EventManager.selectEvent(eventId);
            
        }
        
        // Function to populate event selector buttons
        window.populateEventSelector = function() {
            if (!window.EventManager || !window.EventManager.events.length) {
                return;
            }
            
            const events = window.EventManager.events;
            const len = events.length;
            
            // Events are now oldest-first, so get the last 4 for most recent
            const recentEvents = [];
            for (let i = Math.max(0, len - 4); i < len; i++) {
                recentEvents.push(events[i]);
            }
            recentEvents.reverse(); // Put newest first for display
            
            // Update quick access buttons with the 4 most recent events
            const quickButtons = document.querySelectorAll('.header-row-1 .event-btn:not(.dropdown-trigger)');
            quickButtons.forEach((btn, index) => {
                if (index < recentEvents.length) {
                    const event = recentEvents[index];
                    if (!event) return;
                    
                    // Use EXACT SAME text format as dropdown
                    const displayName = event.getDisplayName();
                    console.log(`Setting button ${index} text to: ${displayName}`);
                    btn.textContent = displayName;
                    
                    // For buttons 2-4, update onclick to use event ID instead of 'second-latest' etc
                    if (index === 0) {
                        btn.setAttribute('onclick', `window.selectEvent('latest')`);
                    } else {
                        btn.setAttribute('onclick', `window.selectEvent('${event.id}')`);
                    }
                }
            });
            
            // Populate dropdown with ALL remaining events
            const dropdownContent = document.querySelector('.dropdown-menu');
            if (dropdownContent) {
                dropdownContent.innerHTML = '';
                
                // Get events to show in dropdown (older than the 4 buttons)
                // Events are oldest-first, so slice from end minus 4
                const startIdx = Math.max(0, len - 20);
                const endIdx = Math.max(0, len - 4); 
                const eventsToShow = events.slice(startIdx, endIdx).reverse(); // Reverse to show newest first in dropdown
                
                if (eventsToShow.length > 0) {
                    eventsToShow.forEach(event => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = event.getDisplayName(); // Now includes "SC -" or "RWC -" prefix
                        item.style.cssText = 'padding: 8px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f1f5f9;';
                        item.onmouseover = () => { item.style.background = '#f1f5f9'; };
                        item.onmouseout = () => { item.style.background = 'white'; };
                        item.onclick = () => {
                            selectEvent(event.id);
                            dropdownContent.style.display = 'none'; // Close dropdown after selection
                        };
                        dropdownContent.appendChild(item);
                    });
                } else {
                    const noEvents = document.createElement('div');
                    noEvents.style.cssText = 'padding: 12px; color: #94a3b8; font-size: 13px;';
                    noEvents.textContent = 'No events available';
                    dropdownContent.appendChild(noEvents);
                }
            }
        };
        
        // COMMENTED OUT - Using the window.populateEventSelector function above instead
        // This was causing conflicts and missing RWC events
        /*
        function populateEventSelector() {
            if (!window.VanguardData) return;
            
            const events = window.VanguardData.getAllEvents();
            if (!events || events.length === 0) return;
            
            // Get the dropdown menu
            const dropdown = document.getElementById('eventDropdown');
            if (!dropdown) return;
            
            // Clear existing items (keep structure for now)
            dropdown.innerHTML = '';
            
            // Add recent events to dropdown (skip the first few that are shown as buttons)
            events.slice(4, Math.min(20, events.length)).forEach((event, index) => {
                const eventDate = new Date(event.date);
                const dateStr = `${eventDate.getMonth() + 1}/${eventDate.getDate()}`;
                const eventLabel = `${event.day} ${dateStr}${event.isLate ? ' - Late' : ''}`;
                
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.onclick = () => selectEvent(index + 4); // Pass index as eventId
                item.title = `${event.location} - ${event.date}`;
                item.style.cssText = 'padding: 8px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f1f5f9;';
                item.textContent = eventLabel;
                
                dropdown.appendChild(item);
            });
            
            // Update the visible event buttons with first few events
            const eventBtns = document.querySelectorAll('.event-btn:not(.dropdown-trigger)');
            events.slice(0, Math.min(4, events.length)).forEach((event, index) => {
                if (eventBtns[index + 1]) { // Skip "Latest Event" button
                    const eventDate = new Date(event.date);
                    const dateStr = `${eventDate.getMonth() + 1}/${eventDate.getDate()}`;
                    eventBtns[index + 1].textContent = `${event.day} ${dateStr}${event.isLate ? ' Late' : ''}`;
                    eventBtns[index + 1].onclick = () => selectEvent(index);
                    eventBtns[index + 1].title = `${event.location} - ${event.date}`;
                }
            });
        }
        */
        
        // ============================================================
        
        // ============================================================
        // SECTION: VIEW SWITCHING AND TAB MANAGEMENT  
        // ============================================================
        // Override the switchView function with full implementation
        window.switchView = function(view) {
            // Play navigation sound
            AppSounds.play('navigate');
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                if (tab.textContent === 'Events' && view === 'events') {
                    tab.classList.add('active');
                } else if (tab.textContent === 'Reporting' && view === 'reporting') {
                    tab.classList.add('active');
                } else if (tab.textContent === 'Data' && view === 'data') {
                    tab.classList.add('active');
                }
                /* Commented out Monthly tab
                } else if (tab.textContent === 'Monthly' && view === 'month-over-month') {
                    tab.classList.add('active');
                */
            });
            
            const eventsView = document.getElementById('events-view');
            const monthOverMonthView = document.getElementById('month-over-month-view');
            const reportingView = document.getElementById('reporting-view');
            const dataView = document.getElementById('data-view');
            
            // Hide all views
            if (eventsView) {
                eventsView.style.display = 'none';
                eventsView.classList.remove('active');
            }
            if (monthOverMonthView) {
                monthOverMonthView.style.display = 'none';
                monthOverMonthView.classList.remove('active');
            }
            if (reportingView) {
                reportingView.style.display = 'none';
                reportingView.classList.remove('active');
            }
            if (dataView) {
                dataView.style.display = 'none';
                dataView.classList.remove('active');
            }
            
            // Clean up any misplaced elements when switching views
            if (view !== 'events') {
                // Hide product boxes when not on Events view
                const productBoxes = document.querySelector('.product-boxes-section');
                if (productBoxes) {
                    console.log('[DEBUG] Hiding product boxes on', view, 'view');
                    productBoxes.style.display = 'none';
                }
                
                // Remove comparison cards
                const strayCards = document.querySelectorAll('.comparison-cards');
                strayCards.forEach(card => {
                    if (!card.closest('#events-view')) {
                        card.remove();
                    }
                });
                
                // Remove Per Attendee Revenue Analysis boxes
                const chartContainers = document.querySelectorAll('.chart-container');
                chartContainers.forEach(container => {
                    const title = container.querySelector('.chart-title');
                    if (title && title.textContent === 'Per Attendee Revenue Analysis') {
                        if (!container.closest('#events-view')) {
                            container.remove();
                        }
                    }
                });
            } else {
                // Show product boxes when on Events view
                const productBoxes = document.querySelector('.product-boxes-section');
                if (productBoxes) {
                    console.log('[DEBUG] Showing product boxes on Events view');
                    productBoxes.style.display = 'block';
                }
            }
            
            // Show selected view
            if (view === 'events' && eventsView) {
                eventsView.style.display = 'block';
                eventsView.classList.add('active');
            /* } else if (view === 'month-over-month' && monthOverMonthView) {
                monthOverMonthView.style.display = 'block';
                monthOverMonthView.classList.add('active'); */
            } else if (view === 'reporting' && reportingView) {
                console.log('Switching to Reporting view');
                reportingView.style.display = 'block';
                reportingView.classList.add('active');
                initializeReportingView(); // Initialize the reporting view when shown
            } else if (view === 'data' && dataView) {
                console.log('Switching to Data view');
                dataView.style.display = 'block';
                dataView.classList.add('active');
                updateSheetsView(); // Populate the table when shown
            }
        }
        
        // Diagnostic function
        window.checkViews = function() {
            console.log('=== VIEW DIAGNOSTIC ===');
            const views = ['events-view', 'month-over-month-view', 'reporting-view', 'data-view'];
            views.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    console.log(`${id}: exists, display="${elem.style.display}", hasContent=${elem.innerHTML.length > 100}`);
                    if (id === 'reporting-view') {
                        const container = document.getElementById('reportingMonthsContainer');
                        console.log(`  - reportingMonthsContainer: ${container ? 'exists' : 'missing'}, content=${container ? container.innerHTML.length : 0}`);
                    }
                } else {
                    console.log(`${id}: MISSING!`);
                }
            });
        }
        
        // Set to light mode by default
        window.addEventListener('load', function() {
            document.body.classList.add('light-mode');
            // Run diagnostic after load
            setTimeout(() => window.checkViews(), 1000);
        });

        // Events View Functions
        function toggleDropdown() {
            const dropdown = document.getElementById('eventDropdown');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
        }

        // REMOVED OLD selectEvent - using EventManager version above
        function OLD_selectEvent_REMOVED(eventId) {
            return; // EXIT IMMEDIATELY - This function has been replaced
            const buttons = document.querySelectorAll('.event-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Find and activate the button that was clicked
            if (event && event.target) {
                if (event.target.classList.contains('dropdown-item')) {
                    // If a dropdown item was clicked, activate the Previous Events button
                    document.querySelector('.dropdown-trigger').classList.add('active');
                } else {
                    event.target.classList.add('active');
                }
            }
            
            const dropdown = document.getElementById('eventDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
                dropdown.style.display = 'none';
            }
            
            // Get the selected event based on eventId
            let selectedEvent = null;
            
            if (window.VanguardData) {
                const events = window.VanguardData.getAllEvents();
                
                if (eventId === 'latest') {
                    selectedEvent = window.VanguardData.getLatestEvent();
                } else {
                    // Try to find by index if eventId is a number
                    const eventIndex = parseInt(eventId);
                    if (!isNaN(eventIndex) && eventIndex >= 0 && eventIndex < events.length) {
                        selectedEvent = events[eventIndex];
                    } else {
                        // For the hardcoded button IDs, map them to recent events by position
                        // These are the original button IDs that don't match actual dates
                        const buttonMap = {
                            'tuesday-17': 0,      // First event
                            'wednesday-16': 1,     // Second event
                            'friday-14-late': 2,   // Third event
                            'thursday-13': 3,      // Fourth event
                            'wednesday-12-late': 4,
                            'tuesday-11': 5,
                            'monday-10': 6,
                            'sunday-9-late': 7,
                            'saturday-8': 8,
                            'friday-7-late': 9,
                            'thursday-6': 10,
                            'wednesday-5': 11,
                            'tuesday-4-late': 12,
                            'monday-3': 13,
                            'sunday-2': 14,
                            'saturday-1-late': 15
                        };
                        
                        if (buttonMap.hasOwnProperty(eventId) && buttonMap[eventId] < events.length) {
                            selectedEvent = events[buttonMap[eventId]];
                        } else {
                            // Try to match by date string or other pattern
                            selectedEvent = events.find(e => {
                                return e.date === eventId || 
                                       e.date.includes(eventId) ||
                                       `${e.day}-${e.date}` === eventId ||
                                       `${e.location}-${e.date}` === eventId;
                            });
                        }
                    }
                    
                    // If still not found, use the first event as fallback
                    if (!selectedEvent && events.length > 0) {
                        console.log('Event not found for ID:', eventId, '- using first event as fallback');
                        selectedEvent = events[0];
                    }
                }
                
                // Update current event and refresh all displays
                if (selectedEvent) {
                    window.VanguardData.currentEvent = selectedEvent;
                    
                    // Update all visualizations with the selected event
                    // Use EventManager's methods for consistency
                    if (window.EventManager) {
                        window.EventManager.updateHotballDisplay();
                        window.EventManager.updateEventMetrics();
                    }
                    
                    // Update dashboard if the method exists
                    if (window.VanguardData.updateDashboard) {
                        window.VanguardData.updateDashboard();
                    }
                }
            }
            
            // Update the page title to show selected event
            updateEventTitle(eventId);
            
            // Update dashboard data based on selected event
            console.log('Selected event:', eventId, selectedEvent);
        }
        
        

        function toggleDataLabels(show) {
            // Toggle all data labels in the current chart
            const container = document.getElementById('monthly-chart-container');
            if (container) {
                container.querySelectorAll('.data-label').forEach(label => {
                    label.style.display = show ? 'block' : 'none';
                });
            }
            // Legacy support for old labels
            const labels = document.querySelector('.data-labels');
            if (labels) {
                labels.style.display = show ? 'block' : 'none';
            }
        }

        // Product Performance Box Functions
        function updateProductBoxes(currentEvent, comparisonPool) {
            console.log('[DEBUG] updateProductBoxes called');
            console.log('[DEBUG] Current event:', currentEvent);
            console.log('[DEBUG] Comparison pool size:', comparisonPool ? comparisonPool.length : 0);
            
            // Update event info in header
            const eventInfoEl = document.getElementById('productBoxEventInfo');
            if (eventInfoEl) {
                if (currentEvent) {
                    const location = currentEvent.location || 'Unknown';
                    const day = currentEvent.day || 'Unknown';
                    const date = currentEvent.date || 'Unknown';
                    const isLate = currentEvent.isLate ? ' (Late)' : '';
                    eventInfoEl.textContent = `${location} - ${day} ${date}${isLate}`;
                } else {
                    eventInfoEl.textContent = 'No Event Selected';
                }
            }
            
            // Update comparison info
            const comparisonInfoEl = document.getElementById('productBoxComparisonInfo');
            if (comparisonInfoEl && window.EventManager) {
                const parts = [];
                
                // Time period
                const period = window.EventManager.comparisonPeriod || '3M';
                const periodText = period === '1M' ? '1 Month' : 
                                  period === '3M' ? '3 Months' : 
                                  period === '1Y' ? '1 Year' : period;
                parts.push(periodText);
                
                // Day matching
                if (window.EventManager.dayOnlyFilter) {
                    parts.push('Exact Day Match');
                } else {
                    parts.push('No Day Matching');
                }
                
                // Hotball filter
                const hotball = window.EventManager.hotballFilter;
                if (hotball === 'category') {
                    parts.push('Hotball Category Match');
                } else if (hotball === '10%') {
                    parts.push('10% Hotball Match');
                } else if (hotball === '20%') {
                    parts.push('20% Hotball Match');
                } else {
                    parts.push('No Hotball Match');
                }
                
                // Pool size
                if (comparisonPool && comparisonPool.length > 0) {
                    parts.push(`(${comparisonPool.length} events)`);
                }
                
                comparisonInfoEl.textContent = parts.join(', ');
            }
            
            if (!currentEvent) {
                console.log('[DEBUG] No current event, clearing boxes');
                // Clear all boxes if no event
                ['flash', 'strip', 'other'].forEach(product => {
                    document.getElementById(`${product}EventPercent`).textContent = '% of Event - 0%';
                    document.getElementById(`${product}Revenue`).textContent = '$0';
                    document.getElementById(`${product}Payouts`).textContent = '$0';
                    document.getElementById(`${product}Net`).textContent = '$0';
                    document.getElementById(`${product}Margin`).textContent = product === 'other' ? 'N/A' : '0%';
                    // Clear all comparison values
                    [`${product}RevenueChange`, `${product}PayoutsChange`, 
                     `${product}NetChange`, `${product}MarginChange`].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.textContent = '-';
                            el.style.color = '#64748b';
                        }
                    });
                });
                return;
            }
            
            // Calculate product metrics for current event
            const currentMetrics = calculateProductMetrics(currentEvent);
            console.log('[DEBUG] Current metrics:', currentMetrics);
            
            // Calculate comparison metrics from pool
            let comparisonMetrics = null;
            if (comparisonPool && comparisonPool.length > 0) {
                console.log('[DEBUG] Calculating comparison metrics from', comparisonPool.length, 'events');
                comparisonMetrics = calculateAverageProductMetrics(comparisonPool);
                console.log('[DEBUG] Comparison metrics:', comparisonMetrics);
            } else {
                console.log('[DEBUG] No comparison pool available');
            }
            
            // Calculate total event revenue for percentage calculations
            const totalEventRevenue = currentMetrics.flash.revenue + currentMetrics.strip.revenue + currentMetrics.other.revenue;
            
            // Update each product box
            ['flash', 'strip', 'other'].forEach(product => {
                const revenue = currentMetrics[product].revenue;
                const cost = currentMetrics[product].cost;
                const netRevenue = revenue - cost;
                const margin = currentMetrics[product].margin;
                
                // Calculate percentage of total event revenue
                const percentOfEvent = totalEventRevenue > 0 ? (revenue / totalEventRevenue * 100) : 0;
                
                // Update percentage of event
                const percentEl = document.getElementById(`${product}EventPercent`);
                if (percentEl) {
                    percentEl.textContent = `% of Event - ${percentOfEvent.toFixed(0)}%`;
                }
                
                // Update revenue
                document.getElementById(`${product}Revenue`).textContent = 
                    revenue > 0 ? `$${Math.round(revenue).toLocaleString()}` : '$0';
                
                // Update payouts
                document.getElementById(`${product}Payouts`).textContent = 
                    cost > 0 ? `$${Math.round(cost).toLocaleString()}` : '$0';
                
                // Update net revenue
                document.getElementById(`${product}Net`).textContent = 
                    netRevenue !== 0 ? `$${Math.round(netRevenue).toLocaleString()}` : '$0';
                
                // Update margin
                if (product === 'other') {
                    // For Other, show margin but N/A if negative or over 50%
                    if (margin < 0 || margin > 50) {
                        document.getElementById(`${product}Margin`).textContent = 'N/A';
                    } else {
                        document.getElementById(`${product}Margin`).textContent = `${margin.toFixed(1)}%`;
                    }
                } else {
                    document.getElementById(`${product}Margin`).textContent = 
                        margin > 0 ? `${margin.toFixed(1)}%` : '0%';
                }
                
                // Update individual comparison values
                if (comparisonMetrics && comparisonMetrics[product]) {
                    // Calculate all changes
                    const compRevenue = comparisonMetrics[product].revenue;
                    const compCost = comparisonMetrics[product].cost;
                    const compNet = compRevenue - compCost;
                    const compMargin = comparisonMetrics[product].margin;
                    
                    // Calculate percentage of total for comparison
                    const compTotalRevenue = (comparisonMetrics.flash?.revenue || 0) + 
                                           (comparisonMetrics.strip?.revenue || 0) + 
                                           (comparisonMetrics.other?.revenue || 0);
                    const compPercentOfEvent = compTotalRevenue > 0 ? (compRevenue / compTotalRevenue * 100) : 0;
                    
                    // Revenue change
                    const revenueChangeEl = document.getElementById(`${product}RevenueChange`);
                    if (revenueChangeEl && compRevenue > 0) {
                        const revenueChange = ((revenue - compRevenue) / compRevenue) * 100;
                        const arrow = revenueChange > 0 ? '↑' : revenueChange < 0 ? '↓' : '';
                        revenueChangeEl.textContent = `${arrow}${Math.abs(revenueChange).toFixed(1)}%`;
                        revenueChangeEl.style.color = revenueChange > 0 ? '#10b981' : revenueChange < 0 ? '#ef4444' : '#64748b';
                    } else if (revenueChangeEl) {
                        revenueChangeEl.textContent = '-';
                        revenueChangeEl.style.color = '#64748b';
                    }
                    
                    // Payouts change
                    const payoutsChangeEl = document.getElementById(`${product}PayoutsChange`);
                    if (payoutsChangeEl && compCost > 0) {
                        const payoutsChange = ((cost - compCost) / compCost) * 100;
                        const arrow = payoutsChange > 0 ? '↑' : payoutsChange < 0 ? '↓' : '';
                        payoutsChangeEl.textContent = `${arrow}${Math.abs(payoutsChange).toFixed(1)}%`;
                        // For payouts, use neutral black color since it's neither good nor bad
                        payoutsChangeEl.style.color = '#1e293b';
                    } else if (payoutsChangeEl) {
                        payoutsChangeEl.textContent = '-';
                        payoutsChangeEl.style.color = '#64748b';
                    }
                    
                    // Net Revenue change
                    const netChangeEl = document.getElementById(`${product}NetChange`);
                    if (netChangeEl && compNet !== 0) {
                        const netChange = ((netRevenue - compNet) / Math.abs(compNet)) * 100;
                        const arrow = netChange > 0 ? '↑' : netChange < 0 ? '↓' : '';
                        netChangeEl.textContent = `${arrow}${Math.abs(netChange).toFixed(1)}%`;
                        netChangeEl.style.color = netChange > 0 ? '#10b981' : netChange < 0 ? '#ef4444' : '#64748b';
                    } else if (netChangeEl) {
                        netChangeEl.textContent = '-';
                        netChangeEl.style.color = '#64748b';
                    }
                    
                    // Margin change (pp and %)
                    const marginChangeEl = document.getElementById(`${product}MarginChange`);
                    if (marginChangeEl) {
                        if (product === 'other' && (margin < 0 || margin > 50 || compMargin < 0 || compMargin > 50)) {
                            // If Other margin is invalid, don't show comparison
                            marginChangeEl.textContent = '-';
                            marginChangeEl.style.color = '#64748b';
                        } else {
                            const marginPPChange = margin - compMargin;
                            const marginPercChange = compMargin > 0 ? ((margin - compMargin) / compMargin) * 100 : 0;
                            const arrow = marginPPChange > 0 ? '↑' : marginPPChange < 0 ? '↓' : '';
                            // Show both pp and % change for margin
                            marginChangeEl.textContent = `${arrow}${Math.abs(marginPPChange).toFixed(1)}pp`;
                            marginChangeEl.style.color = marginPPChange > 0 ? '#10b981' : marginPPChange < 0 ? '#ef4444' : '#64748b';
                        }
                    }
                } else {
                    // No comparison data - set all to dash
                    [`${product}RevenueChange`, `${product}PayoutsChange`, 
                     `${product}NetChange`, `${product}MarginChange`].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.textContent = '-';
                            el.style.color = '#64748b';
                        }
                    });
                }
                
                // Update expansion details
                updateProductExpansion(product, currentEvent, currentMetrics[product], 
                                      comparisonPool, comparisonMetrics ? comparisonMetrics[product] : null,
                                      comparisonMetrics);
            });
        }
        
        function calculateProductMetrics(event) {
            const metrics = {
                flash: { revenue: 0, cost: 0, margin: 0, count: 0 },
                strip: { revenue: 0, cost: 0, margin: 0, count: 0 },
                other: { revenue: 0, cost: 0, margin: 0, count: 0 }
            };
            
            if (!event) return metrics;
            
            // Flash products
            // Revenue: Row 6 (Flash)
            metrics.flash.revenue = parseFloat(event.getRowValue ? event.getRowValue(6) : event.flash) || 0;
            // Payouts: Row 18 (Flash Payouts) + Row 27 (Flash Redeemed)
            metrics.flash.cost = (parseFloat(event.getRowValue ? event.getRowValue(18) : 0) || 0) + 
                                (parseFloat(event.getRowValue ? event.getRowValue(27) : 0) || 0);
            
            // Strip products
            // Revenue: Row 9 (Strips)
            metrics.strip.revenue = parseFloat(event.getRowValue ? event.getRowValue(9) : event.strips) || 0;
            // Payouts: Row 16 (Strip Payouts) + Row 19 (All Numbers) + Row 20 (Double Action) + Row 21 (Winnemucca) + Row 22 (RWB)
            metrics.strip.cost = (parseFloat(event.getRowValue ? event.getRowValue(16) : 0) || 0) +
                                (parseFloat(event.getRowValue ? event.getRowValue(19) : 0) || 0) +
                                (parseFloat(event.getRowValue ? event.getRowValue(20) : 0) || 0) +
                                (parseFloat(event.getRowValue ? event.getRowValue(21) : 0) || 0) +
                                (parseFloat(event.getRowValue ? event.getRowValue(22) : 0) || 0);
            
            // Other products
            // Revenue: Row 7 (Cherries) + Row 8 (Paper) + Row 10 (Merch)
            metrics.other.revenue = (parseFloat(event.getRowValue ? event.getRowValue(7) : event.cherries) || 0) +
                                   (parseFloat(event.getRowValue ? event.getRowValue(8) : event.paper) || 0) +
                                   (parseFloat(event.getRowValue ? event.getRowValue(10) : 0) || 0);
            // Payouts: Row 17 (Paper Game Payouts) + Row 23 (Cherry Redeemed) + Row 24 (Cherry from Winn) + Row 25 (Gift Cert) + Row 26 (Refund/Other)
            metrics.other.cost = (parseFloat(event.getRowValue ? event.getRowValue(17) : 0) || 0) +
                                (parseFloat(event.getRowValue ? event.getRowValue(23) : 0) || 0) +
                                (parseFloat(event.getRowValue ? event.getRowValue(24) : 0) || 0) +
                                (parseFloat(event.getRowValue ? event.getRowValue(25) : 0) || 0) +
                                (parseFloat(event.getRowValue ? event.getRowValue(26) : 0) || 0);
            
            // Calculate margins
            ['flash', 'strip', 'other'].forEach(product => {
                if (metrics[product].revenue > 0) {
                    metrics[product].margin = ((metrics[product].revenue - metrics[product].cost) / metrics[product].revenue) * 100;
                }
            });
            
            return metrics;
        }
        
        function calculateAverageProductMetrics(events) {
            if (!events || events.length === 0) return null;
            
            const totals = {
                flash: { revenue: 0, cost: 0, margin: 0, count: 0 },
                strip: { revenue: 0, cost: 0, margin: 0, count: 0 },
                other: { revenue: 0, cost: 0, margin: 0, count: 0 }
            };
            
            events.forEach(event => {
                const metrics = calculateProductMetrics(event);
                ['flash', 'strip', 'other'].forEach(product => {
                    totals[product].revenue += metrics[product].revenue;
                    totals[product].cost += metrics[product].cost;
                    if (metrics[product].revenue > 0) {
                        totals[product].count++;
                    }
                });
            });
            
            // Calculate averages and margins
            ['flash', 'strip', 'other'].forEach(product => {
                if (totals[product].count > 0) {
                    totals[product].revenue = totals[product].revenue / events.length;
                    totals[product].cost = totals[product].cost / events.length;
                    if (totals[product].revenue > 0) {
                        totals[product].margin = ((totals[product].revenue - totals[product].cost) / totals[product].revenue) * 100;
                    }
                }
            });
            
            return totals;
        }
        
        function updateProductExpansion(product, currentEvent, currentMetrics, comparisonPool, comparisonMetrics, allComparisonMetrics) {
            const comparisonDetailsEl = document.getElementById(`${product}ComparisonDetails`);
            
            if (!comparisonDetailsEl) {
                console.log(`[DEBUG] No comparison details element found for ${product}`);
                return;
            }
            
            // Update comparison pool details only
            if (comparisonPool && comparisonPool.length > 0 && comparisonMetrics) {
                const avgNet = Math.round(comparisonMetrics.revenue - comparisonMetrics.cost);
                
                // Calculate percentage of total revenue for this product
                let percentOfRevenue = 0;
                if (allComparisonMetrics) {
                    const totalRevenue = (allComparisonMetrics.flash?.revenue || 0) + 
                                       (allComparisonMetrics.strip?.revenue || 0) + 
                                       (allComparisonMetrics.other?.revenue || 0);
                    if (totalRevenue > 0) {
                        percentOfRevenue = (comparisonMetrics.revenue / totalRevenue) * 100;
                    }
                }
                
                // Get proper product display name
                const productName = product.charAt(0).toUpperCase() + product.slice(1);
                
                console.log(`[DEBUG] Updating ${product} expansion with ${comparisonPool.length} events`);
                comparisonDetailsEl.innerHTML = `
                    <div style="margin-bottom: 4px;">Pool Size: ${comparisonPool.length} events</div>
                    <div style="margin-bottom: 4px;">${productName} % of Revenue: ${percentOfRevenue.toFixed(1)}%</div>
                    <div style="margin-bottom: 4px;">Avg Revenue: $${Math.round(comparisonMetrics.revenue).toLocaleString()}</div>
                    <div style="margin-bottom: 4px;">Avg Payouts: $${Math.round(comparisonMetrics.cost).toLocaleString()}</div>
                    <div style="margin-bottom: 4px;">Avg Net Revenue: $${avgNet.toLocaleString()}</div>
                    <div>Avg Margin: ${product === 'other' && (comparisonMetrics.margin < 0 || comparisonMetrics.margin > 50) ? 'N/A' : comparisonMetrics.margin.toFixed(1) + '%'}</div>
                `;
            } else {
                console.log(`[DEBUG] No comparison data for ${product} expansion`);
                comparisonDetailsEl.innerHTML = '<div style="color: #999;">No comparison data available - select comparison filters above</div>';
            }
        }
        
        // Initialize product box click handlers
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[DEBUG] Initializing product box click handlers');
            
            // Wait a bit for the product boxes to be rendered
            setTimeout(() => {
                const boxes = document.querySelectorAll('.product-box');
                console.log('[DEBUG] Found', boxes.length, 'product boxes');
                
                boxes.forEach(box => {
                    box.addEventListener('click', function(e) {
                        console.log('[DEBUG] Product box clicked:', this.dataset.product);
                        
                        // Don't toggle if clicking on a link or button inside
                        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                        
                        // Get all expansions
                        const allExpansions = document.querySelectorAll('.product-expansion');
                        const allBoxes = document.querySelectorAll('.product-box');
                        
                        // Check if any expansion is currently open
                        const isAnyExpanded = Array.from(allExpansions).some(exp => exp.style.display === 'block');
                        console.log('[DEBUG] Current expansion state:', isAnyExpanded ? 'expanded' : 'collapsed');
                        
                        if (isAnyExpanded) {
                            // Close all expansions
                            allExpansions.forEach(exp => {
                                exp.style.display = 'none';
                            });
                            // Remove expanded class from all boxes
                            allBoxes.forEach(b => {
                                b.classList.remove('expanded');
                            });
                            console.log('[DEBUG] All boxes collapsed');
                        } else {
                            // Open all expansions
                            allExpansions.forEach(exp => {
                                exp.style.display = 'block';
                            });
                            // Add expanded class to all boxes
                            allBoxes.forEach(b => {
                                b.classList.add('expanded');
                            });
                            console.log('[DEBUG] All boxes expanded');
                            
                            // Scroll to show the expanded content
                            setTimeout(() => {
                                const firstBox = document.querySelector('.product-box');
                                if (firstBox) {
                                    const rect = firstBox.getBoundingClientRect();
                                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                                    const targetScroll = scrollTop + rect.top - 100; // 100px offset from top
                                    window.scrollTo({ 
                                        top: targetScroll, 
                                        behavior: 'smooth' 
                                    });
                                }
                            }, 100); // Small delay to ensure expansion animation starts
                        }
                    });
                });
            }, 500); // Wait 500ms for product boxes to be rendered
        });

        // Global chart location filter
        let chartLocationFilter = 'combined'; // 'combined', 'SC', 'RWC'
        
        // Update chart location filter
        function updateChartLocation(location) {
            chartLocationFilter = location;
            
            // Update button styles
            const buttons = {
                'combined': document.getElementById('chart-loc-combined'),
                'SC': document.getElementById('chart-loc-sc'),
                'RWC': document.getElementById('chart-loc-rwc')
            };
            
            Object.keys(buttons).forEach(key => {
                if (buttons[key]) {
                    if (key === location) {
                        buttons[key].style.background = '#3b82f6';
                        buttons[key].style.color = 'white';
                    } else {
                        buttons[key].style.background = 'transparent';
                        buttons[key].style.color = '#64748b';
                    }
                }
            });
            
            // Redraw the chart with new filter
            const chartType = document.getElementById('chartTypeSelector')?.value || 'ytd';
            updateChartDisplay(chartType);
        }
        
        // Debug function to inspect Monthly data structure
        window.inspectMonthlyData = function() {
            const scMonthly = window.VanguardData?.data?.scMonthly;
            const rwcMonthly = window.VanguardData?.data?.rwcMonthly;
            
            console.log('=== MONTHLY DATA STRUCTURE INSPECTION ===');
            
            if (scMonthly) {
                console.log('SC Monthly exists. Keys:', Object.keys(scMonthly));
                console.log('SC Monthly full object:', scMonthly);
                
                if (scMonthly.columns) {
                    console.log('SC Columns count:', scMonthly.columns.length);
                    console.log('First column:', scMonthly.columns[0]);
                }
                
                if (scMonthly.rows) {
                    console.log('SC Rows available:', Object.keys(scMonthly.rows).slice(0, 10));
                    console.log('Row 12 (Total Sales):', scMonthly.rows[12]);
                    console.log('Row 31 (Net Sales):', scMonthly.rows[31]);
                }
            }
            
            if (rwcMonthly) {
                console.log('RWC Monthly exists. Keys:', Object.keys(rwcMonthly));
                console.log('RWC Monthly full object:', rwcMonthly);
                
                if (rwcMonthly.columns) {
                    console.log('RWC Columns count:', rwcMonthly.columns.length);
                    console.log('First column:', rwcMonthly.columns[0]);
                }
                
                if (rwcMonthly.rows) {
                    console.log('RWC Rows available:', Object.keys(rwcMonthly.rows).slice(0, 10));
                    console.log('Row 12 (Total Sales):', rwcMonthly.rows[12]);
                    console.log('Row 31 (Net Sales):', rwcMonthly.rows[31]);
                }
            }
        };
        
        /* COMPLETELY DISABLED OLD CHART FUNCTION
        function updateMonthlyRevenueChart_OLD() {
            console.log('=== BRAND NEW MONTHLY REVENUE CHART ===');
            
            // Check if data is loaded
            if (!window.VanguardData || !window.VanguardData.data) {
                console.log('Data not loaded yet');
                return;
            }
            
            // KILL ANY EXISTING CHART
            const container = document.getElementById('monthly-chart-container');
            if (!container) {
                console.error('Chart container not found');
                return;
            }
            container.innerHTML = ''; // CLEAR EVERYTHING
            
            // Get Monthly data from both locations
            const scMonthly = window.VanguardData.data.scMonthly;
            const rwcMonthly = window.VanguardData.data.rwcMonthly;
            
            console.log('SC Monthly available:', !!scMonthly);
            console.log('RWC Monthly available:', !!rwcMonthly);
            
            const monthlyData = [];
            
            // Process SC Monthly data - data is stored in each column's data object
            if (chartLocationFilter !== 'RWC' && scMonthly && scMonthly.columns) {
                console.log('Processing SC Monthly columns:', scMonthly.columns.length);
                console.log('First SC column:', scMonthly.columns[0]);
                
                scMonthly.columns.forEach((col, idx) => {
                    if (col.header && col.data) {
                        // Get Total Sales from row12 and Net Sales from row31
                        const totalSales = col.data.row12?.value || col.data['12']?.value || 0;
                        const netSales = col.data.row31?.value || col.data['31']?.value || 0;
                        
                        if (idx < 3) {  // Log first 3 for debugging
                            console.log(`SC ${col.header}:`, {
                                totalSales,
                                netSales,
                                fullData: col.data
                            });
                        }
                        
                        monthlyData.push({
                            month: col.header,
                            location: 'SC',
                            totalSales: parseFloat(totalSales) || 0,
                            netSales: parseFloat(netSales) || 0
                        });
                    }
                });
            } else {
                console.log('No SC Monthly data found');
            }
            
            // Process RWC Monthly data and combine with same months
            if (chartLocationFilter !== 'SC' && rwcMonthly && rwcMonthly.columns) {
                console.log('Processing RWC Monthly columns:', rwcMonthly.columns.length);
                console.log('First RWC column:', rwcMonthly.columns[0]);
                
                rwcMonthly.columns.forEach((col, idx) => {
                    if (col.header && col.data) {
                        // Get Total Sales from row12 and Net Sales from row31
                        const totalSales = col.data.row12?.value || col.data['12']?.value || 0;
                        const netSales = col.data.row31?.value || col.data['31']?.value || 0;
                        
                        if (idx < 3) {  // Log first 3 for debugging
                            console.log(`RWC ${col.header}:`, {
                                totalSales,
                                netSales,
                                fullData: col.data
                            });
                        }
                        
                        // Find if this month already exists from SC (only combine in 'combined' mode)
                        const existing = chartLocationFilter === 'combined' ? monthlyData.find(d => d.month === col.header) : null;
                        if (existing) {
                            // Combine the values (only in combined mode)
                            existing.totalSales += parseFloat(totalSales) || 0;
                            existing.netSales += parseFloat(netSales) || 0;
                            existing.location = 'Combined';
                        } else {
                            // Add as new month
                            monthlyData.push({
                                month: col.header,
                                location: 'RWC',
                                totalSales: parseFloat(totalSales) || 0,
                                netSales: parseFloat(netSales) || 0
                            });
                        }
                    }
                });
            } else {
                console.log('No RWC Monthly data found');
            }
            
            if (monthlyData.length === 0) {
                console.log('No monthly data found');
                return;
            }
            
            // Sort months chronologically
            const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            monthlyData.sort((a, b) => {
                const aMonth = a.month.split('-')[0];
                const bMonth = b.month.split('-')[0];
                const aYear = parseInt(a.month.split('-')[1]) || 2024;
                const bYear = parseInt(b.month.split('-')[1]) || 2024;
                
                if (aYear !== bYear) return aYear - bYear;
                return monthOrder.indexOf(aMonth) - monthOrder.indexOf(bMonth);
            });
            
            // Get current month
            const now = new Date();
            const currentMonth = now.toLocaleDateString('en-US', { month: 'short' });
            const currentYear = now.getFullYear();
            const currentMonthKey = `${currentMonth}-${currentYear % 100}`; // e.g., "Aug-24"
            
            // Check if current month is incomplete and needs projection
            const currentMonthData = monthlyData.find(d => d.month === currentMonthKey);
            if (currentMonthData) {
                // Calculate projection based on days elapsed
                const daysInMonth = new Date(currentYear, now.getMonth() + 1, 0).getDate();
                const currentDay = now.getDate();
                const percentComplete = currentDay / daysInMonth;
                
                // Only project if month is less than 90% complete
                if (percentComplete < 0.9) {
                    // Project the full month values
                    currentMonthData.totalSales = currentMonthData.totalSales / percentComplete;
                    currentMonthData.netSales = currentMonthData.netSales / percentComplete;
                    currentMonthData.isProjection = true;
                    console.log(`Projecting ${currentMonthKey}: ${Math.round(percentComplete * 100)}% complete`);
                }
            }
            
            // Filter out any future months (but for now just use all data since we don't have future data)
            // The issue was the year parsing - the data might have full years like "2024" not "24"
            const chartData = monthlyData.slice(-12);
            
            if (chartData.length === 0) {
                console.log('No data to display');
                return;
            }
            
            console.log('Chart data:', chartData);
            
            
            // Calculate chart dimensions
            const chartWidth = 840 - 60;
            const chartHeight = 240 - 40;
            const xStep = chartWidth / Math.max(chartData.length - 1, 1);
            
            // Find max value for scaling
            const maxValue = Math.max(
                ...chartData.map(d => d.totalSales),
                ...chartData.map(d => d.netSales),
                100000 // Minimum scale
            );
            
            // Round up to nice number for Y axis
            const yMax = Math.ceil(maxValue / 50000) * 50000;
            const yScale = chartHeight / yMax;
            
            // Generate points for gross revenue line
            const grossPoints = chartData.map((d, i) => {
                const x = 60 + (i * xStep);
                const y = 240 - 20 - (d.totalSales * yScale);  // Adjusted for margins
                console.log(`Point ${i}: x=${x}, y=${y}, value=${d.totalSales}`);
                return `${x},${y}`;
            }).join(' ');
            
            // Generate points for net revenue line
            const netPoints = chartData.map((d, i) => {
                const x = 60 + (i * xStep);
                const y = 240 - 20 - (d.netSales * yScale);  // Adjusted for margins
                return `${x},${y}`;
            }).join(' ');
            
            // CREATE FRESH LINES
            console.log('Creating fresh polyline elements');
            console.log('Gross points:', grossPoints);
            console.log('Net points:', netPoints);
            
            // Create gross revenue line
            const grossLine = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            grossLine.setAttribute('points', grossPoints);
            grossLine.setAttribute('stroke', '#60a5fa');
            grossLine.setAttribute('stroke-width', '3');
            grossLine.setAttribute('fill', 'none');
            grossLine.setAttribute('stroke-linejoin', 'round');
            grossLine.setAttribute('stroke-linecap', 'round');
            svgElement.appendChild(grossLine);
            
            // Create net revenue line
            const netLine = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            netLine.setAttribute('points', netPoints);
            netLine.setAttribute('stroke', '#34d399');
            netLine.setAttribute('stroke-width', '3');
            netLine.setAttribute('fill', 'none');
            netLine.setAttribute('stroke-linejoin', 'round');
            netLine.setAttribute('stroke-linecap', 'round');
            svgElement.appendChild(netLine);
            
            console.log('Lines added to SVG');
            
            // Update Y axis labels
            const yLabels = svgElement.querySelectorAll('.y-axis-labels text');
            const yStep = yMax / 6;
            yLabels.forEach((label, i) => {
                const value = yMax - (i * yStep);
                if (value >= 1000) {
                    label.textContent = '$' + Math.round(value / 1000) + 'K';
                } else {
                    label.textContent = '$' + Math.round(value);
                }
            });
            
            // Update X axis labels
            const xLabels = svgElement.querySelectorAll('.x-axis-labels text');
            chartData.forEach((d, i) => {
                if (xLabels[i]) {
                    xLabels[i].textContent = d.month.split('-')[0]; // Just show month abbreviation
                }
            });
            
            // Clear remaining labels
            for (let i = chartData.length; i < xLabels.length; i++) {
                if (xLabels[i]) {
                    xLabels[i].textContent = '';
                }
            }
            
            // Update legend
            const legendTexts = svgElement.querySelectorAll('.legend text');
            if (legendTexts[0]) {
                legendTexts[0].textContent = 'Gross Revenue';
            }
            if (legendTexts[1]) {
                legendTexts[1].textContent = 'Net Revenue';
            }
            
            // Remove existing data labels
            svgElement.querySelectorAll('.data-label').forEach(label => label.remove());
            
            // Add data labels group
            const dataLabelsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            dataLabelsGroup.classList.add('data-labels');
            dataLabelsGroup.style.display = document.getElementById('dataLabelsToggle')?.checked ? 'block' : 'none';
            
            // Add gross revenue data labels
            chartData.forEach((d, i) => {
                const x = 60 + (i * xStep);
                const y = 240 - (d.totalSales * yScale);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.classList.add('data-label');
                text.setAttribute('x', x);
                text.setAttribute('y', y - 5);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#60a5fa');
                text.setAttribute('font-size', '10');
                text.setAttribute('font-weight', '600');
                text.textContent = '$' + Math.round(d.totalSales / 1000) + 'K';
                if (d.isProjection) {
                    text.setAttribute('font-style', 'italic');
                }
                dataLabelsGroup.appendChild(text);
            });
            
            // Add net revenue data labels
            chartData.forEach((d, i) => {
                const x = 60 + (i * xStep);
                const y = 240 - (d.netSales * yScale);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.classList.add('data-label');
                text.setAttribute('x', x);
                text.setAttribute('y', y - 5);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#34d399');
                text.setAttribute('font-size', '10');
                text.setAttribute('font-weight', '600');
                text.textContent = '$' + Math.round(d.netSales / 1000) + 'K';
                if (d.isProjection) {
                    text.setAttribute('font-style', 'italic');
                }
                dataLabelsGroup.appendChild(text);
            });
            
            svgElement.appendChild(dataLabelsGroup);
            
            // Add projection indicator if current month is projected
            const hasProjection = chartData.some(d => d.isProjection);
            if (hasProjection) {
                // Remove existing projection note
                svgElement.querySelectorAll('.projection-note').forEach(note => note.remove());
                
                const projectionNote = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                projectionNote.classList.add('projection-note');
                projectionNote.setAttribute('x', 840);
                projectionNote.setAttribute('y', 30);
                projectionNote.setAttribute('text-anchor', 'end');
                projectionNote.setAttribute('fill', '#94a3b8');
                projectionNote.setAttribute('font-size', '11');
                projectionNote.setAttribute('font-style', 'italic');
                projectionNote.textContent = '* Current month projected';
                svgElement.appendChild(projectionNote);
            }
            
            console.log(`Monthly revenue chart updated with ${chartData.length} months of data`);
        }
        */
        
        // COMPLETELY NEW FROM SCRATCH
        function updateMonthlyRevenueChart() {
            console.log('=== STARTING OVER - NEW CHART ===');
            
            const container = document.getElementById('monthly-chart-container');
            if (!container) return;
            
            // Clear everything
            container.innerHTML = '';
            
            // Get the Monthly data that we KNOW works in Reporting tab
            if (!window.VanguardData?.data?.scMonthly && !window.VanguardData?.data?.rwcMonthly) {
                container.innerHTML = '<div style="padding: 20px;">No Monthly data available</div>';
                return;
            }
            
            // Build data array - SIMPLE
            const months = [];
            const grossValues = [];
            const netValues = [];
            
            // Get SC Monthly columns - SKIP Total and Average columns
            if (window.VanguardData.data.scMonthly?.columns) {
                window.VanguardData.data.scMonthly.columns.forEach(col => {
                    if (col.header && col.data) {
                        // Skip Total and Average columns
                        const headerLower = col.header.toLowerCase();
                        if (headerLower.includes('total') || headerLower.includes('average')) {
                            return; // Skip this column
                        }
                        
                        // The working code from Reporting uses col.data.row12.value
                        const gross = col.data?.row12?.value || 0;
                        const net = col.data?.row31?.value || 0;
                        
                        months.push(col.header);
                        grossValues.push(parseFloat(gross));
                        netValues.push(parseFloat(net));
                    }
                });
            }
            
            // Get last 12 months
            const last12Months = months.slice(-12);
            const last12Gross = grossValues.slice(-12);
            const last12Net = netValues.slice(-12);
            
            if (last12Months.length === 0) {
                container.innerHTML = '<div style="padding: 20px;">No data to display</div>';
                return;
            }
            
            // Find max for scale
            const maxGross = Math.max(...last12Gross);
            const maxNet = Math.max(...last12Net);
            const maxValue = Math.max(maxGross, maxNet, 100000);
            
            console.log('Data check:', {
                months: last12Months,
                gross: last12Gross,
                net: last12Net,
                max: maxValue
            });
            
            // Create SVG LINE CHART with values in MILLIONS
            const chartWidth = 800;
            const chartHeight = 300;
            const padding = { top: 20, right: 20, bottom: 50, left: 80 };
            const plotWidth = chartWidth - padding.left - padding.right;
            const plotHeight = chartHeight - padding.top - padding.bottom;
            
            // Scale values to millions
            const maxValueM = maxValue / 1000000;
            const yMax = Math.ceil(maxValueM * 1.1); // Add 10% padding
            
            // Create points for line chart
            const xStep = plotWidth / (last12Months.length - 1 || 1);
            const yScale = plotHeight / yMax;
            
            const grossPoints = last12Gross.map((val, i) => {
                const x = padding.left + (i * xStep);
                const y = padding.top + plotHeight - (val / 1000000 * yScale);
                return `${x},${y}`;
            }).join(' ');
            
            const netPoints = last12Net.map((val, i) => {
                const x = padding.left + (i * xStep);
                const y = padding.top + plotHeight - (val / 1000000 * yScale);
                return `${x},${y}`;
            }).join(' ');
            
            container.innerHTML = `
                <div style="padding: 20px; background: white; border-radius: 8px;">
                    <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">Revenue+ (12 Months)</h3>
                    
                    <svg width="${chartWidth}" height="${chartHeight}" style="display: block;">
                        <!-- Grid lines -->
                        <g class="grid">
                            ${[0,1,2,3,4,5].map(i => {
                                const y = padding.top + (i * plotHeight / 5);
                                return `<line x1="${padding.left}" y1="${y}" x2="${chartWidth - padding.right}" y2="${y}" 
                                             stroke="#e5e7eb" stroke-width="1"/>`;
                            }).join('')}
                        </g>
                        
                        <!-- Y-axis labels (in MILLIONS) -->
                        <g class="y-axis">
                            ${[0,1,2,3,4,5].map(i => {
                                const y = padding.top + (i * plotHeight / 5);
                                const value = yMax - (i * yMax / 5);
                                return `<text x="${padding.left - 10}" y="${y + 5}" 
                                             text-anchor="end" font-size="14" fill="#6b7280">
                                    $${value.toFixed(1)}M
                                </text>`;
                            }).join('')}
                        </g>
                        
                        <!-- X-axis labels -->
                        <g class="x-axis">
                            ${last12Months.map((month, i) => {
                                const x = padding.left + (i * xStep);
                                return `<text x="${x}" y="${chartHeight - 15}" 
                                             text-anchor="middle" font-size="12" fill="#6b7280">
                                    ${month.split('-')[0]}
                                </text>`;
                            }).join('')}
                        </g>
                        
                        <!-- Lines -->
                        <polyline points="${grossPoints}" 
                                 fill="none" stroke="#60a5fa" stroke-width="3"/>
                        <polyline points="${netPoints}" 
                                 fill="none" stroke="#34d399" stroke-width="3"/>
                        
                        <!-- Data points with labels -->
                        ${last12Gross.map((val, i) => {
                            const x = padding.left + (i * xStep);
                            const y = padding.top + plotHeight - (val / 1000000 * yScale);
                            return `
                                <circle cx="${x}" cy="${y}" r="5" fill="#60a5fa">
                                    <title>${last12Months[i]} Gross: $${(val/1000000).toFixed(2)}M</title>
                                </circle>
                                <text x="${x}" y="${y - 8}" text-anchor="middle" font-size="11" fill="#60a5fa" 
                                      class="data-label" style="display: none;">
                                    $${(val/1000000).toFixed(1)}M
                                </text>
                            `;
                        }).join('')}
                        
                        ${last12Net.map((val, i) => {
                            const x = padding.left + (i * xStep);
                            const y = padding.top + plotHeight - (val / 1000000 * yScale);
                            return `
                                <circle cx="${x}" cy="${y}" r="5" fill="#34d399">
                                    <title>${last12Months[i]} Net: $${(val/1000000).toFixed(2)}M</title>
                                </circle>
                                <text x="${x}" y="${y + 20}" text-anchor="middle" font-size="11" fill="#34d399"
                                      class="data-label" style="display: none;">
                                    $${(val/1000000).toFixed(1)}M
                                </text>
                            `;
                        }).join('')}
                    </svg>
                    
                    <!-- Legend -->
                    <div style="display: flex; gap: 30px; margin-top: 15px; justify-content: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 3px; background: #60a5fa;"></div>
                            <span style="font-size: 14px;">Gross Revenue</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 3px; background: #34d399;"></div>
                            <span style="font-size: 14px;">Net Revenue</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Apply data labels visibility based on checkbox
            const dataLabelsEnabled = document.getElementById('dataLabelsToggle')?.checked;
            if (dataLabelsEnabled) {
                container.querySelectorAll('.data-label').forEach(label => {
                    label.style.display = 'block';
                });
            }
            
            // Auto-scroll chart to right on narrow screens
            if (window.innerWidth <= 700) {
                setTimeout(() => {
                    container.scrollLeft = container.scrollWidth;
                }, 100);
            }
        }
        
        // Chart display controller
        function updateChartDisplay(chartType) {
            AppSounds.play('navigate');
            console.log('Switching to chart:', chartType);
            
            if (chartType === 'ytd') {
                updateYTDStackedChart();
            } else if (chartType === '12months') {
                updateMonthlyRevenueChart();
            }
        }
        
        // YTD Stacked Area Chart
        function updateYTDStackedChart() {
            console.log('=== YTD STACKED CHART ===');
            
            const container = document.getElementById('monthly-chart-container');
            if (!container) return;
            
            // Clear everything
            container.innerHTML = '';
            
            // Get the Monthly data
            if (!window.VanguardData?.data?.scMonthly && !window.VanguardData?.data?.rwcMonthly) {
                container.innerHTML = '<div style="padding: 20px;">No Monthly data available</div>';
                return;
            }
            
            // Get current year (2025 based on user saying "we are in august 2025")
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            
            // Build YTD data array - only current year months
            const months = [];
            const grossValues = [];
            const netValues = [];
            
            // Process monthly data based on location filter
            const scMonthly = window.VanguardData.data.scMonthly;
            const rwcMonthly = window.VanguardData.data.rwcMonthly;
            const monthData = {};
            
            // Get SC Monthly columns if needed
            if (chartLocationFilter !== 'RWC' && scMonthly?.columns) {
                scMonthly.columns.forEach(col => {
                    if (col.header && col.data) {
                        // Skip Total and Average columns
                        const headerLower = col.header.toLowerCase();
                        if (headerLower.includes('total') || headerLower.includes('average')) {
                            return;
                        }
                        
                        // Check if this is current year (YTD)
                        // Assuming format is "Jan-25" or similar
                        if (col.header.includes('-25') || col.header.includes('2025')) {
                            const gross = col.data?.row12?.value || 0;
                            const net = col.data?.row31?.value || 0;
                            
                            if (!monthData[col.header]) {
                                monthData[col.header] = { gross: 0, net: 0 };
                            }
                            monthData[col.header].gross += parseFloat(gross) || 0;
                            monthData[col.header].net += parseFloat(net) || 0;
                        }
                    }
                });
            }
            
            // Get RWC Monthly columns if needed
            if (chartLocationFilter !== 'SC' && rwcMonthly?.columns) {
                rwcMonthly.columns.forEach(col => {
                    if (col.header && col.data) {
                        // Skip Total and Average columns
                        const headerLower = col.header.toLowerCase();
                        if (headerLower.includes('total') || headerLower.includes('average')) {
                            return;
                        }
                        
                        // Check if this is current year (YTD)
                        if (col.header.includes('-25') || col.header.includes('2025')) {
                            const gross = col.data?.row12?.value || 0;
                            const net = col.data?.row31?.value || 0;
                            
                            if (!monthData[col.header]) {
                                monthData[col.header] = { gross: 0, net: 0 };
                            }
                            
                            if (chartLocationFilter === 'combined') {
                                // Add to existing SC data
                                monthData[col.header].gross += parseFloat(gross) || 0;
                                monthData[col.header].net += parseFloat(net) || 0;
                            } else {
                                // Replace with RWC data
                                monthData[col.header].gross = parseFloat(gross) || 0;
                                monthData[col.header].net = parseFloat(net) || 0;
                            }
                        }
                    }
                });
            }
            
            // Convert monthData to arrays
            const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            Object.keys(monthData).sort((a, b) => {
                const aMonth = a.split('-')[0];
                const bMonth = b.split('-')[0];
                return monthOrder.indexOf(aMonth) - monthOrder.indexOf(bMonth);
            }).forEach(month => {
                months.push(month);
                grossValues.push(monthData[month].gross);
                netValues.push(monthData[month].net);
            });
            
            if (months.length === 0) {
                container.innerHTML = '<div style="padding: 20px;">No YTD data to display</div>';
                return;
            }
            
            // Calculate cumulative values for stacked area
            const cumulativeGross = [];
            const cumulativeNet = [];
            let runningGross = 0;
            let runningNet = 0;
            
            for (let i = 0; i < grossValues.length; i++) {
                runningGross += grossValues[i];
                runningNet += netValues[i];
                cumulativeGross.push(runningGross);
                cumulativeNet.push(runningNet);
            }
            
            // Find max for scale
            const maxValue = Math.max(...cumulativeGross, 100000);
            
            // Create SVG STACKED AREA CHART with values in MILLIONS
            const chartWidth = 800;
            const chartHeight = 300;
            const padding = { top: 20, right: 20, bottom: 50, left: 80 };
            const plotWidth = chartWidth - padding.left - padding.right;
            const plotHeight = chartHeight - padding.top - padding.bottom;
            
            // Scale values to millions
            const maxValueM = maxValue / 1000000;
            const yMax = Math.ceil(maxValueM * 1.1);
            
            // Create points for stacked area chart
            const xStep = plotWidth / Math.max(months.length - 1, 1);
            const yScale = plotHeight / yMax;
            
            // Create area paths
            let grossAreaPath = `M ${padding.left} ${padding.top + plotHeight}`;
            let netAreaPath = `M ${padding.left} ${padding.top + plotHeight}`;
            
            // Build gross area (bottom layer)
            cumulativeGross.forEach((val, i) => {
                const x = padding.left + (i * xStep);
                const y = padding.top + plotHeight - (val / 1000000 * yScale);
                grossAreaPath += ` L ${x} ${y}`;
            });
            // Close the path
            grossAreaPath += ` L ${padding.left + (months.length - 1) * xStep} ${padding.top + plotHeight} Z`;
            
            // Build net area (top layer) 
            cumulativeNet.forEach((val, i) => {
                const x = padding.left + (i * xStep);
                const y = padding.top + plotHeight - (val / 1000000 * yScale);
                netAreaPath += ` L ${x} ${y}`;
            });
            // Close the path
            netAreaPath += ` L ${padding.left + (months.length - 1) * xStep} ${padding.top + plotHeight} Z`;
            
            // Calculate YTD totals for display
            const ytdGross = cumulativeGross[cumulativeGross.length - 1] || 0;
            const ytdNet = cumulativeNet[cumulativeNet.length - 1] || 0;
            
            container.innerHTML = `
                <div style="padding: 20px; background: white; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">YTD Gross and Net Revenue</h3>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #64748b;">YTD Gross</div>
                                <div style="font-size: 20px; font-weight: 700; color: #60a5fa;">$${(ytdGross/1000000).toFixed(2)}M</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #64748b;">YTD Net</div>
                                <div style="font-size: 20px; font-weight: 700; color: #34d399;">$${(ytdNet/1000000).toFixed(2)}M</div>
                            </div>
                        </div>
                    </div>
                    
                    <svg width="${chartWidth}" height="${chartHeight}" style="display: block;">
                        <!-- Grid lines -->
                        <g class="grid">
                            ${[0,1,2,3,4,5].map(i => {
                                const y = padding.top + (i * plotHeight / 5);
                                return `<line x1="${padding.left}" y1="${y}" x2="${chartWidth - padding.right}" y2="${y}" 
                                             stroke="#e5e7eb" stroke-width="1"/>`;
                            }).join('')}
                        </g>
                        
                        <!-- Y-axis labels (in MILLIONS) -->
                        <g class="y-axis">
                            ${[0,1,2,3,4,5].map(i => {
                                const y = padding.top + (i * plotHeight / 5);
                                const value = yMax - (i * yMax / 5);
                                return `<text x="${padding.left - 10}" y="${y + 5}" 
                                             text-anchor="end" font-size="14" fill="#6b7280">
                                    $${value.toFixed(1)}M
                                </text>`;
                            }).join('')}
                        </g>
                        
                        <!-- X-axis labels -->
                        <g class="x-axis">
                            ${months.map((month, i) => {
                                const x = padding.left + (i * xStep);
                                return `<text x="${x}" y="${chartHeight - 15}" 
                                             text-anchor="middle" font-size="12" fill="#6b7280">
                                    ${month.split('-')[0]}
                                </text>`;
                            }).join('')}
                        </g>
                        
                        <!-- Stacked areas -->
                        <path d="${grossAreaPath}" fill="#60a5fa" opacity="0.3"/>
                        <path d="${netAreaPath}" fill="#34d399" opacity="0.5"/>
                        
                        <!-- Lines on top of areas -->
                        <polyline points="${cumulativeGross.map((val, i) => {
                            const x = padding.left + (i * xStep);
                            const y = padding.top + plotHeight - (val / 1000000 * yScale);
                            return `${x},${y}`;
                        }).join(' ')}" 
                                 fill="none" stroke="#60a5fa" stroke-width="2"/>
                        <polyline points="${cumulativeNet.map((val, i) => {
                            const x = padding.left + (i * xStep);
                            const y = padding.top + plotHeight - (val / 1000000 * yScale);
                            return `${x},${y}`;
                        }).join(' ')}" 
                                 fill="none" stroke="#34d399" stroke-width="2"/>
                        
                        <!-- Data points with labels if enabled -->
                        ${cumulativeGross.map((val, i) => {
                            const x = padding.left + (i * xStep);
                            const y = padding.top + plotHeight - (val / 1000000 * yScale);
                            return `
                                <circle cx="${x}" cy="${y}" r="4" fill="#60a5fa">
                                    <title>${months[i]} Gross Total: $${(val/1000000).toFixed(2)}M</title>
                                </circle>
                                <text x="${x}" y="${y - 8}" text-anchor="middle" font-size="11" fill="#60a5fa" 
                                      class="data-label" style="display: none;">
                                    $${(val/1000000).toFixed(1)}M
                                </text>
                            `;
                        }).join('')}
                        
                        ${cumulativeNet.map((val, i) => {
                            const x = padding.left + (i * xStep);
                            const y = padding.top + plotHeight - (val / 1000000 * yScale);
                            return `
                                <circle cx="${x}" cy="${y}" r="4" fill="#34d399">
                                    <title>${months[i]} Net Total: $${(val/1000000).toFixed(2)}M</title>
                                </circle>
                                <text x="${x}" y="${y - 8}" text-anchor="middle" font-size="11" fill="#34d399"
                                      class="data-label" style="display: none;">
                                    $${(val/1000000).toFixed(1)}M
                                </text>
                            `;
                        }).join('')}
                    </svg>
                    
                    <!-- Legend -->
                    <div style="display: flex; gap: 30px; margin-top: 15px; justify-content: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 12px; background: #60a5fa; opacity: 0.3;"></div>
                            <span style="font-size: 14px;">Cumulative Gross Revenue</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 12px; background: #34d399; opacity: 0.5;"></div>
                            <span style="font-size: 14px;">Cumulative Net Revenue</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Apply data labels visibility based on checkbox
            const dataLabelsEnabled = document.getElementById('dataLabelsToggle')?.checked;
            if (dataLabelsEnabled) {
                container.querySelectorAll('.data-label').forEach(label => {
                    label.style.display = 'block';
                });
            }
            
            // Auto-scroll chart to right on narrow screens
            if (window.innerWidth <= 700) {
                setTimeout(() => {
                    container.scrollLeft = container.scrollWidth;
                }, 100);
            }
        }
        
        // Keep switchChart as an alias for compatibility
        function switchChart(chartType) {
            // Now always shows revenue chart from Monthly data
            updateMonthlyRevenueChart();
        }

        function switchDonutChart(chartType) {
            console.log('Switching to chart:', chartType);
            const revenueDonut = document.getElementById('revenueDonut');
            const payoutsDonut = document.getElementById('payoutsDonut');
            // Find the chart title that's a sibling of the donutSelector
            const donutSelector = document.getElementById('donutSelector');
            const chartTitle = donutSelector ? donutSelector.parentElement.querySelector('.chart-title') : null;
            
            if (chartType === 'revenue') {
                revenueDonut.style.display = 'block';
                payoutsDonut.style.display = 'none';
                // Update title
                if (chartTitle) {
                    chartTitle.textContent = 'Revenue Distribution';
                }
                // Update revenue chart if EventManager exists
                if (window.EventManager && window.EventManager.currentEvent) {
                    window.EventManager.updateRevenueDistribution();
                }
            } else {
                revenueDonut.style.display = 'none';
                payoutsDonut.style.display = 'block';
                // Update title
                if (chartTitle) {
                    chartTitle.textContent = 'Payout Distribution';
                }
                // Update payout chart if EventManager exists
                if (window.EventManager && window.EventManager.currentEvent) {
                    window.EventManager.updatePayoutDistribution();
                }
            }
        }

        // Dashboard View Functions
        function selectLocation(location) {
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const santaClaraCard = document.getElementById('santa-clara-card');
            const redwoodCityCard = document.getElementById('redwood-city-card');
            
            if (location === 'combined') {
                santaClaraCard.style.opacity = '1';
                santaClaraCard.style.filter = 'none';
                redwoodCityCard.style.opacity = '1';
                redwoodCityCard.style.filter = 'none';
            } else if (location === 'santa-clara') {
                santaClaraCard.style.opacity = '1';
                santaClaraCard.style.filter = 'none';
                redwoodCityCard.style.opacity = '0.4';
                redwoodCityCard.style.filter = 'grayscale(50%)';
            } else if (location === 'redwood-city') {
                santaClaraCard.style.opacity = '0.4';
                santaClaraCard.style.filter = 'grayscale(50%)';
                redwoodCityCard.style.opacity = '1';
                redwoodCityCard.style.filter = 'none';
            }
        }

        function selectPeriod(period) {
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function filterByDay(day) {
            const dayFilter = document.getElementById('dayFilter');
            if (day !== 'all') {
                dayFilter.style.borderColor = '#667eea';
                dayFilter.style.boxShadow = '0 0 0 2px rgba(102, 126, 234, 0.2)';
            } else {
                dayFilter.style.borderColor = 'rgba(148, 163, 184, 0.3)';
                dayFilter.style.boxShadow = 'none';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-trigger')) {
                const dropdowns = document.getElementsByClassName('dropdown-menu');
                for (let dropdown of dropdowns) {
                    if (dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                    }
                }
            }
        });
        
        // Month over Month View Functions
        function toggleDayFilter(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('monthOverMonthDayFilter');
            if (dropdown) {
                if (dropdown.style.display === 'none' || !dropdown.style.display) {
                    dropdown.style.display = 'block';
                    // Add click listener to close when clicking outside
                    setTimeout(() => {
                        document.addEventListener('click', closeDayFilterOnClickOutside);
                    }, 100);
                } else {
                    dropdown.style.display = 'none';
                }
            }
        }
        
        function closeDayFilter() {
            const dropdown = document.getElementById('monthOverMonthDayFilter');
            dropdown.style.display = 'none';
            document.removeEventListener('click', closeDayFilterOnClickOutside);
        }
        
        function closeDayFilterOnClickOutside(event) {
            const dropdown = document.getElementById('monthOverMonthDayFilter');
            const button = event.target.closest('button');
            if (!dropdown.contains(event.target) && (!button || !button.onclick || !button.onclick.toString().includes('toggleDayFilter'))) {
                closeDayFilter();
            }
        }
        
        function filterDays(checkbox) {
            if (checkbox.value === 'all') {
                // If "All Days" is checked, check all other boxes
                const checkboxes = document.querySelectorAll('#monthOverMonthDayFilter input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    if (cb.value !== 'all') {
                        cb.checked = checkbox.checked;
                        // Update the monthlyDayFilters state
                        monthlyDayFilters[cb.value] = checkbox.checked;
                    }
                });
            } else {
                // Update the specific day filter
                monthlyDayFilters[checkbox.value] = checkbox.checked;
                
                // If any individual day is unchecked, uncheck "All Days"
                const allCheckbox = document.querySelector('#monthOverMonthDayFilter input[value="all"]');
                if (allCheckbox && !checkbox.checked) {
                    allCheckbox.checked = false;
                }
                
                // Check if all individual days are checked, if so check "All Days"
                const checkboxes = document.querySelectorAll('#monthOverMonthDayFilter input[type="checkbox"]:not([value="all"])');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                if (allCheckbox && allChecked) {
                    allCheckbox.checked = true;
                }
            }
            
            // Refresh the monthly view with updated filters
            const currentPeriod = document.getElementById('monthOverMonthTimePeriod')?.value || '30';
            updateMonthlyView(currentPeriod);
        }
        
        function togglePayoutsSection() {
            const details = document.getElementById('payoutsDetails');
            const toggle = document.getElementById('payoutsToggle');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                toggle.textContent = '▼';
            } else {
                details.style.display = 'none';
                toggle.textContent = '▶';
            }
        }
        
        function changeComparisonPeriod(period) {
            // Update time period logic
            console.log('Time period changed to:', period);
            updateMonthlyView(period);
        }
        
        // ============================================================
        // SECTION: REPORTING VIEW FUNCTIONS
        // ============================================================
        
        let reportingCurrentOffset = 0; // Track current scroll position (in months)
        const MONTHS_PER_VIEW = 4; // Show 4 months at a time (with spacing)
        let reportingLocationFilter = 'SC'; // Default to SC
        let reportingViewMode = 'monthly'; // 'monthly' or 'quarterly'
        
        function setReportingViewMode(mode) {
            AppSounds.play('click');
            reportingViewMode = mode;
            
            // Update button styles
            document.getElementById('viewModeMonthly').style.background = mode === 'monthly' ? '#3b82f6' : 'transparent';
            document.getElementById('viewModeMonthly').style.color = mode === 'monthly' ? 'white' : '#64748b';
            document.getElementById('viewModeQuarterly').style.background = mode === 'quarterly' ? '#3b82f6' : 'transparent';
            document.getElementById('viewModeQuarterly').style.color = mode === 'quarterly' ? 'white' : '#64748b';
            
            // Update title
            const title = document.getElementById('reportingTitle');
            if (title) {
                title.textContent = mode === 'quarterly' ? 'Quarterly Reporting Overview' : 'Monthly Reporting Overview';
            }
            
            // Don't set offset here - let the generate functions handle it
            // reportingCurrentOffset = 0;  // REMOVED
            
            // CRITICAL FIX: Reset scroll position to prevent blank space
            const container = document.getElementById('reportingMonthsContainer');
            if (container) {
                container.scrollLeft = 0;  // Reset horizontal scroll
                container.innerHTML = '<div style="padding: 20px; color: #666;">Loading...</div>';
            }
            
            // Also reset the parent container if it exists
            const parentContainer = document.querySelector('.reporting-container');
            if (parentContainer) {
                parentContainer.scrollLeft = 0;  // Reset parent scroll too
            }
            
            // Use setTimeout to ensure DOM updates properly
            setTimeout(() => {
                // Simplified check
                if (!window.VanguardData) {
                    console.log('Data not ready when switching to', mode, '- calling initializeReportingView');
                    // Try to initialize the view which will handle retries
                    initializeReportingView();
                } else {
                    // Regenerate view
                    console.log('Switching to', mode, 'view');
                    if (mode === 'quarterly') {
                        generateReportingQuarters();
                    } else {
                        generateReportingMonths();
                    }
                }
            }, 50); // Increased delay slightly for better reliability
        }
        
        function setReportingLocation(location) {
            AppSounds.play('click');
            reportingLocationFilter = location;
            
            // Update button styles
            document.getElementById('reportingLocSC').style.background = location === 'SC' ? '#3b82f6' : 'transparent';
            document.getElementById('reportingLocSC').style.color = location === 'SC' ? 'white' : '#64748b';
            
            document.getElementById('reportingLocRWC').style.background = location === 'RWC' ? '#3b82f6' : 'transparent';
            document.getElementById('reportingLocRWC').style.color = location === 'RWC' ? 'white' : '#64748b';
            
            document.getElementById('reportingLocCombined').style.background = location === 'COMBINED' ? '#3b82f6' : 'transparent';
            document.getElementById('reportingLocCombined').style.color = location === 'COMBINED' ? 'white' : '#64748b';
            
            // Don't reset scroll position - let generateReportingMonths handle auto-scrolling
            // reportingCurrentOffset = 0;  // REMOVED - auto-scroll will set this
            
            // Regenerate view based on current mode
            if (reportingViewMode === 'quarterly') {
                generateReportingQuarters();
            } else {
                generateReportingMonths();
            }
        }
        
        function initializeReportingView() {
            console.log('initializeReportingView called, mode:', reportingViewMode);
            // Simplified check - just check VanguardData exists
            if (!window.VanguardData) {
                console.log('Data not ready for reporting view - will retry');
                // Retry after a short delay
                setTimeout(() => {
                    if (window.VanguardData) {
                        console.log('Retrying reporting view initialization');
                        // Generate data based on view mode
                        if (reportingViewMode === 'quarterly') {
                            generateReportingQuarters();
                        } else {
                            generateReportingMonths();
                        }
                    }
                }, 500);
                return;
            }
            
            // Generate data based on view mode
            console.log('Generating reporting view for mode:', reportingViewMode);
            if (reportingViewMode === 'quarterly') {
                generateReportingQuarters();
            } else {
                generateReportingMonths();
            }
            
            // Add keyboard navigation
            if (!window.reportingKeyboardListenerAdded) {
                document.addEventListener('keydown', function(e) {
                    const reportingView = document.getElementById('reporting-view');
                    if (reportingView && reportingView.style.display !== 'none') {
                        if (e.key === 'ArrowLeft') {
                            scrollReportingMonths('left');
                            e.preventDefault();
                        } else if (e.key === 'ArrowRight') {
                            scrollReportingMonths('right');
                            e.preventDefault();
                        }
                    }
                });
                window.reportingKeyboardListenerAdded = true;
            }
            
            // Add touch/swipe support for mobile
            const reportingContainer = document.getElementById('reportingMonthsContainer');
            if (reportingContainer && !window.reportingSwipeListenerAdded) {
                let touchStartX = 0;
                let touchEndX = 0;
                
                reportingContainer.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });
                
                reportingContainer.addEventListener('touchend', function(e) {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, { passive: true });
                
                function handleSwipe() {
                    const swipeThreshold = 50; // Minimum distance for swipe
                    const diff = touchStartX - touchEndX;
                    
                    if (Math.abs(diff) > swipeThreshold) {
                        if (diff > 0) {
                            // Swiped left, scroll right
                            scrollReportingMonths('right');
                        } else {
                            // Swiped right, scroll left
                            scrollReportingMonths('left');
                        }
                    }
                }
                
                window.reportingSwipeListenerAdded = true;
            }
        }
        
        function scrollReportingMonths(direction) {
            AppSounds.play('navigate');
            const container = document.getElementById('reportingMonthsContainer');
            if (!container) return;
            
            // Get total columns including projection
            const totalColumns = container.children.length;
            
            if (direction === 'left') {
                // Allow scrolling all the way to the left
                reportingCurrentOffset = Math.max(-2, reportingCurrentOffset - 1); // Allow 2 positions before 0
            } else {
                // Allow scrolling further to the right to see all content
                const maxOffset = Math.max(0, totalColumns - 2); // Allow scrolling to see last 2 columns
                reportingCurrentOffset = Math.min(maxOffset, reportingCurrentOffset + 1);
            }
            
            // Apply transform to scroll (225px = 200px width + 25px gap)
            const translateX = reportingCurrentOffset * -225; // Each month column + gap
            container.style.transform = `translateX(${translateX}px)`;
            
            // Update month range display
            updateReportingMonthRange();
        }
        
        function getAvailableMonths() {
            // Get all unique months from events data
            let events = window.VanguardData.getAllEvents();
            console.log('Total events before filtering:', events.length);
            
            // Filter by location if not COMBINED
            if (reportingLocationFilter === 'SC') {
                events = events.filter(e => e.location === 'SC');
            } else if (reportingLocationFilter === 'RWC') {
                events = events.filter(e => e.location === 'RWC');
            }
            // COMBINED uses all events
            console.log('Events after location filter:', events.length, 'Location filter:', reportingLocationFilter);
            
            const monthsMap = new Map();
            
            events.forEach(event => {
                let date;
                
                // Use dateValue if available (the actual date string), otherwise use date
                const dateSource = event.dateValue || event.date;
                
                // Check if it's already a Date object
                if (dateSource instanceof Date && !isNaN(dateSource.getTime())) {
                    date = dateSource;
                } else if (typeof dateSource === 'string') {
                    // Parse date: "08/10/2024" or "08/10/2024 Late" or "11/26/2024"
                    const dateStr = dateSource.replace(/\s+(Late|PM)/gi, '').trim();
                    
                    if (dateStr.includes('/')) {
                        const [month, day, year] = dateStr.split('/').map(Number);
                        // Handle 2-digit years (assume 2000s)
                        const fullYear = year < 100 ? 2000 + year : year;
                        date = new Date(fullYear, month - 1, day);
                    } else {
                        // Try parsing as a standard date string
                        date = new Date(dateStr);
                    }
                } else {
                    console.error('Unexpected date format:', dateSource, 'from event:', event);
                    return;
                }
                
                if (isNaN(date.getTime())) {
                    console.error('Could not parse date:', dateSource, 'from event:', event);
                    return;
                }
                
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                if (!monthsMap.has(monthKey)) {
                    monthsMap.set(monthKey, {
                        key: monthKey,
                        name: monthName,
                        year: date.getFullYear(),
                        month: date.getMonth(),
                        events: []
                    });
                }
                monthsMap.get(monthKey).events.push(event);
            });
            
            // Sort by date (oldest first for proper financial reporting - oldest left, newest right)
            return Array.from(monthsMap.values()).sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.month - b.month;
            });
        }
        
        function getAvailableQuarters() {
            const months = getAvailableMonths();
            const quartersMap = new Map();
            
            months.forEach(month => {
                // month.month is 0-11 (JavaScript months)
                // Q1: 0-2 (Jan-Mar), Q2: 3-5 (Apr-Jun), Q3: 6-8 (Jul-Sep), Q4: 9-11 (Oct-Dec)
                const quarter = Math.floor(month.month / 3) + 1;
                const quarterKey = `${month.year}-Q${quarter}`;
                const quarterName = `Q${quarter} ${month.year}`;
                
                if (!quartersMap.has(quarterKey)) {
                    quartersMap.set(quarterKey, {
                        key: quarterKey,
                        name: quarterName,
                        year: month.year,
                        quarter: quarter,  // This is now 1-4
                        events: [],
                        months: []
                    });
                }
                
                // Add all events from this month to the quarter
                month.events.forEach(event => {
                    quartersMap.get(quarterKey).events.push(event);
                });
                
                // Track which months are in this quarter
                quartersMap.get(quarterKey).months.push(month.name);
            });
            
            // Sort by date (oldest first)
            return Array.from(quartersMap.values()).sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.quarter - b.quarter;
            });
        }
        
        function generateReportingMonths() {
            console.log('generateReportingMonths called');
            const container = document.getElementById('reportingMonthsContainer');
            if (!container) {
                console.error('reportingMonthsContainer not found!');
                return;
            }
            
            // Debug: Check what data we have
            const allEvents = window.VanguardData.getAllEvents();
            console.log('DEBUG - All events count:', allEvents.length);
            console.log('DEBUG - SC events:', allEvents.filter(e => e.location === 'SC').length);
            console.log('DEBUG - RWC events:', allEvents.filter(e => e.location === 'RWC').length);
            console.log('DEBUG - Current filter:', reportingLocationFilter);
            
            const months = getAvailableMonths();
            console.log('Available months:', months.length, months);
            
            // Log event counts per month
            months.forEach(m => {
                console.log(`Month ${m.name}: ${m.events.length} events`);
            });
            
            container.innerHTML = '';
            
            if (months.length === 0) {
                console.error('No months available to display!');
                container.innerHTML = `<div style="padding: 20px; color: #666;">No data available for ${reportingLocationFilter} location.</div>`;
                return;
            }
            
            // Calculate metrics for all months first to enable comparisons
            const monthsWithMetrics = months.map(monthData => ({
                ...monthData,
                metrics: calculateMonthMetrics(monthData.events)
            }));
            console.log('Months with metrics:', monthsWithMetrics.length);
            
            monthsWithMetrics.forEach((monthData, index) => {
                const prevMonth = index > 0 ? monthsWithMetrics[index - 1] : null;
                const monthColumn = createMonthColumn(monthData, prevMonth);
                container.appendChild(monthColumn);
            });
            
            // Add projection column for the latest month if it's partial
            if (monthsWithMetrics.length > 0) {
                const lastMonth = monthsWithMetrics[monthsWithMetrics.length - 1];
                const projectionColumn = createProjectionColumn(lastMonth);
                if (projectionColumn) {
                    container.appendChild(projectionColumn);
                }
            }
            
            // AUTO-SCROLL TO SHOW MOST RECENT MONTHS (right-aligned minus 2)
            // Calculate the offset to show the last months with projection on the right
            const totalColumns = monthsWithMetrics.length + (createProjectionColumn(monthsWithMetrics[monthsWithMetrics.length - 1]) ? 1 : 0);
            if (totalColumns > MONTHS_PER_VIEW) {
                // Set offset to show the last 4 columns minus 2 (showing 2 more months on the left)
                reportingCurrentOffset = Math.max(0, totalColumns - MONTHS_PER_VIEW - 2);
                
                // Apply transform to scroll (225px = 200px width + 25px gap)
                const translateX = reportingCurrentOffset * -225;
                container.style.transform = `translateX(${translateX}px)`;
            }
            
            // Update month range display
            updateReportingMonthRange();
        }
        
        // Quarterly view implementation
        function generateReportingQuarters() {
            console.log('generateReportingQuarters called');
            const container = document.getElementById('reportingMonthsContainer');
            if (!container) {
                console.error('reportingMonthsContainer not found!');
                return;
            }
            
            // Simplified data check - just check if VanguardData exists
            if (!window.VanguardData) {
                console.log('VanguardData not ready for quarterly view');
                container.innerHTML = `<div style="padding: 20px; color: #666;">Loading data...</div>`;
                setTimeout(() => {
                    if (window.VanguardData) {
                        generateReportingQuarters(); // Retry
                    }
                }, 500);
                return;
            }
            
            const quarters = getAvailableQuarters();
            console.log('Available quarters:', quarters.length, quarters);
            
            // Clear container
            container.innerHTML = '';
            
            if (quarters.length === 0) {
                console.log('No quarters found - checking why...');
                const months = getAvailableMonths();
                console.log('Available months:', months.length);
                if (months.length === 0) {
                    console.log('No months available either - checking events...');
                    try {
                        const events = window.VanguardData.getAllEvents();
                        console.log('Total events:', events ? events.length : 0);
                    } catch (e) {
                        console.error('Error getting events:', e);
                    }
                }
                container.innerHTML = `<div style="padding: 20px; color: #666;">No quarterly data available for ${reportingLocationFilter} location.</div>`;
                return;
            }
            
            // Calculate metrics for all quarters first to enable comparisons
            const quartersWithMetrics = quarters.map(quarterData => ({
                ...quarterData,
                metrics: calculateMonthMetrics(quarterData.events) // Reuse the same metrics calculation
            }));
            
            quartersWithMetrics.forEach((quarterData, index) => {
                const prevQuarter = index > 0 ? quartersWithMetrics[index - 1] : null;
                const quarterColumn = createQuarterColumn(quarterData, prevQuarter);
                container.appendChild(quarterColumn);
            });
            
            // Add % of quarter projection for the latest quarter if it's partial
            const lastQuarter = quartersWithMetrics[quartersWithMetrics.length - 1];
            if (lastQuarter) {
                const quarterProjection = createQuarterProjection(lastQuarter);
                if (quarterProjection) {
                    container.appendChild(quarterProjection);
                }
                
                // Yearly projection removed per request
            }
            
            // QUARTERLY VIEW: Always start LEFT-ALIGNED (offset = 0)
            reportingCurrentOffset = 0;
            container.style.transform = 'translateX(0px)';
            
            // Update range display
            updateReportingQuarterRange();
        }
        
        function createQuarterColumn(quarterData, prevQuarter) {
            const metrics = quarterData.metrics || calculateMonthMetrics(quarterData.events);
            
            // Calculate percentage changes from previous quarter
            const getPercentChange = (current, previous) => {
                if (!previous || previous === 0) return null;
                return ((current - previous) / previous * 100);
            };
            
            const changes = prevQuarter ? {
                totalSales: getPercentChange(metrics.totalSales, prevQuarter.metrics.totalSales),
                totalPayouts: getPercentChange(metrics.totalPayouts, prevQuarter.metrics.totalPayouts),
                netSales: getPercentChange(metrics.netSales, prevQuarter.metrics.netSales),
                attendance: getPercentChange(metrics.attendance, prevQuarter.metrics.attendance),
                margin: metrics.margin - prevQuarter.metrics.margin,
                rpa: getPercentChange(metrics.rpa, prevQuarter.metrics.rpa),
                profitPerEvent: getPercentChange(metrics.netSales / metrics.eventCount, prevQuarter.metrics.netSales / prevQuarter.metrics.eventCount),
                // Product changes
                flashPercent: (metrics.flash/metrics.totalSales*100) - (prevQuarter.metrics.flash/prevQuarter.metrics.totalSales*100),
                stripPercent: (metrics.strips/metrics.totalSales*100) - (prevQuarter.metrics.strips/prevQuarter.metrics.totalSales*100),
                flashSales: getPercentChange(metrics.flash, prevQuarter.metrics.flash),
                stripSales: getPercentChange(metrics.strips, prevQuarter.metrics.strips),
                flashPayouts: getPercentChange(metrics.flashPayouts, prevQuarter.metrics.flashPayouts),
                stripPayouts: getPercentChange(metrics.stripPayouts, prevQuarter.metrics.stripPayouts),
                flashNet: getPercentChange((metrics.flash - metrics.flashPayouts), (prevQuarter.metrics.flash - prevQuarter.metrics.flashPayouts)),
                stripNet: getPercentChange((metrics.strips - metrics.stripPayouts), (prevQuarter.metrics.strips - prevQuarter.metrics.stripPayouts)),
                flashMargin: (metrics.flash > 0 ? ((metrics.flash - metrics.flashPayouts)/metrics.flash*100) : 0) - 
                             (prevQuarter.metrics.flash > 0 ? ((prevQuarter.metrics.flash - prevQuarter.metrics.flashPayouts)/prevQuarter.metrics.flash*100) : 0),
                stripMargin: (metrics.strips > 0 ? ((metrics.strips - metrics.stripPayouts)/metrics.strips*100) : 0) - 
                             (prevQuarter.metrics.strips > 0 ? ((prevQuarter.metrics.strips - prevQuarter.metrics.stripPayouts)/prevQuarter.metrics.strips*100) : 0),
                flashRPA: getPercentChange((metrics.flash/metrics.attendance), (prevQuarter.metrics.flash/prevQuarter.metrics.attendance)),
                stripRPA: getPercentChange((metrics.strips/metrics.attendance), (prevQuarter.metrics.strips/prevQuarter.metrics.attendance))
            } : {};
            
            const formatChange = (change, isMargin = false) => {
                if (change === null || change === undefined) return '';
                const arrow = change > 0 ? '↑' : change < 0 ? '↓' : '→';
                const color = change > 0 ? '#16a34a' : change < 0 ? '#dc2626' : '#6b7280';
                const unit = isMargin ? 'pp' : '%';
                return `<span style="font-size: 10px; color: ${color}; font-weight: 600;">${arrow} ${Math.abs(change).toFixed(1)}${unit}</span>`;
            };
            
            const quarterDiv = document.createElement('div');
            quarterDiv.style.cssText = 'width: 200px; flex-shrink: 0;';
            
            // Reuse month column HTML structure but with quarter-specific data
            quarterDiv.innerHTML = `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <!-- Quarter Header -->
                    <div style="background: #f8fafc; padding: 10px; border-bottom: 1px solid #e5e7eb;">
                        <div style="font-size: 14px; font-weight: 600; color: #1e293b;">${quarterData.name}</div>
                        <div style="font-size: 11px; color: #64748b;">${quarterData.events.length} Events</div>
                        <div style="font-size: 9px; color: #94a3b8;">${quarterData.months.join(', ')}</div>
                    </div>
                    
                    <!-- Total Sales Box -->
                    <div onclick="toggleReportingSection('${quarterData.key}', 'total-sales', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #eff6ff, #dbeafe); position: relative;">
                        <div style="font-size: 11px; color: #1e40af; text-transform: uppercase; font-weight: 600;">Total Sales</div>
                        <div style="font-size: 18px; font-weight: 700; color: #2563eb;">$${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        ${changes.totalSales !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.totalSales)}</div>` : ''}
                        <div class="expansion-${quarterData.key}-total-sales" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #93c5fd;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #1e40af;"><span style="font-weight: 600;">Flash:</span> $${metrics.flash.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${(metrics.flash/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #1e40af;"><span style="font-weight: 600;">Strips:</span> $${metrics.strips.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${(metrics.strips/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #1e40af;"><span style="font-weight: 600;">Paper:</span> $${metrics.paper.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${(metrics.paper/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #1e40af;"><span style="font-weight: 600;">Cherries:</span> $${metrics.cherries.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${(metrics.cherries/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #1e40af; margin-top: 4px; padding-top: 4px; border-top: 1px solid #93c5fd;"><span style="font-weight: 600;">Total Events:</span> ${metrics.eventCount}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Payouts Box -->
                    <div onclick="toggleReportingSection('${quarterData.key}', 'total-payouts', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #fef2f2, #fee2e2); position: relative;">
                        <div style="font-size: 11px; color: #991b1b; text-transform: uppercase; font-weight: 600;">Total Payouts</div>
                        <div style="font-size: 18px; font-weight: 700; color: #dc2626;">$${metrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        ${changes.totalPayouts !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.totalPayouts)}</div>` : ''}
                        <div class="expansion-${quarterData.key}-total-payouts" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #fca5a5;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #991b1b;"><span style="font-weight: 600;">Strip Payouts:</span> $${(metrics.stripPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${((metrics.stripPayouts || 0)/metrics.totalPayouts*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #991b1b;"><span style="font-weight: 600;">Paper Payouts:</span> $${(metrics.paperPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${((metrics.paperPayouts || 0)/metrics.totalPayouts*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #991b1b;"><span style="font-weight: 600;">Flash Payouts:</span> $${(metrics.flashPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${((metrics.flashPayouts || 0)/metrics.totalPayouts*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #991b1b; margin-top: 4px; padding-top: 4px; border-top: 1px solid #fca5a5;"><span style="font-weight: 600;">Payout %:</span> ${(metrics.totalPayouts/metrics.totalSales*100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Net Sales Box -->
                    <div onclick="toggleReportingSection('${quarterData.key}', 'net-sales', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #f0fdf4, #dcfce7); position: relative;">
                        <div style="font-size: 11px; color: #166534; text-transform: uppercase; font-weight: 600;">Net Sales</div>
                        <div style="font-size: 18px; font-weight: 700; color: #10b981;">$${metrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        ${changes.netSales !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.netSales)}</div>` : ''}
                        <div class="expansion-${quarterData.key}-net-sales" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #86efac;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #166534;"><span style="font-weight: 600;">Total Sales:</span> $${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #166534;"><span style="font-weight: 600;">Total Payouts:</span> $${metrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #166534;"><span style="font-weight: 600;">Margin:</span> ${metrics.margin.toFixed(1)}%</div>
                                <div style="font-size: 10px; color: #166534; margin-top: 4px; padding-top: 4px; border-top: 1px solid #86efac;"><span style="font-weight: 600;">Avg/Event:</span> $${(metrics.netSales / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Products Box - Purple background -->
                    <div onclick="toggleReportingSection('${quarterData.key}', 'products', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #faf5ff, #f3e8ff); position: relative;">
                        <div style="font-size: 11px; color: #581c87; text-transform: uppercase; font-weight: 600;">Products</div>
                        <div style="font-size: 12px; font-weight: 600; color: #8b5cf6; line-height: 1.3;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Flash: ${((metrics.flash || 0)/metrics.totalSales*100).toFixed(1)}%</span>
                                ${changes.flashPercent !== undefined ? `<span style="font-size: 10px; color: ${changes.flashPercent > 0 ? '#16a34a' : changes.flashPercent < 0 ? '#dc2626' : '#6b7280'}; font-weight: 600;">${changes.flashPercent > 0 ? '↑' : changes.flashPercent < 0 ? '↓' : '→'} ${Math.abs(changes.flashPercent).toFixed(1)}pp</span>` : ''}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Strip: ${((metrics.strips || 0)/metrics.totalSales*100).toFixed(1)}%</span>
                                ${changes.stripPercent !== undefined ? `<span style="font-size: 10px; color: ${changes.stripPercent > 0 ? '#16a34a' : changes.stripPercent < 0 ? '#dc2626' : '#6b7280'}; font-weight: 600;">${changes.stripPercent > 0 ? '↑' : changes.stripPercent < 0 ? '↓' : '→'} ${Math.abs(changes.stripPercent).toFixed(1)}pp</span>` : ''}
                            </div>
                        </div>
                        <div class="expansion-${quarterData.key}-products" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #d8b4fe;">
                            <div style="display: grid; gap: 6px;">
                                <!-- Flash Details -->
                                <div style="background: rgba(139, 92, 246, 0.05); padding: 8px; border-radius: 4px;">
                                    <div style="font-size: 11px; font-weight: 600; color: #581c87; margin-bottom: 4px;">Flash</div>
                                    <div style="font-size: 10px; color: #581c87; display: grid; gap: 2px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Sales:</span>
                                            <span>
                                                $${(metrics.flash || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                ${changes.flashSales !== undefined ? `<span style="color: ${changes.flashSales > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px; font-size: 9px;">${changes.flashSales > 0 ? '↑' : '↓'}${Math.abs(changes.flashSales).toFixed(0)}%</span>` : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Payouts:</span>
                                            <span>
                                                $${(metrics.flashPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                ${changes.flashPayouts !== undefined ? `<span style="color: ${changes.flashPayouts > 0 ? '#dc2626' : '#16a34a'}; margin-left: 4px; font-size: 9px;">${changes.flashPayouts > 0 ? '↑' : '↓'}${Math.abs(changes.flashPayouts).toFixed(0)}%</span>` : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Net:</span>
                                            <span>
                                                $${((metrics.flash || 0) - (metrics.flashPayouts || 0)).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                ${changes.flashNet !== undefined ? `<span style="color: ${changes.flashNet > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px; font-size: 9px;">${changes.flashNet > 0 ? '↑' : '↓'}${Math.abs(changes.flashNet).toFixed(0)}%</span>` : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Margin:</span>
                                            <span>
                                                ${metrics.flash > 0 ? (((metrics.flash - (metrics.flashPayouts || 0))/metrics.flash)*100).toFixed(1) : 0}%
                                                ${changes.flashMargin !== undefined ? `<span style="color: ${changes.flashMargin > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px; font-size: 9px;">${changes.flashMargin > 0 ? '↑' : '↓'}${Math.abs(changes.flashMargin).toFixed(1)}pp</span>` : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>RPA:</span>
                                            <span>
                                                $${metrics.attendance > 0 ? ((metrics.flash || 0)/metrics.attendance).toFixed(2) : '0.00'}
                                                ${changes.flashRPA !== undefined ? `<span style="color: ${changes.flashRPA > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px; font-size: 9px;">${changes.flashRPA > 0 ? '↑' : '↓'}${Math.abs(changes.flashRPA).toFixed(0)}%</span>` : ''}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Strip Details -->
                                <div style="background: rgba(139, 92, 246, 0.05); padding: 8px; border-radius: 4px;">
                                    <div style="font-size: 11px; font-weight: 600; color: #581c87; margin-bottom: 4px;">Strip</div>
                                    <div style="font-size: 10px; color: #581c87; display: grid; gap: 2px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Sales:</span>
                                            <span>
                                                $${(metrics.strips || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                ${changes.stripSales !== undefined ? `<span style="color: ${changes.stripSales > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px; font-size: 9px;">${changes.stripSales > 0 ? '↑' : '↓'}${Math.abs(changes.stripSales).toFixed(0)}%</span>` : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Payouts:</span>
                                            <span>
                                                $${(metrics.stripPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                ${changes.stripPayouts !== undefined ? `<span style="color: ${changes.stripPayouts > 0 ? '#dc2626' : '#16a34a'}; margin-left: 4px; font-size: 9px;">${changes.stripPayouts > 0 ? '↑' : '↓'}${Math.abs(changes.stripPayouts).toFixed(0)}%</span>` : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Net:</span>
                                            <span>
                                                $${((metrics.strips || 0) - (metrics.stripPayouts || 0)).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                                ${changes.stripNet !== undefined ? `<span style="color: ${changes.stripNet > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px; font-size: 9px;">${changes.stripNet > 0 ? '↑' : '↓'}${Math.abs(changes.stripNet).toFixed(0)}%</span>` : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Margin:</span>
                                            <span>
                                                ${metrics.strips > 0 ? (((metrics.strips - (metrics.stripPayouts || 0))/metrics.strips)*100).toFixed(1) : 0}%
                                                ${changes.stripMargin !== undefined ? `<span style="color: ${changes.stripMargin > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px; font-size: 9px;">${changes.stripMargin > 0 ? '↑' : '↓'}${Math.abs(changes.stripMargin).toFixed(1)}pp</span>` : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>RPA:</span>
                                            <span>
                                                $${metrics.attendance > 0 ? ((metrics.strips || 0)/metrics.attendance).toFixed(2) : '0.00'}
                                                ${changes.stripRPA !== undefined ? `<span style="color: ${changes.stripRPA > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px; font-size: 9px;">${changes.stripRPA > 0 ? '↑' : '↓'}${Math.abs(changes.stripRPA).toFixed(0)}%</span>` : ''}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Margin Box -->
                    <div onclick="toggleReportingSection('${quarterData.key}', 'margin', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #fffbeb, #fef3c7); position: relative;">
                        <div style="font-size: 11px; color: #92400e; text-transform: uppercase; font-weight: 600;">Margin</div>
                        <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${(isNaN(metrics.margin) ? 0 : metrics.margin).toFixed(1)}%</div>
                        ${changes.margin !== undefined && !isNaN(changes.margin) ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.margin, true)}</div>` : ''}
                        <div class="expansion-${quarterData.key}-margin" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #fcd34d;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #92400e;"><span style="font-weight: 600;">Net Sales:</span> $${metrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #92400e;"><span style="font-weight: 600;">Total Sales:</span> $${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #92400e;"><span style="font-weight: 600;">Total Payouts:</span> $${metrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #92400e; margin-top: 4px; padding-top: 4px; border-top: 1px solid #fcd34d;"><span style="font-weight: 600;">Payout %:</span> ${(metrics.totalPayouts/metrics.totalSales*100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RPA Box -->
                    <div onclick="toggleReportingSection('${quarterData.key}', 'rpa', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #ecfeff, #cffafe); position: relative;">
                        <div style="font-size: 11px; color: #164e63; text-transform: uppercase; font-weight: 600;">RPA</div>
                        <div style="font-size: 18px; font-weight: 700; color: #06b6d4;">$${metrics.rpa.toFixed(2)}</div>
                        ${changes.rpa !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.rpa)}</div>` : ''}
                        <div class="expansion-${quarterData.key}-rpa" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #67e8f9;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Total Sales:</span> $${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Total Attendance:</span> ${metrics.attendance.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #164e63; margin-top: 4px; padding-top: 4px; border-top: 1px solid #67e8f9;">
                                    <span style="font-weight: 600;">Per Attendee Stats:</span>
                                </div>
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Sales/Attendee:</span> $${metrics.salesPerAttendee > 0 ? metrics.salesPerAttendee.toFixed(2) : metrics.attendance > 0 ? (metrics.totalSales / metrics.attendance).toFixed(2) : '0.00'}</div>
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Flash/Attendee:</span> $${metrics.flashPerAttendee > 0 ? metrics.flashPerAttendee.toFixed(2) : metrics.attendance > 0 ? (metrics.flash / metrics.attendance).toFixed(2) : '0.00'}</div>
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Strip/Attendee:</span> $${metrics.stripPerAttendee > 0 ? metrics.stripPerAttendee.toFixed(2) : metrics.attendance > 0 ? (metrics.strips / metrics.attendance).toFixed(2) : '0.00'}</div>
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Profit/Attendee:</span> $${metrics.profitPerAttendee > 0 ? metrics.profitPerAttendee.toFixed(2) : metrics.attendance > 0 ? (metrics.netSales / metrics.attendance).toFixed(2) : '0.00'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profit/Event Box -->
                    <div onclick="toggleReportingSection('${quarterData.key}', 'profit-event', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #eef2ff, #e0e7ff); position: relative;">
                        <div style="font-size: 11px; color: #312e81; text-transform: uppercase; font-weight: 600;">Profit/Event</div>
                        <div style="font-size: 18px; font-weight: 700; color: #6366f1;">$${(metrics.netSales / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        ${changes.profitPerEvent !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.profitPerEvent)}</div>` : ''}
                        <div class="expansion-${quarterData.key}-profit-event" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #a5b4fc;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #312e81;"><span style="font-weight: 600;">Net Sales:</span> $${metrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #312e81;"><span style="font-weight: 600;">Total Events:</span> ${metrics.eventCount}</div>
                                <div style="font-size: 10px; color: #312e81; margin-top: 4px; padding-top: 4px; border-top: 1px solid #a5b4fc;"><span style="font-weight: 600;">Gross/Event:</span> $${(metrics.totalSales / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #312e81;"><span style="font-weight: 600;">Payouts/Event:</span> $${(metrics.totalPayouts / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attendance Box - Teal background (moved to bottom) -->
                    <div onclick="toggleReportingSection('${quarterData.key}', 'attendance', this)" style="padding: 12px; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #f0fdfa, #ccfbf1); position: relative;">
                        <div style="font-size: 11px; color: #134e4a; text-transform: uppercase; font-weight: 600;">Attendance</div>
                        <div style="font-size: 18px; font-weight: 700; color: #14b8a6;">${metrics.attendancePercent.toFixed(1)}%</div>
                        ${changes.attendance !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.attendance)}</div>` : ''}
                        <div class="expansion-${quarterData.key}-attendance" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #5eead4;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Total Attendance:</span> ${metrics.attendance.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Total Capacity:</span> ${metrics.totalCapacity.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Total Events:</span> ${metrics.eventCount}</div>
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Avg/Event:</span> ${(metrics.attendance / metrics.eventCount).toFixed(0)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return quarterDiv;
        }
        
        function createQuarterProjection(lastQuarter) {
            // Check if we need projection for this quarter
            if (!lastQuarter.events || lastQuarter.events.length === 0) return null;
            
            // Calculate quarter date range
            const quarterStartMonth = (lastQuarter.quarter - 1) * 3;
            const quarterStart = new Date(lastQuarter.year, quarterStartMonth, 1);
            const quarterEnd = new Date(lastQuarter.year, quarterStartMonth + 3, 0);
            
            // Get missing events for the quarter
            const missingEvents = getMissingEventsForPeriod(quarterStart, quarterEnd, lastQuarter.events, reportingLocationFilter);
            
            // If no missing events, no projection needed
            if (missingEvents.length === 0) return null;
            
            // Calculate projection totals
            const projectionTotals = {
                totalSales: 0,
                totalPayouts: 0,
                netSales: 0
            };
            
            missingEvents.forEach(event => {
                projectionTotals.totalSales += event.totalSales;
                projectionTotals.totalPayouts += event.totalPayouts;
                projectionTotals.netSales += event.netSales;
            });
            
            // Add existing actuals
            const actualMetrics = lastQuarter.metrics;
            const projectedMetrics = {
                totalSales: actualMetrics.totalSales + projectionTotals.totalSales,
                totalPayouts: actualMetrics.totalPayouts + projectionTotals.totalPayouts,
                netSales: actualMetrics.netSales + projectionTotals.netSales,
                margin: ((actualMetrics.totalSales + projectionTotals.totalSales - actualMetrics.totalPayouts - projectionTotals.totalPayouts) / 
                        (actualMetrics.totalSales + projectionTotals.totalSales)) * 100
            };
            
            const projDiv = document.createElement('div');
            projDiv.style.cssText = 'width: 200px; flex-shrink: 0;';
            
            projDiv.innerHTML = `
                <div style="background: white; border: 2px dashed #10b981; border-radius: 8px; overflow: visible;">
                    <!-- Projection Header -->
                    <div style="background: white; padding: 10px; border-bottom: 1px solid #e5e7eb; position: relative;">
                        <div style="font-size: 14px; font-weight: 600; color: #374151;">Quarter Projection</div>
                        <div style="font-size: 11px; color: #6b7280;">${lastQuarter.events.length} Actual + ${missingEvents.length} Projected</div>
                        ${TooltipHelpers.createInfoIcon(`QUARTERLY PROJECTION ASSUMPTIONS:

SC Events Expected:
• 2 Saturday events per week (Early & Late)
• 2 Sunday events per week (Early & Late)
• Monday events
• Friday events

RWC Events Expected:
• Tuesday events
• Wednesday events 
• Thursday events

Averages based on all similar events from June forward.
Hover over individual metrics for detailed averages.`)}
                    </div>
                    
                    <!-- Projected Total Sales -->
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
                        <div style="font-size: 11px; color: #1e40af; text-transform: uppercase; font-weight: 600;">Projected Total Sales</div>
                        <div style="font-size: 18px; font-weight: 700; color: #1e40af;">$${projectedMetrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                            Actual: $${actualMetrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            Added: $${projectionTotals.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                    </div>
                    
                    <!-- Projected Payouts -->
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                        <div style="font-size: 11px; color: #991b1b; text-transform: uppercase; font-weight: 600;">Projected Payouts</div>
                        <div style="font-size: 18px; font-weight: 700; color: #991b1b;">$${projectedMetrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                            Actual: $${actualMetrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            Added: $${projectionTotals.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                    </div>
                    
                    <!-- Projected Net Sales -->
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">
                        <div style="font-size: 11px; color: #14532d; text-transform: uppercase; font-weight: 600;">Projected Net Sales</div>
                        <div style="font-size: 18px; font-weight: 700; color: #14532d;">$${projectedMetrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                            Actual: $${actualMetrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            Added: $${projectionTotals.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                    </div>
                    
                    <!-- Projected Margin -->
                    <div style="padding: 12px;">
                        <div style="font-size: 11px; color: #065f46; text-transform: uppercase; font-weight: 600;">Projected Margin</div>
                        <div style="font-size: 18px; font-weight: 700; color: #059669;">${projectedMetrics.margin.toFixed(1)}%</div>
                    </div>
                </div>
            `;
            
            return projDiv;
        }
        
        function createYearlyProjection(quarters) {
            // Take the last complete quarter as run rate
            const lastQuarter = quarters[quarters.length - 1];
            if (!lastQuarter) return null;
            
            const metrics = lastQuarter.metrics;
            if (!metrics) {
                console.error('No metrics found for last quarter');
                return null;
            }
            
            // Annualize the quarter (multiply by 4)
            const yearlyMetrics = {
                totalSales: metrics.totalSales * 4,
                totalPayouts: metrics.totalPayouts * 4,
                netSales: metrics.netSales * 4,
                attendance: metrics.attendance * 4,
                margin: isNaN(metrics.margin) ? 0 : metrics.margin, // Margin percentage stays the same, handle NaN
                rpa: metrics.rpa, // RPA stays the same
                eventCount: metrics.eventCount * 4
            };
            
            const projDiv = document.createElement('div');
            projDiv.style.cssText = 'width: 200px; flex-shrink: 0;';
            
            projDiv.innerHTML = `
                <div style="background: white; border: 2px solid #8b5cf6; border-radius: 8px; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 10px; border-bottom: 1px solid #7c3aed;">
                        <div style="font-size: 14px; font-weight: 600; color: white;">Yearly Projection</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.9);">Based on ${lastQuarter.name}</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.8);">Run Rate: Qtr × 4</div>
                    </div>
                    
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                        <div style="font-size: 11px; color: #1e40af; text-transform: uppercase; font-weight: 600;">Annual Sales</div>
                        <div style="font-size: 18px; font-weight: 700; color: #2563eb;">$${yearlyMetrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #1e40af; margin-top: 4px;">Qtr Avg: $${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                    </div>
                    
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #fef2f2, #fee2e2);">
                        <div style="font-size: 11px; color: #991b1b; text-transform: uppercase; font-weight: 600;">Annual Payouts</div>
                        <div style="font-size: 18px; font-weight: 700; color: #dc2626;">$${yearlyMetrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #991b1b; margin-top: 4px;">Qtr Avg: $${metrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                    </div>
                    
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                        <div style="font-size: 11px; color: #166534; text-transform: uppercase; font-weight: 600;">Annual Net</div>
                        <div style="font-size: 18px; font-weight: 700; color: #10b981;">$${yearlyMetrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #166534; margin-top: 4px;">Qtr Avg: $${metrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                    </div>
                    
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #faf5ff, #f3e8ff);">
                        <div style="font-size: 11px; color: #581c87; text-transform: uppercase; font-weight: 600;">Annual Events</div>
                        <div style="font-size: 18px; font-weight: 700; color: #8b5cf6;">${yearlyMetrics.eventCount.toFixed(0)}</div>
                        <div style="font-size: 10px; color: #581c87; margin-top: 4px;">Qtr Avg: ${metrics.eventCount}</div>
                    </div>
                    
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #fffbeb, #fef3c7);">
                        <div style="font-size: 11px; color: #92400e; text-transform: uppercase; font-weight: 600;">Est. Margin</div>
                        <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${yearlyMetrics.margin.toFixed(1)}%</div>
                        <div style="font-size: 10px; color: #92400e; margin-top: 4px;">Stays constant</div>
                    </div>
                    
                    <div style="padding: 12px; background: linear-gradient(135deg, #eef2ff, #e0e7ff);">
                        <div style="font-size: 11px; color: #312e81; text-transform: uppercase; font-weight: 600;">Annual Profit/Event</div>
                        <div style="font-size: 18px; font-weight: 700; color: #6366f1;">$${(yearlyMetrics.netSales / yearlyMetrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #312e81; margin-top: 4px;">Net: $${yearlyMetrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} / ${yearlyMetrics.eventCount} events</div>
                    </div>
                </div>
            `;
            
            return projDiv;
        }
        
        function updateReportingQuarterRange() {
            const rangeEl = document.getElementById('reportingMonthRange');
            if (!rangeEl) return;
            
            const quarters = getAvailableQuarters();
            if (quarters.length === 0) {
                rangeEl.textContent = 'No data available';
                return;
            }
            
            rangeEl.textContent = `Showing ${quarters[0].name} to ${quarters[quarters.length - 1].name}`;
        }
        
        function createMonthColumn(monthData, prevMonth) {
            // Use pre-calculated metrics or calculate if not available
            const metrics = monthData.metrics || calculateMonthMetrics(monthData.events);
            
            // Calculate percentage changes from previous month
            const getPercentChange = (current, previous) => {
                if (!previous || previous === 0) return null;
                return ((current - previous) / previous * 100);
            };
            
            const changes = prevMonth ? {
                totalSales: getPercentChange(metrics.totalSales, prevMonth.metrics.totalSales),
                totalPayouts: getPercentChange(metrics.totalPayouts, prevMonth.metrics.totalPayouts),
                netSales: getPercentChange(metrics.netSales, prevMonth.metrics.netSales),
                attendance: getPercentChange(metrics.attendance, prevMonth.metrics.attendance),
                attendancePercent: metrics.attendancePercent - prevMonth.metrics.attendancePercent, // Already a percentage, so just subtract
                margin: metrics.margin - prevMonth.metrics.margin, // Margin is already a percentage, so just subtract
                rpa: getPercentChange(metrics.rpa, prevMonth.metrics.rpa),
                profitPerEvent: getPercentChange(metrics.netSales / metrics.eventCount, prevMonth.metrics.netSales / prevMonth.metrics.eventCount),
                // Product changes
                flashPercent: (metrics.flash/metrics.totalSales*100) - (prevMonth.metrics.flash/prevMonth.metrics.totalSales*100),
                stripPercent: (metrics.strips/metrics.totalSales*100) - (prevMonth.metrics.strips/prevMonth.metrics.totalSales*100),
                flashSales: getPercentChange(metrics.flash, prevMonth.metrics.flash),
                stripSales: getPercentChange(metrics.strips, prevMonth.metrics.strips),
                flashPayouts: getPercentChange(metrics.flashPayouts, prevMonth.metrics.flashPayouts),
                stripPayouts: getPercentChange(metrics.stripPayouts, prevMonth.metrics.stripPayouts),
                flashNet: getPercentChange((metrics.flash - metrics.flashPayouts), (prevMonth.metrics.flash - prevMonth.metrics.flashPayouts)),
                stripNet: getPercentChange((metrics.strips - metrics.stripPayouts), (prevMonth.metrics.strips - prevMonth.metrics.stripPayouts)),
                flashMargin: (metrics.flash > 0 ? ((metrics.flash - metrics.flashPayouts)/metrics.flash*100) : 0) - 
                             (prevMonth.metrics.flash > 0 ? ((prevMonth.metrics.flash - prevMonth.metrics.flashPayouts)/prevMonth.metrics.flash*100) : 0),
                stripMargin: (metrics.strips > 0 ? ((metrics.strips - metrics.stripPayouts)/metrics.strips*100) : 0) - 
                             (prevMonth.metrics.strips > 0 ? ((prevMonth.metrics.strips - prevMonth.metrics.stripPayouts)/prevMonth.metrics.strips*100) : 0),
                flashRPA: getPercentChange((metrics.flash/metrics.attendance), (prevMonth.metrics.flash/prevMonth.metrics.attendance)),
                stripRPA: getPercentChange((metrics.strips/metrics.attendance), (prevMonth.metrics.strips/prevMonth.metrics.attendance))
            } : {};
            
            const formatChange = (change, isMargin = false) => {
                if (change === null || change === undefined) return '';
                const arrow = change > 0 ? '↑' : change < 0 ? '↓' : '→';
                const color = change > 0 ? '#16a34a' : change < 0 ? '#dc2626' : '#6b7280';
                const unit = isMargin ? 'pp' : '%';
                return `<span style="font-size: 10px; color: ${color}; font-weight: 600;">${arrow} ${Math.abs(change).toFixed(1)}${unit}</span>`;
            };
            
            const monthDiv = document.createElement('div');
            monthDiv.style.cssText = 'width: 200px; flex-shrink: 0;';
            
            monthDiv.innerHTML = `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <!-- Month Header -->
                    <div style="background: #f8fafc; padding: 10px; border-bottom: 1px solid #e5e7eb;">
                        <div style="font-size: 14px; font-weight: 600; color: #1e293b;">${monthData.name}</div>
                        <div style="font-size: 11px; color: #64748b;">${monthData.events.length} Events</div>
                    </div>
                    
                    <!-- Total Sales Box - Blue background -->
                    <div onclick="toggleReportingSection('${monthData.key}', 'total-sales', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #eff6ff, #dbeafe); position: relative;">
                        <div style="font-size: 11px; color: #1e40af; text-transform: uppercase; font-weight: 600;">Total Sales</div>
                        <div style="font-size: 18px; font-weight: 700; color: #2563eb;">$${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        ${changes.totalSales !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.totalSales)}</div>` : ''}
                        <div class="expansion-${monthData.key}-total-sales" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #93c5fd;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #1e40af;"><span style="font-weight: 600;">Flash:</span> $${metrics.flash.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${(metrics.flash/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #1e40af;"><span style="font-weight: 600;">Strips:</span> $${metrics.strips.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${(metrics.strips/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #1e40af;"><span style="font-weight: 600;">Paper:</span> $${metrics.paper.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${(metrics.paper/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #1e40af;"><span style="font-weight: 600;">Cherries:</span> $${metrics.cherries.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${(metrics.cherries/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #1e40af; margin-top: 4px; padding-top: 4px; border-top: 1px solid #93c5fd;"><span style="font-weight: 600;">Avg/Event:</span> $${(metrics.totalSales / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Payouts Box - Red background -->
                    <div onclick="toggleReportingSection('${monthData.key}', 'total-payouts', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #fef2f2, #fee2e2); position: relative;">
                        <div style="font-size: 11px; color: #991b1b; text-transform: uppercase; font-weight: 600;">Total Payouts</div>
                        <div style="font-size: 18px; font-weight: 700; color: #dc2626;">$${metrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        ${changes.totalPayouts !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.totalPayouts)}</div>` : ''}
                        <div class="expansion-${monthData.key}-total-payouts" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #fca5a5;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #991b1b;"><span style="font-weight: 600;">Strip Payouts:</span> $${(metrics.stripPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${((metrics.stripPayouts || 0)/metrics.totalPayouts*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #991b1b;"><span style="font-weight: 600;">Paper Payouts:</span> $${(metrics.paperPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${((metrics.paperPayouts || 0)/metrics.totalPayouts*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #991b1b;"><span style="font-weight: 600;">Flash Payouts:</span> $${(metrics.flashPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${((metrics.flashPayouts || 0)/metrics.totalPayouts*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #991b1b; margin-top: 4px; padding-top: 4px; border-top: 1px solid #fca5a5;"><span style="font-weight: 600;">Payout %:</span> ${(metrics.totalPayouts/metrics.totalSales*100).toFixed(1)}%</div>
                                <div style="font-size: 10px; color: #991b1b;"><span style="font-weight: 600;">Avg/Event:</span> $${(metrics.totalPayouts / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Net Sales Box - Green background -->
                    <div onclick="toggleReportingSection('${monthData.key}', 'net-sales', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #f0fdf4, #dcfce7); position: relative;">
                        <div style="font-size: 11px; color: #166534; text-transform: uppercase; font-weight: 600;">Net Sales</div>
                        <div style="font-size: 18px; font-weight: 700; color: #10b981;">$${metrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        ${changes.netSales !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.netSales)}</div>` : ''}
                        <div class="expansion-${monthData.key}-net-sales" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #86efac;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #166534;"><span style="font-weight: 600;">Total Sales:</span> $${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #166534;"><span style="font-weight: 600;">Total Payouts:</span> $${metrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #166534;"><span style="font-weight: 600;">Margin:</span> ${metrics.margin.toFixed(1)}%</div>
                                <div style="font-size: 10px; color: #166534; margin-top: 4px; padding-top: 4px; border-top: 1px solid #86efac;"><span style="font-weight: 600;">Avg/Event:</span> $${(metrics.netSales / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #166534;"><span style="font-weight: 600;">Daily Average:</span> $${(metrics.netSales / 30).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Products Box - Purple background -->
                    <div onclick="toggleReportingSection('${monthData.key}', 'products', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #faf5ff, #f3e8ff); position: relative;">
                        <div style="font-size: 11px; color: #581c87; text-transform: uppercase; font-weight: 600;">Products</div>
                        <div style="font-size: 12px; font-weight: 600; color: #8b5cf6; line-height: 1.3;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Flash: ${metrics.totalSales > 0 ? ((metrics.flash || 0)/metrics.totalSales*100).toFixed(0) : 0}%</span>
                                ${changes.flashPercent !== undefined ? `<span style="font-size: 10px; color: ${changes.flashPercent > 0 ? '#16a34a' : changes.flashPercent < 0 ? '#dc2626' : '#6b7280'}; font-weight: 600;">${changes.flashPercent > 0 ? '↑' : changes.flashPercent < 0 ? '↓' : '→'} ${Math.abs(changes.flashPercent).toFixed(1)}pp</span>` : ''}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Strip: ${metrics.totalSales > 0 ? ((metrics.strips || 0)/metrics.totalSales*100).toFixed(0) : 0}%</span>
                                ${changes.stripPercent !== undefined ? `<span style="font-size: 10px; color: ${changes.stripPercent > 0 ? '#16a34a' : changes.stripPercent < 0 ? '#dc2626' : '#6b7280'}; font-weight: 600;">${changes.stripPercent > 0 ? '↑' : changes.stripPercent < 0 ? '↓' : '→'} ${Math.abs(changes.stripPercent).toFixed(1)}pp</span>` : ''}
                            </div>
                        </div>
                        <div class="expansion-${monthData.key}-products" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #d8b4fe;">
                            <!-- Flash Details -->
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 11px; color: #581c87; font-weight: 700; margin-bottom: 6px;">FLASH ${metrics.totalSales > 0 ? ((metrics.flash || 0)/metrics.totalSales*100).toFixed(0) : 0}%</div>
                                <div style="display: grid; gap: 3px; font-size: 10px; color: #581c87;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Sales:</span>
                                        <span>
                                            $${(metrics.flash || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                            ${changes.flashSales !== undefined ? `<span style="color: ${changes.flashSales > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px;">${changes.flashSales > 0 ? '↑' : '↓'}${Math.abs(changes.flashSales).toFixed(0)}%</span>` : ''}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Payouts:</span>
                                        <span>
                                            $${(metrics.flashPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                            ${changes.flashPayouts !== undefined ? `<span style="color: ${changes.flashPayouts > 0 ? '#dc2626' : '#16a34a'}; margin-left: 4px;">${changes.flashPayouts > 0 ? '↑' : '↓'}${Math.abs(changes.flashPayouts).toFixed(0)}%</span>` : ''}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Net:</span>
                                        <span>
                                            $${((metrics.flash || 0) - (metrics.flashPayouts || 0)).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                            ${changes.flashNet !== undefined ? `<span style="color: ${changes.flashNet > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px;">${changes.flashNet > 0 ? '↑' : '↓'}${Math.abs(changes.flashNet).toFixed(0)}%</span>` : ''}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Margin:</span>
                                        <span>
                                            ${metrics.flash > 0 ? (((metrics.flash - (metrics.flashPayouts || 0))/metrics.flash)*100).toFixed(1) : 0}%
                                            ${changes.flashMargin !== undefined ? `<span style="color: ${changes.flashMargin > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px;">${changes.flashMargin > 0 ? '↑' : '↓'}${Math.abs(changes.flashMargin).toFixed(1)}pp</span>` : ''}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>RPA:</span>
                                        <span>
                                            $${metrics.attendance > 0 ? ((metrics.flash || 0)/metrics.attendance).toFixed(2) : '0.00'}
                                            ${changes.flashRPA !== undefined ? `<span style="color: ${changes.flashRPA > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px;">${changes.flashRPA > 0 ? '↑' : '↓'}${Math.abs(changes.flashRPA).toFixed(0)}%</span>` : ''}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Strip Details -->
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 11px; color: #581c87; font-weight: 700; margin-bottom: 6px;">STRIP ${metrics.totalSales > 0 ? ((metrics.strips || 0)/metrics.totalSales*100).toFixed(0) : 0}%</div>
                                <div style="display: grid; gap: 3px; font-size: 10px; color: #581c87;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Sales:</span>
                                        <span>
                                            $${(metrics.strips || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                            ${changes.stripSales !== undefined ? `<span style="color: ${changes.stripSales > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px;">${changes.stripSales > 0 ? '↑' : '↓'}${Math.abs(changes.stripSales).toFixed(0)}%</span>` : ''}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Payouts:</span>
                                        <span>
                                            $${(metrics.stripPayouts || 0).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                            ${changes.stripPayouts !== undefined ? `<span style="color: ${changes.stripPayouts > 0 ? '#dc2626' : '#16a34a'}; margin-left: 4px;">${changes.stripPayouts > 0 ? '↑' : '↓'}${Math.abs(changes.stripPayouts).toFixed(0)}%</span>` : ''}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Net:</span>
                                        <span>
                                            $${((metrics.strips || 0) - (metrics.stripPayouts || 0)).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                                            ${changes.stripNet !== undefined ? `<span style="color: ${changes.stripNet > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px;">${changes.stripNet > 0 ? '↑' : '↓'}${Math.abs(changes.stripNet).toFixed(0)}%</span>` : ''}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Margin:</span>
                                        <span>
                                            ${metrics.strips > 0 ? (((metrics.strips - (metrics.stripPayouts || 0))/metrics.strips)*100).toFixed(1) : 0}%
                                            ${changes.stripMargin !== undefined ? `<span style="color: ${changes.stripMargin > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px;">${changes.stripMargin > 0 ? '↑' : '↓'}${Math.abs(changes.stripMargin).toFixed(1)}pp</span>` : ''}
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>RPA:</span>
                                        <span>
                                            $${metrics.attendance > 0 ? ((metrics.strips || 0)/metrics.attendance).toFixed(2) : '0.00'}
                                            ${changes.stripRPA !== undefined ? `<span style="color: ${changes.stripRPA > 0 ? '#16a34a' : '#dc2626'}; margin-left: 4px;">${changes.stripRPA > 0 ? '↑' : '↓'}${Math.abs(changes.stripRPA).toFixed(0)}%</span>` : ''}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Margin Box - Orange background -->
                    <div onclick="toggleReportingSection('${monthData.key}', 'margin', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #fffbeb, #fef3c7); position: relative;">
                        <div style="font-size: 11px; color: #92400e; text-transform: uppercase; font-weight: 600;">Margin</div>
                        <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${(isNaN(metrics.margin) ? 0 : metrics.margin).toFixed(1)}%</div>
                        ${changes.margin !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.margin, true)}</div>` : ''}
                        <div class="expansion-${monthData.key}-margin" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #fcd34d;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #92400e;"><span style="font-weight: 600;">Net Sales:</span> $${metrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #92400e;"><span style="font-weight: 600;">Total Sales:</span> $${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #92400e;"><span style="font-weight: 600;">Total Payouts:</span> $${metrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #92400e; margin-top: 4px; padding-top: 4px; border-top: 1px solid #fcd34d;"><span style="font-weight: 600;">Payout %:</span> ${(metrics.totalPayouts/metrics.totalSales*100).toFixed(1)}%</div>
                                <div style="font-size: 10px; color: #92400e;"><span style="font-weight: 600;">Net per Event:</span> $${(metrics.netSales / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RPA Box - Cyan background -->
                    <div onclick="toggleReportingSection('${monthData.key}', 'rpa', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #ecfeff, #cffafe); position: relative;">
                        <div style="font-size: 11px; color: #164e63; text-transform: uppercase; font-weight: 600;">RPA</div>
                        <div style="font-size: 18px; font-weight: 700; color: #06b6d4;">$${metrics.rpa.toFixed(2)}</div>
                        ${changes.rpa !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.rpa)}</div>` : ''}
                        <div class="expansion-${monthData.key}-rpa" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #67e8f9;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Total Sales:</span> $${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Total Attendance:</span> ${metrics.attendance.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #164e63; margin-top: 4px; padding-top: 4px; border-top: 1px solid #67e8f9;"><span style="font-weight: 600;">Flash/Att:</span> $${(metrics.flash / metrics.attendance).toFixed(2)} (${(metrics.flash/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Strip/Att:</span> $${(metrics.strips / metrics.attendance).toFixed(2)} (${(metrics.strips/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Paper/Att:</span> $${(metrics.paper / metrics.attendance).toFixed(2)} (${(metrics.paper/metrics.totalSales*100).toFixed(1)}%)</div>
                                <div style="font-size: 10px; color: #164e63;"><span style="font-weight: 600;">Net/Att:</span> $${(metrics.netSales / metrics.attendance).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profit by Event Box - Indigo background -->
                    <div onclick="toggleReportingSection('${monthData.key}', 'profit-event', this)" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #eef2ff, #e0e7ff); position: relative;">
                        <div style="font-size: 11px; color: #312e81; text-transform: uppercase; font-weight: 600;">Profit/Event</div>
                        <div style="font-size: 18px; font-weight: 700; color: #6366f1;">$${(metrics.netSales / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        ${changes.profitPerEvent !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.profitPerEvent)}</div>` : ''}
                        <div class="expansion-${monthData.key}-profit-event" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #a5b4fc;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #312e81;"><span style="font-weight: 600;">Net Sales:</span> $${metrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #312e81;"><span style="font-weight: 600;">Total Events:</span> ${metrics.eventCount}</div>
                                <div style="font-size: 10px; color: #312e81; margin-top: 4px; padding-top: 4px; border-top: 1px solid #a5b4fc;"><span style="font-weight: 600;">Gross/Event:</span> $${(metrics.totalSales / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #312e81;"><span style="font-weight: 600;">Payouts/Event:</span> $${(metrics.totalPayouts / metrics.eventCount).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #312e81;"><span style="font-weight: 600;">Avg Attendance:</span> ${(metrics.attendance / metrics.eventCount).toFixed(0)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attendance Box - Teal background (moved to bottom) -->
                    <div onclick="toggleReportingSection('${monthData.key}', 'attendance', this)" style="padding: 12px; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #f0fdfa, #ccfbf1); position: relative;">
                        <div style="font-size: 11px; color: #134e4a; text-transform: uppercase; font-weight: 600;">Attendance</div>
                        <div style="font-size: 18px; font-weight: 700; color: #14b8a6;">${metrics.attendancePercent.toFixed(1)}%</div>
                        ${changes.attendancePercent !== undefined ? `<div style="position: absolute; top: 12px; right: 12px;">${formatChange(changes.attendancePercent, true)}</div>` : ''}
                        <div class="expansion-${monthData.key}-attendance" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #5eead4;">
                            <div style="display: grid; gap: 4px;">
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Total Attendance:</span> ${metrics.attendance.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Total Capacity:</span> ${metrics.totalCapacity.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Total Events:</span> ${metrics.eventCount}</div>
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Avg/Event:</span> ${(metrics.attendance / metrics.eventCount).toFixed(0)}</div>
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Daily Average:</span> ${(metrics.attendance / 30).toFixed(0)}</div>
                                <div style="font-size: 10px; color: #134e4a; margin-top: 4px; padding-top: 4px; border-top: 1px solid #5eead4;"><span style="font-weight: 600;">RPA:</span> $${metrics.rpa.toFixed(2)}</div>
                                <div style="font-size: 10px; color: #134e4a;"><span style="font-weight: 600;">Total Sales/Att:</span> $${(metrics.totalSales / metrics.attendance).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return monthDiv;
        }
        
        function calculateMonthMetrics(events) {
            const metrics = {
                totalSales: 0,
                totalPayouts: 0,
                netSales: 0,
                attendance: 0,
                attendancePercent: 0,
                totalCapacity: 0,
                margin: 0,
                rpa: 0,
                flash: 0,
                strips: 0,
                paper: 0,
                cherries: 0,
                stripPayouts: 0,
                paperPayouts: 0,
                flashPayouts: 0,
                eventCount: events.length,
                // Per-attendee metrics from rows 51-54
                salesPerAttendee: 0,
                flashPerAttendee: 0,
                stripPerAttendee: 0,
                profitPerAttendee: 0,
                // Additional Monthly metrics
                attendanceMax: 0,
                capacityPercent: 0
            };
            
            events.forEach(event => {
                metrics.totalSales += window.VanguardData.getEventValue(event, 12) || 0; // Total Sales (row 12)
                metrics.totalPayouts += window.VanguardData.getEventValue(event, 29) || 0; // Total Payouts (row 29)
                
                // Monthly uses row 40 for attendance (row 37 is empty in Monthly sheets)
                metrics.attendance += window.VanguardData.getEventValue(event, 40) || 0; // Attendance (row 40)
                metrics.attendanceMax += window.VanguardData.getEventValue(event, 42) || 0; // Attendance Max (row 42)
                
                // Get capacity percentage if available
                const capacityPct = window.VanguardData.getEventValue(event, 44) || 0; // % of Max Capacity (row 44)
                if (capacityPct > 0) {
                    metrics.capacityPercent += capacityPct;
                }
                
                // Sales categories
                metrics.flash += window.VanguardData.getEventValue(event, 6) || 0; // Flash (row 6)
                metrics.strips += window.VanguardData.getEventValue(event, 9) || 0; // Strips (row 9)
                metrics.paper += window.VanguardData.getEventValue(event, 8) || 0; // Paper (row 8)
                metrics.cherries += window.VanguardData.getEventValue(event, 7) || 0; // Cherries (row 7)
                
                // Payouts
                metrics.stripPayouts += window.VanguardData.getEventValue(event, 16) || 0; // Strip Payouts (row 16)
                metrics.paperPayouts += window.VanguardData.getEventValue(event, 17) || 0; // Paper Payouts (row 17)
                metrics.flashPayouts += window.VanguardData.getEventValue(event, 18) || 0; // Flash Payouts (row 18)
                
                // Per-attendee stats from Monthly sheets (rows 51-54)
                metrics.salesPerAttendee += window.VanguardData.getEventValue(event, 51) || 0; // Sales/Attendee (row 51)
                metrics.flashPerAttendee += window.VanguardData.getEventValue(event, 52) || 0; // Flash/Attendee (row 52)
                metrics.stripPerAttendee += window.VanguardData.getEventValue(event, 53) || 0; // Strip/Attendee (row 53)
                metrics.profitPerAttendee += window.VanguardData.getEventValue(event, 54) || 0; // Profit/Attendee (row 54)
                
                // Calculate capacity based on location (if not provided)
                if (metrics.attendanceMax === 0) {
                    const maxCapacity = event.location === 'SC' ? 430 : 200;
                    metrics.totalCapacity += maxCapacity;
                }
            });
            
            // Calculate derived metrics
            metrics.netSales = metrics.totalSales - metrics.totalPayouts;
            metrics.margin = metrics.totalSales > 0 ? (metrics.netSales / metrics.totalSales * 100) : 0;
            metrics.rpa = metrics.attendance > 0 ? (metrics.totalSales / metrics.attendance) : 0;
            
            // Use actual max capacity if we have it, otherwise use calculated
            if (metrics.attendanceMax > 0) {
                metrics.totalCapacity = metrics.attendanceMax;
            }
            
            // Calculate attendance percentage
            if (metrics.capacityPercent > 0 && metrics.eventCount > 0) {
                // If capacityPercent is stored as decimal (0.7), multiply by 100 for percentage (70%)
                const avgCapacityPct = metrics.capacityPercent / metrics.eventCount;
                metrics.attendancePercent = avgCapacityPct < 1 ? avgCapacityPct * 100 : avgCapacityPct;
            } else if (metrics.totalCapacity > 0) {
                metrics.attendancePercent = (metrics.attendance / metrics.totalCapacity * 100);
            }
            
            // Average the per-attendee metrics
            if (metrics.eventCount > 0) {
                metrics.salesPerAttendee = metrics.salesPerAttendee / metrics.eventCount;
                metrics.flashPerAttendee = metrics.flashPerAttendee / metrics.eventCount;
                metrics.stripPerAttendee = metrics.stripPerAttendee / metrics.eventCount;
                metrics.profitPerAttendee = metrics.profitPerAttendee / metrics.eventCount;
            }
            
            // If per-attendee metrics weren't in the sheet, calculate them
            if (metrics.salesPerAttendee === 0 && metrics.attendance > 0) {
                metrics.salesPerAttendee = metrics.totalSales / metrics.attendance;
                metrics.flashPerAttendee = metrics.flash / metrics.attendance;
                metrics.stripPerAttendee = metrics.strips / metrics.attendance;
                metrics.profitPerAttendee = metrics.netSales / metrics.attendance;
            }
            
            return metrics;
        }
        
        function toggleReportingSection(monthKey, section, element) {
            AppSounds.play('event');
            const expansion = element.querySelector(`.expansion-${monthKey}-${section}`);
            if (expansion) {
                if (expansion.style.display === 'none') {
                    expansion.style.display = 'block';
                    // Keep the original gradient but slightly lighten it when expanded
                    element.style.opacity = '0.95';
                } else {
                    expansion.style.display = 'none';
                    // Restore full opacity
                    element.style.opacity = '1';
                }
            }
        }
        
        function updateReportingMonthRange() {
            const rangeEl = document.getElementById('reportingMonthRange');
            if (!rangeEl) return;
            
            const months = getAvailableMonths();
            if (months.length === 0) {
                rangeEl.textContent = 'No data available';
                return;
            }
            
            const startIdx = reportingCurrentOffset;
            const endIdx = Math.min(startIdx + MONTHS_PER_VIEW - 1, months.length - 1);
            
            if (startIdx < months.length && endIdx < months.length) {
                rangeEl.textContent = `Showing ${months[startIdx].name} to ${months[endIdx].name}`;
            }
        }
        
        // New calendar-based projection system
        function calculateEventTypeAverages() {
            // Calculate averages from June forward for each event type
            const events = window.VanguardData.getAllEvents();
            const juneStart = new Date(2024, 5, 1); // June 1, 2024
            
            const eventTypeAverages = {};
            const eventTypeCounts = {};
            
            let debugCounts = { scMonday: 0, scFriday: 0, scSatEarly: 0, scSatLate: 0, scSunEarly: 0, scSunLate: 0 };
            
            console.log(`[AVERAGES] Processing ${events.length} total events`);
            let processedCount = 0;
            let skippedOldCount = 0;
            let skippedNoDateCount = 0;
            
            events.forEach(event => {
                // Parse event date - handle both ISO format and M/D/YYYY format
                const dateStr = (event.dateValue || event.date || '').toString().trim();
                const isLate = dateStr.includes('Late') || dateStr.includes('PM');
                
                let eventDate;
                let cleanDateStr = dateStr.replace(/\s+(Late|PM)/gi, '').trim();
                
                // Check if ISO format (e.g., "2025-08-22T07:00:00.000Z")
                if (cleanDateStr.includes('T') && cleanDateStr.includes('-')) {
                    eventDate = new Date(cleanDateStr);
                    if (isNaN(eventDate)) {
                        skippedNoDateCount++;
                        return;
                    }
                } else if (cleanDateStr.includes('/')) {
                    // M/D/YYYY or M/D/YY format
                    const [month, day, year] = cleanDateStr.split('/').map(Number);
                    // Handle 2-digit years (assume 2000s)
                    const fullYear = year < 100 ? 2000 + year : year;
                    eventDate = new Date(fullYear, month - 1, day);
                } else {
                    skippedNoDateCount++;
                    return;
                }
                
                // Only use events from June forward
                if (eventDate < juneStart) {
                    skippedOldCount++;
                    return;
                }
                
                // Process both SC and RWC events
                
                processedCount++;
                
                // Determine event type key
                const dayOfWeek = eventDate.getDay();
                const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek];
                const location = event.location || 'Unknown';
                const session = isLate ? 'Late' : 'Early';
                
                // Log SC Monday/Friday and RWC Tue/Wed/Thu events specifically
                if (location === 'SC' && (dayOfWeek === 1 || dayOfWeek === 5)) {
                    console.log(`[AVERAGES] SC ${dayName} event: ${dateStr}, location=${location}`);
                } else if (location === 'RWC' && (dayOfWeek >= 2 && dayOfWeek <= 4)) {
                    console.log(`[AVERAGES] RWC ${dayName} event: ${dateStr}, location=${location}`);
                }
                
                // Debug count specific event types
                if (location === 'SC') {
                    if (dayOfWeek === 1) debugCounts.scMonday++;
                    if (dayOfWeek === 5) debugCounts.scFriday++;
                    if (dayOfWeek === 6 && !isLate) debugCounts.scSatEarly++;
                    if (dayOfWeek === 6 && isLate) debugCounts.scSatLate++;
                    if (dayOfWeek === 0 && !isLate) debugCounts.scSunEarly++;
                    if (dayOfWeek === 0 && isLate) debugCounts.scSunLate++;
                }
                
                // For SC: weekends have Early/Late, weekdays don't use session suffix
                // For RWC: no session suffix needed
                let eventTypeKey;
                if (location === 'SC') {
                    if (dayName === 'Saturday' || dayName === 'Sunday') {
                        eventTypeKey = `${location}-${dayName}-${session}`;
                    } else {
                        // Monday, Friday don't use Early/Late suffix
                        eventTypeKey = `${location}-${dayName}`;
                    }
                } else {
                    // RWC events don't use Early/Late
                    eventTypeKey = `${location}-${dayName}`;
                }
                
                // Initialize if needed
                if (!eventTypeAverages[eventTypeKey]) {
                    eventTypeAverages[eventTypeKey] = { totalSales: 0, totalPayouts: 0, netSales: 0 };
                    eventTypeCounts[eventTypeKey] = 0;
                }
                
                // Add to totals
                const totalSales = window.VanguardData.getEventValue(event, 12) || 0;
                const totalPayouts = window.VanguardData.getEventValue(event, 29) || 0;
                const netSales = window.VanguardData.getEventValue(event, 31) || 0;
                
                eventTypeAverages[eventTypeKey].totalSales += totalSales;
                eventTypeAverages[eventTypeKey].totalPayouts += totalPayouts;
                eventTypeAverages[eventTypeKey].netSales += netSales;
                eventTypeCounts[eventTypeKey]++;
            });
            
            // Convert totals to averages
            Object.keys(eventTypeAverages).forEach(key => {
                const count = eventTypeCounts[key];
                if (count > 0) {
                    eventTypeAverages[key].totalSales /= count;
                    eventTypeAverages[key].totalPayouts /= count;
                    eventTypeAverages[key].netSales /= count;
                    eventTypeAverages[key].count = count; // Store count for debugging
                }
            });
            
            console.log('[AVERAGES] ========== AVERAGES CALCULATION SUMMARY ==========');
            console.log(`[AVERAGES] Total events: ${events.length}`);
            console.log(`[AVERAGES] Events before June: ${skippedOldCount}`);
            console.log(`[AVERAGES] Events with no valid date: ${skippedNoDateCount}`);
            console.log(`[AVERAGES] Events processed (June+): ${processedCount}`);
            console.log('[AVERAGES] SC Event Type Counts:', debugCounts);
            console.log('[AVERAGES] Event Type Averages Created:', Object.keys(eventTypeAverages));
            
            // Log the summary for each event type
            console.log('[AVERAGES] Detailed averages by event type:');
            Object.keys(eventTypeAverages).forEach(key => {
                const avg = eventTypeAverages[key];
                const count = eventTypeCounts[key];
                console.log(`[AVERAGES]   ${key}:`);
                console.log(`[AVERAGES]     - Count: ${count} events`);
                console.log(`[AVERAGES]     - Avg Sales: $${avg.totalSales.toFixed(0)}`);
                console.log(`[AVERAGES]     - Avg Payouts: $${avg.totalPayouts.toFixed(0)}`);
                console.log(`[AVERAGES]     - Avg Net: $${avg.netSales.toFixed(0)}`);
            });
            console.log('[AVERAGES] ====================================================');
            
            return eventTypeAverages;
        }
        
        function getMissingEventsForMonth(monthYear, existingEvents, location = null) {
            // Determine what events should exist in this month based on calendar
            const [year, month] = monthYear.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0); // Last day of month
            
            return getMissingEventsForPeriod(startDate, endDate, existingEvents, location);
        }
        
        function getMissingEventsForPeriod(startDate, endDate, existingEvents, location = null) {
            // Determine what events should exist in this period based on calendar
            const missingEvents = [];
            const eventTypeAverages = calculateEventTypeAverages();
            
            // Create a Set of existing event dates for quick lookup
            const existingEventDates = new Set();
            console.log(`[PROJECTION DEBUG] Building existing events set from ${existingEvents.length} events`);
            console.log(`[PROJECTION DEBUG] Date range: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`);
            
            existingEvents.forEach(event => {
                const dateStr = (event.dateValue || event.date || '').toString().trim();
                const isLate = dateStr.includes('Late') || dateStr.includes('PM');
                let cleanDateStr = dateStr.replace(/\s+(Late|PM)/gi, '').trim();
                
                let eventDate, normalizedDate;
                
                // Check if ISO format (e.g., "2025-08-22T07:00:00.000Z")
                if (cleanDateStr.includes('T') && cleanDateStr.includes('-')) {
                    eventDate = new Date(cleanDateStr);
                    if (isNaN(eventDate)) {
                        console.log(`[PROJECTION DEBUG] Invalid ISO date: "${dateStr}"`);
                        return;
                    }
                    // Format as M/D/YYYY
                    normalizedDate = `${eventDate.getMonth() + 1}/${eventDate.getDate()}/${eventDate.getFullYear()}`;
                } else if (cleanDateStr.includes('/')) {
                    // M/D/YYYY or M/D/YY format
                    const parts = cleanDateStr.split('/');
                    const month = parseInt(parts[0], 10);
                    const day = parseInt(parts[1], 10);
                    const year = parseInt(parts[2], 10);
                    // Handle 2-digit years (assume 2000s)
                    const fullYear = year < 100 ? 2000 + year : year;
                    eventDate = new Date(fullYear, month - 1, day);
                    normalizedDate = `${month}/${day}/${fullYear}`;
                } else {
                    console.log(`[PROJECTION DEBUG] Skipping event with invalid date: "${dateStr}"`);
                    return;
                }
                
                const dayOfWeek = eventDate.getDay();
                
                // For SC weekdays (Monday=1, Friday=5), don't use Early suffix
                // For SC weekends, use Early/Late
                let key;
                if (event.location === 'SC' && (dayOfWeek === 1 || dayOfWeek === 5)) {
                    // Monday or Friday - no session suffix
                    key = `${event.location}-${normalizedDate}`;
                } else if (event.location === 'SC' && (dayOfWeek === 0 || dayOfWeek === 6)) {
                    // Weekend - use Early/Late
                    key = `${event.location}-${normalizedDate}-${isLate ? 'Late' : 'Early'}`;
                } else if (event.location === 'RWC') {
                    // RWC - no session suffix
                    key = `${event.location}-${normalizedDate}`;
                } else {
                    return; // Skip unknown locations
                }
                
                existingEventDates.add(key);
                console.log(`[PROJECTION DEBUG] Added existing event: ${key} (${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dayOfWeek]})`);
            });
            
            // Check each day in the period
            const current = new Date(startDate);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Set to end of today to include today's events
            
            // Include yesterday for projection (data entry lag)
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            yesterday.setHours(0, 0, 0, 0);
            
            console.log(`[PROJECTION DEBUG] Checking calendar from ${current.toLocaleDateString()} to ${endDate.toLocaleDateString()}`);
            console.log(`[PROJECTION DEBUG] Today is ${today.toLocaleDateString()}`);
            console.log(`[PROJECTION DEBUG] Yesterday is ${yesterday.toLocaleDateString()}`);
            console.log(`[PROJECTION DEBUG] Will check yesterday, today, and future dates for projections`);
            
            let calendarCheckCount = 0;
            // Check ALL days in the period, including future dates for projections
            while (current <= endDate) {
                const dayOfWeek = current.getDay();
                const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek];
                const dateStr = `${current.getMonth() + 1}/${current.getDate()}/${current.getFullYear()}`;
                
                calendarCheckCount++;
                
                // Include yesterday, today and future dates, exclude older past dates  
                const currentDateOnly = new Date(current.getFullYear(), current.getMonth(), current.getDate());
                const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const yesterdayDateOnly = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
                const isYesterdayOrLater = currentDateOnly >= yesterdayDateOnly;
                const dateStatus = currentDateOnly > todayDateOnly ? ' (FUTURE)' : 
                                  currentDateOnly.getTime() === todayDateOnly.getTime() ? ' (TODAY)' : 
                                  currentDateOnly.getTime() === yesterdayDateOnly.getTime() ? ' (YESTERDAY)' : '';
                
                // Check SC events
                if (!location || location === 'SC' || location === 'COMBINED') {
                    if (dayOfWeek === 1 || dayOfWeek === 5) { // Monday or Friday
                        const key = `SC-${dateStr}`; // No Early suffix for weekdays
                        if (!existingEventDates.has(key)) {
                            console.log(`[PROJECTION DEBUG] Missing ${dayName} event on ${dateStr}${dateStatus}`);
                        } else {
                            console.log(`[PROJECTION DEBUG] Found existing ${dayName} event on ${dateStr}${dateStatus}`);
                        }
                        if (!existingEventDates.has(key)) {
                            // Only project yesterday, today and future events, not older past missed events
                            if (isYesterdayOrLater) {
                                const avgKey = `SC-${dayName}`;
                                console.log(`[PROJECTION DEBUG] Looking for average: ${avgKey}, exists: ${!!eventTypeAverages[avgKey]}`);
                                if (eventTypeAverages[avgKey]) {
                                    console.log(`[PROJECTION DEBUG] Missing ${avgKey} on ${dateStr}`);
                                    missingEvents.push({
                                        type: avgKey,
                                        date: new Date(current),
                                        ...eventTypeAverages[avgKey]
                                    });
                                }
                            } else {
                                console.log(`[PROJECTION DEBUG] Skipping past missed ${dayName} event on ${dateStr}`);
                            }
                        }
                    } else if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
                        // Check Early session
                        const earlyKey = `SC-${dateStr}-Early`;
                        if (!existingEventDates.has(earlyKey)) {
                            // Only project today and future events, not past missed events
                            if (isYesterdayOrLater) {
                                const avgKey = `SC-${dayName}-Early`;
                                if (eventTypeAverages[avgKey]) {
                                    console.log(`[PROJECTION DEBUG] Missing ${dayName} Early event on ${dateStr}${dateStatus}`);
                                    missingEvents.push({
                                        type: avgKey,
                                        date: new Date(current),
                                        ...eventTypeAverages[avgKey]
                                    });
                                } else {
                                    console.log(`[PROJECTION DEBUG] No average for ${avgKey}, skipping ${dateStr} Early`);
                                }
                            } else {
                                console.log(`[PROJECTION DEBUG] Skipping past missed ${dayName} Early event on ${dateStr}`);
                            }
                        } else {
                            console.log(`[PROJECTION DEBUG] Found existing ${dayName} Early event on ${dateStr}${dateStatus}`);
                        }
                        
                        // Check Late session
                        const lateKey = `SC-${dateStr}-Late`;
                        if (!existingEventDates.has(lateKey)) {
                            // Only project today and future events, not past missed events
                            if (isYesterdayOrLater) {
                                const avgKey = `SC-${dayName}-Late`;
                                if (eventTypeAverages[avgKey]) {
                                    console.log(`[PROJECTION DEBUG] Missing ${dayName} Late event on ${dateStr}${dateStatus}`);
                                    missingEvents.push({
                                        type: avgKey,
                                        date: new Date(current),
                                        ...eventTypeAverages[avgKey]
                                    });
                                } else {
                                    console.log(`[PROJECTION DEBUG] No average for ${avgKey}, skipping ${dateStr} Late`);
                                }
                            } else {
                                console.log(`[PROJECTION DEBUG] Skipping past missed ${dayName} Late event on ${dateStr}`);
                            }
                        } else {
                            console.log(`[PROJECTION DEBUG] Found existing ${dayName} Late event on ${dateStr}${dateStatus}`);
                        }
                    }
                }
                
                // Check RWC events
                if (!location || location === 'RWC' || location === 'COMBINED') {
                    if (dayOfWeek >= 2 && dayOfWeek <= 4) { // Tuesday, Wednesday, Thursday
                        const key = `RWC-${dateStr}`; // RWC doesn't have Early/Late sessions
                        if (!existingEventDates.has(key)) {
                            // Only project yesterday, today and future events, not older past missed events
                            if (isYesterdayOrLater) {
                                const avgKey = `RWC-${dayName}`;
                                if (eventTypeAverages[avgKey]) {
                                    console.log(`[PROJECTION DEBUG] Missing ${dayName} RWC event on ${dateStr}${dateStatus}`);
                                    missingEvents.push({
                                        type: avgKey,
                                        date: new Date(current),
                                        ...eventTypeAverages[avgKey]
                                    });
                                } else {
                                    console.log(`[PROJECTION DEBUG] No average for ${avgKey}, skipping ${dateStr} RWC`);
                                }
                            } else {
                                console.log(`[PROJECTION DEBUG] Skipping past missed ${dayName} RWC event on ${dateStr}`);
                            }
                        } else {
                            console.log(`[PROJECTION DEBUG] Found existing ${dayName} RWC event on ${dateStr}${dateStatus}`);
                        }
                    }
                }
                
                current.setDate(current.getDate() + 1);
            }
            
            console.log(`[PROJECTION DEBUG] Checked ${calendarCheckCount} days in period`);
            console.log(`[PROJECTION DEBUG] Found ${existingEventDates.size} existing events`);
            console.log(`[PROJECTION DEBUG] Existing event keys:`, Array.from(existingEventDates));
            
            // Create summary of missing events by type
            const missingByType = {};
            missingEvents.forEach(event => {
                if (!missingByType[event.type]) {
                    missingByType[event.type] = {
                        count: 0,
                        avgSales: event.totalSales,
                        avgPayouts: event.totalPayouts,
                        avgNet: event.netSales,
                        basedOnCount: event.count || 0
                    };
                }
                missingByType[event.type].count++;
            });
            
            console.log(`[PROJECTION] ========== PROJECTION SUMMARY ==========`);
            console.log(`[PROJECTION] Period: ${startDate.toDateString()} to ${endDate.toDateString()}`);
            console.log(`[PROJECTION] Location: ${location || 'ALL'}`);
            console.log(`[PROJECTION] Total Missing Events: ${missingEvents.length}`);
            
            // Log details for each event type
            Object.keys(missingByType).forEach(eventType => {
                const info = missingByType[eventType];
                console.log(`[PROJECTION] ${eventType}:`);
                console.log(`[PROJECTION]   - Number needed: ${info.count}`);
                console.log(`[PROJECTION]   - Average used: Sales=$${info.avgSales.toFixed(0)}, Payouts=$${info.avgPayouts.toFixed(0)}, Net=$${info.avgNet.toFixed(0)}`);
                console.log(`[PROJECTION]   - Average based on: ${info.basedOnCount} events`);
            });
            
            // Also log what event types we have averages for but didn't need
            const availableTypes = Object.keys(eventTypeAverages);
            const usedTypes = Object.keys(missingByType);
            const unusedTypes = availableTypes.filter(t => !usedTypes.includes(t));
            if (unusedTypes.length > 0) {
                console.log(`[PROJECTION] Event types with averages but no missing dates: ${unusedTypes.join(', ')}`);
            }
            
            console.log(`[PROJECTION] ========================================`);
            
            return missingEvents;
        }
        
        function createProjectionColumn(lastMonth) {
            // Check if we need projection for this month
            if (!lastMonth.events || lastMonth.events.length === 0) return null;
            
            // Parse month to get date range
            const monthKey = lastMonth.key; // Format: "2024-08"
            console.log(`[PROJECTION] Creating projection for month: ${monthKey}, location: ${reportingLocationFilter}`);
            console.log(`[PROJECTION] Month has ${lastMonth.events.length} existing events`);
            const missingEvents = getMissingEventsForMonth(monthKey, lastMonth.events, reportingLocationFilter);
            
            // If no missing events, no projection needed
            if (missingEvents.length === 0) return null;
            
            // Get the event type averages for tooltips
            const eventTypeAverages = calculateEventTypeAverages();
            
            // Build detailed tooltip content for each metric
            const buildTooltipContent = (metric) => {
                const relevantTypes = Object.keys(eventTypeAverages).filter(type => 
                    missingEvents.some(event => event.type === type)
                );
                
                let content = `DETAILED ${metric.toUpperCase()} AVERAGES:\n\n`;
                relevantTypes.forEach(type => {
                    const avg = eventTypeAverages[type];
                    const count = avg.count || 0;
                    const value = metric === 'totalSales' ? avg.totalSales : 
                                 metric === 'totalPayouts' ? avg.totalPayouts : avg.netSales;
                    content += `${type}:\n  $${value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} (${count} events)\n\n`;
                });
                
                const projectedCount = missingEvents.filter(e => relevantTypes.includes(e.type)).length;
                content += `Total projected events: ${projectedCount}\n`;
                content += `Based on events from June forward`;
                
                return content;
            };
            
            // Calculate projection totals
            const projectionTotals = {
                totalSales: 0,
                totalPayouts: 0,
                netSales: 0
            };
            
            missingEvents.forEach(event => {
                projectionTotals.totalSales += event.totalSales;
                projectionTotals.totalPayouts += event.totalPayouts;
                projectionTotals.netSales += event.netSales;
            });
            
            // Add existing actuals
            const actualMetrics = lastMonth.metrics;
            const projectedMetrics = {
                totalSales: actualMetrics.totalSales + projectionTotals.totalSales,
                totalPayouts: actualMetrics.totalPayouts + projectionTotals.totalPayouts,
                netSales: actualMetrics.netSales + projectionTotals.netSales,
                margin: ((actualMetrics.totalSales + projectionTotals.totalSales - actualMetrics.totalPayouts - projectionTotals.totalPayouts) / 
                        (actualMetrics.totalSales + projectionTotals.totalSales)) * 100
            };
            
            const projDiv = document.createElement('div');
            projDiv.style.cssText = 'width: 200px; flex-shrink: 0;';
            
            projDiv.innerHTML = `
                <div style="background: white; border: 2px dashed #10b981; border-radius: 8px; overflow: visible;">
                    <!-- Projection Header -->
                    <div style="background: white; padding: 10px; border-bottom: 1px solid #e5e7eb; position: relative;">
                        <div style="font-size: 14px; font-weight: 600; color: #374151;">Month Projection</div>
                        <div style="font-size: 11px; color: #6b7280;">${lastMonth.events.length} Actual + ${missingEvents.length} Projected</div>
                        ${TooltipHelpers.createInfoIcon(`MONTHLY PROJECTION ASSUMPTIONS:

SC Events Expected:
• 2 Saturday events (Early & Late)
• 2 Sunday events (Early & Late)
• Monday events
• Friday events

RWC Events Expected:
• Tuesday events
• Wednesday events
• Thursday events

Averages based on all similar events from June forward.
Hover over individual metrics for detailed averages.`)}
                    </div>
                    
                    <!-- Projected Total Sales -->
                    <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 12px; border-bottom: 1px dashed #60a5fa; position: relative; cursor: help;">
                        <div style="font-size: 11px; color: #1d4ed8; text-transform: uppercase; font-weight: 600;">Projected Total Sales</div>
                        <div style="font-size: 18px; font-weight: 700; color: #1e40af;">$${projectedMetrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                            Actual: $${actualMetrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            Added: $${projectionTotals.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                        <div style="
                            position: absolute; 
                            top: 0; 
                            left: 0;
                            background: white; 
                            border: 1px solid #d1d5db; 
                            border-radius: 6px; 
                            padding: 8px 10px; 
                            font-size: 10px; 
                            font-weight: normal; 
                            color: #374151; 
                            white-space: pre-line; 
                            z-index: 1000; 
                            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
                            min-width: 250px;
                            max-width: 350px;
                            opacity: 0; 
                            visibility: hidden; 
                            transition: opacity 0.2s, visibility 0.2s;
                        " class="metric-tooltip">${buildTooltipContent('totalSales')}</div>
                    </div>
                    
                    <!-- Projected Payouts -->
                    <div style="background: linear-gradient(135deg, #fef2f2, #fecaca); padding: 12px; border-bottom: 1px dashed #f87171; position: relative; cursor: help;">
                        <div style="font-size: 11px; color: #dc2626; text-transform: uppercase; font-weight: 600;">Projected Payouts</div>
                        <div style="font-size: 18px; font-weight: 700; color: #b91c1c;">$${projectedMetrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                            Actual: $${actualMetrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            Added: $${projectionTotals.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                        <div style="
                            position: absolute; 
                            top: 0; 
                            left: 0;
                            background: white; 
                            border: 1px solid #d1d5db; 
                            border-radius: 6px; 
                            padding: 8px 10px; 
                            font-size: 10px; 
                            font-weight: normal; 
                            color: #374151; 
                            white-space: pre-line; 
                            z-index: 1000; 
                            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
                            min-width: 250px;
                            max-width: 350px;
                            opacity: 0; 
                            visibility: hidden; 
                            transition: opacity 0.2s, visibility 0.2s;
                        " class="metric-tooltip">${buildTooltipContent('totalPayouts')}</div>
                    </div>
                    
                    <!-- Projected Net Sales -->
                    <div style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); padding: 12px; position: relative; cursor: help;">
                        <div style="font-size: 11px; color: #065f46; text-transform: uppercase; font-weight: 600;">Projected Net Sales</div>
                        <div style="font-size: 18px; font-weight: 700; color: #059669;">$${projectedMetrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                            Actual: $${actualMetrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                        <div style="font-size: 10px; color: #6b7280;">
                            Added: $${projectionTotals.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                        </div>
                        <div style="
                            position: absolute; 
                            top: 0; 
                            left: 0;
                            background: white; 
                            border: 1px solid #d1d5db; 
                            border-radius: 6px; 
                            padding: 8px 10px; 
                            font-size: 10px; 
                            font-weight: normal; 
                            color: #374151; 
                            white-space: pre-line; 
                            z-index: 1000; 
                            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
                            min-width: 250px;
                            max-width: 350px;
                            opacity: 0; 
                            visibility: hidden; 
                            transition: opacity 0.2s, visibility 0.2s;
                        " class="metric-tooltip">${buildTooltipContent('netSales')}</div>
                    </div>
                </div>
            `;
            
            return projDiv;
        }
        
        function createProjectionColumn_OLD(lastMonth) {
            // Old percentage-based projection - keeping for reference
            if (!lastMonth.events || lastMonth.events.length === 0) return null;
            
            // Parse date properly from MM/DD/YYYY format or dateValue
            const parseDate = (dateStr) => {
                // Remove "Late" or "PM" from date string
                const cleanStr = (dateStr || '').toString().replace(/\s+(Late|PM)/gi, '').trim();
                
                if (cleanStr.includes('/')) {
                    const parts = cleanStr.split('/');
                    // MM/DD/YYYY format
                    const month = parseInt(parts[0], 10);
                    const day = parseInt(parts[1], 10);
                    const year = parseInt(parts[2], 10);
                    
                    if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                        return new Date(year, month - 1, day);
                    }
                }
                // Try parsing as a standard date string
                const parsed = new Date(cleanStr);
                return isNaN(parsed.getTime()) ? null : parsed;
            };
            
            // Find the latest event date in the month - use dateValue or date
            const eventDates = lastMonth.events.map(e => {
                const dateStr = e.dateValue || e.date;
                const parsed = parseDate(dateStr);
                return parsed;
            }).filter(d => d && !isNaN(d.getTime()));
            
            if (eventDates.length === 0) {
                console.error('No valid dates found in month events');
                return null;
            }
            
            // Use today's date for calculating progress
            const today = new Date();
            const lastEventDate = new Date(Math.max(...eventDates));
            
            // Validate the date
            if (isNaN(lastEventDate.getTime())) {
                console.error('Invalid last event date');
                return null;
            }
            
            // Get the last day of the month for the event's month
            const eventMonth = lastEventDate.getMonth();
            const eventYear = lastEventDate.getFullYear();
            const lastDayOfMonth = new Date(eventYear, eventMonth + 1, 0);
            const firstDayOfMonth = new Date(eventYear, eventMonth, 1);
            
            // Calculate percentage of month passed
            const daysInMonth = lastDayOfMonth.getDate();
            // If we're in the same month as the last event, use today's date
            // Otherwise use the last day of that month
            let daysPassed;
            if (today.getMonth() === eventMonth && today.getFullYear() === eventYear) {
                daysPassed = today.getDate();
            } else if (today > lastDayOfMonth) {
                daysPassed = daysInMonth;
            } else {
                daysPassed = lastEventDate.getDate();
            }
            const percentPassed = (daysPassed / daysInMonth) * 100;
            
            // If month is complete (last event is on or after the 28th), don't show projection
            if (daysPassed >= daysInMonth - 2) return null;
            
            // Calculate projections
            const metrics = lastMonth.metrics;
            const projectionFactor = daysInMonth / daysPassed;
            
            const projectedMetrics = {
                totalSales: metrics.totalSales * projectionFactor,
                netSales: metrics.netSales * projectionFactor,
                attendance: metrics.attendance * projectionFactor,
                attendancePercent: metrics.attendancePercent, // This stays the same as it's already a percentage
                margin: metrics.margin, // Margin percentage stays the same
                rpa: metrics.rpa, // RPA stays the same
                flash: metrics.flash * projectionFactor,
                strips: metrics.strips * projectionFactor,
                paper: metrics.paper * projectionFactor,
                cherries: metrics.cherries * projectionFactor,
                totalPayouts: metrics.totalPayouts * projectionFactor
            };
            
            const projDiv = document.createElement('div');
            projDiv.style.cssText = 'width: 200px; flex-shrink: 0;';
            
            projDiv.innerHTML = `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <!-- Projection Header - matching monthly headers -->
                    <div style="background: #f8fafc; padding: 10px; border-bottom: 1px solid #e5e7eb;">
                        <div style="font-size: 14px; font-weight: 600; color: #1e293b;">% of Month</div>
                        <div style="font-size: 11px; color: #64748b;">${percentPassed.toFixed(1)}% Complete</div>
                        <div style="font-size: 10px; color: #64748b;">${daysPassed} of ${daysInMonth} days</div>
                    </div>
                    
                    <!-- Sales Projection Box -->
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                        <div style="font-size: 11px; color: #1e40af; text-transform: uppercase; font-weight: 600;">Sales Projection</div>
                        <div style="font-size: 18px; font-weight: 700; color: #2563eb;">$${projectedMetrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #1e40af; margin-top: 4px;">Current: $${metrics.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                    </div>
                    
                    <!-- Payouts Projection Box -->
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #fef2f2, #fee2e2);">
                        <div style="font-size: 11px; color: #991b1b; text-transform: uppercase; font-weight: 600;">Payouts Projection</div>
                        <div style="font-size: 18px; font-weight: 700; color: #dc2626;">$${projectedMetrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #991b1b; margin-top: 4px;">Current: $${metrics.totalPayouts.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                    </div>
                    
                    <!-- Net Projection Box -->
                    <div style="padding: 12px; background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                        <div style="font-size: 11px; color: #166534; text-transform: uppercase; font-weight: 600;">Net Projection</div>
                        <div style="font-size: 18px; font-weight: 700; color: #10b981;">$${projectedMetrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                        <div style="font-size: 10px; color: #166534; margin-top: 4px;">Current: $${metrics.netSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                    </div>
                </div>
            `;
            
            return projDiv;
        }
        
        // Global state for Monthly view
        let monthlyLocationFilter = 'SC'; // Default to SC
        let monthlyDayFilters = {
            monday: true, 'monday-late': true,
            tuesday: true, 'tuesday-late': true,
            wednesday: true, 'wednesday-late': true,
            thursday: true, 'thursday-late': true,
            friday: true, 'friday-late': true,
            saturday: true, 'saturday-late': true,
            sunday: true, 'sunday-late': true
        };
        let monthlyCurrentEvents = [];
        let monthlyComparisonEvents = [];
        
        // Set Monthly location filter
        function setMonthlyLocation(location) {
            monthlyLocationFilter = location;
            
            // Update button styles - now they're on a light background
            document.getElementById('monthlyLocSC').style.background = location === 'SC' ? '#3b82f6' : 'transparent';
            document.getElementById('monthlyLocSC').style.color = location === 'SC' ? 'white' : '#64748b';
            
            document.getElementById('monthlyLocRWC').style.background = location === 'RWC' ? '#3b82f6' : 'transparent';
            document.getElementById('monthlyLocRWC').style.color = location === 'RWC' ? 'white' : '#64748b';
            
            document.getElementById('monthlyLocCombined').style.background = location === 'COMBINED' ? '#3b82f6' : 'transparent';
            document.getElementById('monthlyLocCombined').style.color = location === 'COMBINED' ? 'white' : '#64748b';
            
            // Refresh the view
            const currentPeriod = document.getElementById('monthOverMonthTimePeriod')?.value || '30';
            updateMonthlyView(currentPeriod);
        }
        
        // Function to update monthly comparisons when COMPARE TO button is clicked
        function updateMonthlyComparisons() {
            // Refresh the monthly view with current settings
            const currentPeriod = document.getElementById('monthOverMonthTimePeriod')?.value || '30';
            updateMonthlyView(currentPeriod);
        }
        
        // Update Monthly view with real data
        function updateMonthlyView(period = '30') {
            if (!window.VanguardData || !window.VanguardData.data) {
                console.log('Data not loaded yet');
                return;
            }
            
            // Get all events
            const allEvents = window.VanguardData.getAllEvents();
            
            // Filter events by location
            let events = allEvents;
            if (monthlyLocationFilter === 'SC') {
                events = allEvents.filter(e => e.location === 'SC');
            } else if (monthlyLocationFilter === 'RWC') {
                events = allEvents.filter(e => e.location === 'RWC');
            }
            // COMBINED uses all events
            
            // Filter events by day/Late selections
            events = events.filter(event => {
                const day = event.day?.toLowerCase() || '';
                const isLate = event.isLate;
                
                // Check if this day type is enabled
                if (isLate) {
                    return monthlyDayFilters[`${day}-late`] || false;
                } else {
                    return monthlyDayFilters[day] || false;
                }
            });
            
            // Get current period dates
            const today = new Date();
            let currentStartDate, currentEndDate;
            
            if (period === 'month') {
                // This month
                currentStartDate = new Date(today.getFullYear(), today.getMonth(), 1);
                currentEndDate = today;
            } else {
                // Rolling days (30 or 90)
                const days = parseInt(period) || 30;
                currentEndDate = today;
                currentStartDate = new Date(today);
                currentStartDate.setDate(currentStartDate.getDate() - days);
            }
            
            // Get comparison period dates
            const comparisonPeriod = document.getElementById('comparisonPeriod')?.value || '30';
            let compStartDate, compEndDate;
            
            if (period === 'month' && comparisonPeriod === 'prev-month') {
                // Previous calendar month
                compEndDate = new Date(today.getFullYear(), today.getMonth(), 0); // Last day of previous month
                compStartDate = new Date(compEndDate.getFullYear(), compEndDate.getMonth(), 1);
            } else if (comparisonPeriod === '3months') {
                // 3 month average
                compStartDate = new Date(today);
                compStartDate.setDate(compStartDate.getDate() - 90);
                compEndDate = new Date(today);
            } else if (comparisonPeriod === '12months') {
                // 12 month average
                compStartDate = new Date(today);
                compStartDate.setDate(compStartDate.getDate() - 365);
                compEndDate = new Date(today);
            } else {
                // Previous period of same length as current period
                const currentDays = parseInt(period) || 30;
                compStartDate = new Date(today);
                compStartDate.setDate(compStartDate.getDate() - (currentDays * 2)); // -60 for 30-day period
                compEndDate = new Date(today);
                compEndDate.setDate(compEndDate.getDate() - currentDays - 1); // -31 for 30-day period
            }
            
            // Parse date properly from MM/DD/YYYY format (same as Events page)
            const parseDate = (dateStr) => {
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    // MM/DD/YYYY format
                    return new Date(parts[2], parts[0] - 1, parts[1]);
                }
                return new Date(dateStr);
            };
            
            // Filter events for current and comparison periods
            const currentEvents = events.filter(e => {
                const eventDate = parseDate(e.date);
                return eventDate >= currentStartDate && eventDate <= currentEndDate;
            });
            
            const comparisonEvents = events.filter(e => {
                const eventDate = parseDate(e.date);
                return eventDate >= compStartDate && eventDate <= compEndDate;
            });
            
            // Calculate metrics for both periods
            const currentMetrics = calculatePeriodMetrics(currentEvents);
            const comparisonMetrics = calculatePeriodMetrics(comparisonEvents);
            
            // Average current metrics if 90-day period (divide by 3 to get monthly average)
            if (period === '90') {
                currentMetrics.totalSales = currentMetrics.totalSales / 3;
                currentMetrics.totalPayouts = currentMetrics.totalPayouts / 3;
                currentMetrics.netSales = currentMetrics.netSales / 3;
                currentMetrics.attendance = currentMetrics.attendance / 3;
                currentMetrics.flash = currentMetrics.flash / 3;
                currentMetrics.cherries = currentMetrics.cherries / 3;
                currentMetrics.paper = currentMetrics.paper / 3;
                currentMetrics.strips = currentMetrics.strips / 3;
                // Recalculate derived metrics
                currentMetrics.margin = currentMetrics.totalSales > 0 ? (currentMetrics.netSales / currentMetrics.totalSales * 100) : 0;
                currentMetrics.rpa = currentMetrics.attendance > 0 ? (currentMetrics.totalSales / currentMetrics.attendance) : 0;
                // Event count represents average events per month
                currentMetrics.eventCount = Math.round(currentMetrics.eventCount / 3);
            }
            
            // Average comparison metrics if needed
            if (comparisonPeriod === '3months') {
                // For 3-month average, divide totals by 3 (except eventCount and derived metrics)
                comparisonMetrics.totalSales = comparisonMetrics.totalSales / 3;
                comparisonMetrics.totalPayouts = comparisonMetrics.totalPayouts / 3;
                comparisonMetrics.netSales = comparisonMetrics.netSales / 3;
                comparisonMetrics.attendance = comparisonMetrics.attendance / 3;
                comparisonMetrics.flash = comparisonMetrics.flash / 3;
                comparisonMetrics.cherries = comparisonMetrics.cherries / 3;
                comparisonMetrics.paper = comparisonMetrics.paper / 3;
                comparisonMetrics.strips = comparisonMetrics.strips / 3;
                // Recalculate derived metrics
                comparisonMetrics.margin = comparisonMetrics.totalSales > 0 ? (comparisonMetrics.netSales / comparisonMetrics.totalSales * 100) : 0;
                comparisonMetrics.rpa = comparisonMetrics.attendance > 0 ? (comparisonMetrics.totalSales / comparisonMetrics.attendance) : 0;
                // Event count represents average events per month
                comparisonMetrics.eventCount = Math.round(comparisonMetrics.eventCount / 3);
            } else if (comparisonPeriod === '12months') {
                // For 12-month average, divide totals by 12 (except eventCount and derived metrics)
                comparisonMetrics.totalSales = comparisonMetrics.totalSales / 12;
                comparisonMetrics.totalPayouts = comparisonMetrics.totalPayouts / 12;
                comparisonMetrics.netSales = comparisonMetrics.netSales / 12;
                comparisonMetrics.attendance = comparisonMetrics.attendance / 12;
                comparisonMetrics.flash = comparisonMetrics.flash / 12;
                comparisonMetrics.cherries = comparisonMetrics.cherries / 12;
                comparisonMetrics.paper = comparisonMetrics.paper / 12;
                comparisonMetrics.strips = comparisonMetrics.strips / 12;
                // Recalculate derived metrics
                comparisonMetrics.margin = comparisonMetrics.totalSales > 0 ? (comparisonMetrics.netSales / comparisonMetrics.totalSales * 100) : 0;
                comparisonMetrics.rpa = comparisonMetrics.attendance > 0 ? (comparisonMetrics.totalSales / comparisonMetrics.attendance) : 0;
                // Event count represents average events per month
                comparisonMetrics.eventCount = Math.round(comparisonMetrics.eventCount / 12);
            }
            
            // Store events globally for use in expanded views
            // Add totalSales property to each event for display
            monthlyCurrentEvents = currentEvents.map(event => ({
                ...event,
                totalSales: window.VanguardData.getEventValue(event, 12) || 0
            }));
            monthlyComparisonEvents = comparisonEvents.map(event => ({
                ...event,
                totalSales: window.VanguardData.getEventValue(event, 12) || 0
            }));
            
            // Update UI with calculated metrics
            updateMonthlyMetrics(currentMetrics, comparisonMetrics);
            
            // Update event counts in header
            const eventCountEl = document.getElementById('monthlyEventCount');
            const poolCountEl = document.getElementById('monthlyPoolCount');
            if (eventCountEl) eventCountEl.textContent = currentEvents.length;
            if (poolCountEl) poolCountEl.textContent = currentEvents.length;
            
            // Update expanded details with actual events
            updateMonthlyExpandedDetails();
        }
        
        // Navigate to Events view and select a specific event
        function navigateToEvent(eventDate, location, isLate) {
            AppSounds.play('navigate');
            // Switch to Events view
            switchView('events');
            
            // Update the active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab')[0].classList.add('active');
            
            // Find and display the event
            if (window.VanguardData) {
                const events = window.VanguardData.getAllEvents();
                const targetEvent = events.find(e => 
                    e.date === eventDate && 
                    e.location === location && 
                    e.isLate === isLate
                );
                
                if (targetEvent) {
                    // Update the Events view to show this event
                    console.log('Navigating to event:', targetEvent);
                    // You would need to implement the actual event selection in Events view
                    // This might involve calling a function to update the Events view display
                }
            }
        }
        
        // Update the expanded details sections with actual event data
        function updateMonthlyExpandedDetails() {
            // Update Total Sales Details
            const salesDetails = document.getElementById('totalSalesDetails');
            if (salesDetails) {
                // Remove any existing event container
                const existingContainer = salesDetails.querySelector('.events-container');
                if (existingContainer) {
                    existingContainer.remove();
                }
                
                // Add a new section for individual events after the summary
                const eventsHtml = `
                    <div class="events-container" style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                        <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 10px;">Individual Events (${monthlyCurrentEvents.length} events)</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; max-height: 300px; overflow-y: auto;">
                            ${monthlyCurrentEvents.sort((a, b) => new Date(b.date) - new Date(a.date)).map(event => {
                                const eventDate = new Date(event.date.replace(/\s+(Late|PM)/gi, ''));
                                const dateStr = `${eventDate.getMonth() + 1}/${eventDate.getDate()}`;
                                return `
                                <div onclick="navigateToEvent('${event.date}', '${event.location}', ${event.isLate})" 
                                     style="padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                                     onmouseover="this.style.background='#e0e7ff'; this.style.borderColor='#3b82f6';"
                                     onmouseout="this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb';">
                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">${dateStr} ${event.isLate ? '(Late)' : ''}</div>
                                    <div style="font-size: 13px; font-weight: 600; color: #1e293b;">$${event.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                    <div style="font-size: 10px; color: #64748b;">${event.location} • ${event.day}</div>
                                </div>
                            `}).join('')}
                        </div>
                        ${monthlyComparisonEvents.length > 0 ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 10px;">Comparison Period Events (${monthlyComparisonEvents.length} events)</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;">
                                ${monthlyComparisonEvents.sort((a, b) => new Date(b.date) - new Date(a.date)).map(event => {
                                    const eventDate = new Date(event.date.replace(/\s+(Late|PM)/gi, ''));
                                    const dateStr = `${eventDate.getMonth() + 1}/${eventDate.getDate()}`;
                                    return `
                                    <div onclick="navigateToEvent('${event.date}', '${event.location}', ${event.isLate})" 
                                         style="padding: 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; transition: all 0.2s; opacity: 0.8;"
                                         onmouseover="this.style.background='#e0e7ff'; this.style.borderColor='#3b82f6'; this.style.opacity='1';"
                                         onmouseout="this.style.background='#f3f4f6'; this.style.borderColor='#d1d5db'; this.style.opacity='0.8';">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">${dateStr} ${event.isLate ? '(Late)' : ''}</div>
                                        <div style="font-size: 13px; font-weight: 600; color: #475569;">$${event.totalSales.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</div>
                                        <div style="font-size: 10px; color: #64748b;">${event.location} • ${event.day}</div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Append the events HTML at the end of the details section
                salesDetails.insertAdjacentHTML('beforeend', eventsHtml);
            }
            
            // Update other expandable sections similarly
            updateExpandedSection('payoutsDetails', 'totalPayouts', 'Payouts');
            updateExpandedSection('netSalesDetails', 'netSales', 'Net Sales');
            updateExpandedSection('attendanceDetails', 'attendance', 'Attendance');
            
            // Update the Revenue+ line charts with filtered data
            updateMonthlyCharts();
        }
        
        // Helper function to update expanded sections
        function updateExpandedSection(detailsId, metricKey, metricName) {
            const details = document.getElementById(detailsId);
            if (details) {
                // Remove any existing event container
                const existingContainer = details.querySelector('.events-container');
                if (existingContainer) {
                    existingContainer.remove();
                }
                
                // Add events for this metric
                const eventsHtml = `
                    <div class="events-container" style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                        <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 10px;">Individual Events</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; max-height: 300px; overflow-y: auto;">
                            ${monthlyCurrentEvents.sort((a, b) => new Date(b.date) - new Date(a.date)).map(event => {
                                const eventDate = new Date(event.date.replace(/\s+(Late|PM)/gi, ''));
                                const dateStr = `${eventDate.getMonth() + 1}/${eventDate.getDate()}`;
                                const value = event[metricKey] || 0;
                                const displayValue = metricKey === 'attendance' ? value.toFixed(0) : '$' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                                return `
                                <div onclick="navigateToEvent('${event.date}', '${event.location}', ${event.isLate})" 
                                     style="padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                                     onmouseover="this.style.background='#e0e7ff'; this.style.borderColor='#3b82f6';"
                                     onmouseout="this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb';">
                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">${dateStr} ${event.isLate ? '(Late)' : ''}</div>
                                    <div style="font-size: 13px; font-weight: 600; color: #1e293b;">${displayValue}</div>
                                    <div style="font-size: 10px; color: #64748b;">${event.location} • ${event.day}</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
                
                details.insertAdjacentHTML('beforeend', eventsHtml);
            }
        }
        
        // Calculate metrics for a set of events
        function calculatePeriodMetrics(events) {
            let metrics = {
                totalSales: 0,
                totalPayouts: 0,
                attendance: 0,
                flash: 0,
                cherries: 0,
                paper: 0,
                strips: 0,
                eventCount: events.length
            };
            
            events.forEach(event => {
                metrics.totalSales += window.VanguardData.getEventValue(event, 12) || 0;
                metrics.totalPayouts += window.VanguardData.getEventValue(event, 29) || 0;
                metrics.attendance += window.VanguardData.getEventValue(event, 37) || 0;
                metrics.flash += window.VanguardData.getEventValue(event, 6) || 0;
                metrics.cherries += window.VanguardData.getEventValue(event, 7) || 0;
                metrics.paper += window.VanguardData.getEventValue(event, 8) || 0;
                metrics.strips += window.VanguardData.getEventValue(event, 9) || 0;
            });
            
            // Calculate derived metrics
            metrics.netSales = metrics.totalSales - metrics.totalPayouts;
            metrics.margin = metrics.totalSales > 0 ? (metrics.netSales / metrics.totalSales * 100) : 0;
            metrics.rpa = metrics.attendance > 0 ? (metrics.totalSales / metrics.attendance) : 0;
            
            return metrics;
        }
        
        function updateMonthlyMetrics(currentMetrics, comparisonMetrics) {
            // Helper function to calculate percentage change
            function getPercentChange(current, previous) {
                if (!previous || previous === 0) return 0;
                return ((current - previous) / previous) * 100;
            }
            
            // Helper function to format percentage with arrow
            function formatPercentage(percent) {
                if (percent > 0) {
                    return `↑ ${Math.abs(percent).toFixed(1)}%`;
                } else if (percent < 0) {
                    return `↓ ${Math.abs(percent).toFixed(1)}%`;
                } else {
                    return '→ 0.0%';
                }
            }
            
            // Helper to format currency
            function formatCurrency(value) {
                return '$' + value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            
            // Find all main sections by looking for the onclick handlers
            const sections = document.querySelectorAll('#month-over-month-view [onclick^="toggleSection"]');
            
            sections.forEach(section => {
                const sectionName = section.getAttribute('onclick').match(/toggleSection\('(.+?)'\)/)?.[1];
                if (!sectionName) return;
                
                // Get the three boxes in each section
                const boxes = section.querySelectorAll(':scope > div');
                if (boxes.length !== 3) return;
                
                const comparisonBox = boxes[0];
                const currentBox = boxes[1];
                const dailyAvgBox = boxes[2];
                
                if (sectionName === 'totalSales') {
                    // Update Total Sales comparison value
                    const compValue = comparisonBox.querySelector('div:nth-child(2)');
                    if (compValue) compValue.textContent = formatCurrency(comparisonMetrics.totalSales);
                    
                    // Update Total Sales current value
                    const currValue = currentBox.querySelector('div:nth-child(2)');
                    if (currValue) currValue.textContent = formatCurrency(currentMetrics.totalSales);
                    
                    // Update Total Sales daily average
                    const avgValue = dailyAvgBox.querySelector('div:nth-child(2)');
                    if (avgValue && currentMetrics.eventCount > 0) {
                        avgValue.textContent = formatCurrency(currentMetrics.totalSales / currentMetrics.eventCount);
                    }
                    
                    // Update percentage change
                    const percentEl = currentBox.querySelector('div:nth-child(4)');
                    if (percentEl) {
                        const percent = getPercentChange(currentMetrics.totalSales, comparisonMetrics.totalSales);
                        percentEl.textContent = formatPercentage(percent);
                        percentEl.style.color = percent > 0 ? '#16a34a' : percent < 0 ? '#dc2626' : '#6b7280';
                    }
                    
                    // Update event counts
                    const compEvents = comparisonBox.querySelector('div:nth-child(3)');
                    if (compEvents) compEvents.textContent = `${comparisonMetrics.eventCount} Events`;
                    
                    const currEvents = currentBox.querySelector('div:nth-child(3)');
                    if (currEvents) currEvents.textContent = `${currentMetrics.eventCount} Events`;
                    
                } else if (sectionName === 'payouts') {
                    // Update Total Payouts comparison value
                    const compValue = comparisonBox.querySelector('div:nth-child(2)');
                    if (compValue) compValue.textContent = formatCurrency(comparisonMetrics.totalPayouts);
                    
                    // Update Total Payouts current value
                    const currValue = currentBox.querySelector('div:nth-child(2)');
                    if (currValue) currValue.textContent = formatCurrency(currentMetrics.totalPayouts);
                    
                    // Update Total Payouts daily average
                    const avgValue = dailyAvgBox.querySelector('div:nth-child(2)');
                    if (avgValue && currentMetrics.eventCount > 0) {
                        avgValue.textContent = formatCurrency(currentMetrics.totalPayouts / currentMetrics.eventCount);
                    }
                    
                    // Update percentage of sales
                    const compPctSales = comparisonBox.querySelector('div:nth-child(3)');
                    if (compPctSales && comparisonMetrics.totalSales > 0) {
                        const pct = (comparisonMetrics.totalPayouts / comparisonMetrics.totalSales * 100).toFixed(1);
                        compPctSales.textContent = `${pct}% of Sales`;
                    }
                    
                    const currPctSales = currentBox.querySelector('div:nth-child(3)');
                    if (currPctSales && currentMetrics.totalSales > 0) {
                        const pct = (currentMetrics.totalPayouts / currentMetrics.totalSales * 100).toFixed(1);
                        currPctSales.textContent = `${pct}% of Sales`;
                    }
                    
                    // Update percentage change
                    const percentEl = currentBox.querySelector('div:nth-child(4)');
                    if (percentEl) {
                        const percent = getPercentChange(currentMetrics.totalPayouts, comparisonMetrics.totalPayouts);
                        percentEl.textContent = formatPercentage(percent);
                        percentEl.style.color = percent > 0 ? '#f87171' : percent < 0 ? '#16a34a' : '#6b7280'; // Red when up (bad for payouts)
                    }
                    
                } else if (sectionName === 'netSales') {
                    // Update Net Sales comparison value
                    const compValue = comparisonBox.querySelector('div:nth-child(2)');
                    if (compValue) compValue.textContent = formatCurrency(comparisonMetrics.netSales);
                    
                    // Update Net Sales current value
                    const currValue = currentBox.querySelector('div:nth-child(2)');
                    if (currValue) currValue.textContent = formatCurrency(currentMetrics.netSales);
                    
                    // Update Net Sales daily average
                    const avgValue = dailyAvgBox.querySelector('div:nth-child(2)');
                    if (avgValue && currentMetrics.eventCount > 0) {
                        avgValue.textContent = formatCurrency(currentMetrics.netSales / currentMetrics.eventCount);
                    }
                    
                    // Update margin percentages
                    const compMargin = comparisonBox.querySelector('div:nth-child(3)');
                    if (compMargin) compMargin.textContent = comparisonMetrics.margin.toFixed(1) + '% Margin';
                    
                    const currMargin = currentBox.querySelector('div:nth-child(3)');
                    if (currMargin) currMargin.textContent = currentMetrics.margin.toFixed(1) + '% Margin';
                    
                    // Update percentage change for Net Sales
                    const percentEl = currentBox.querySelector('div:nth-child(4)');
                    if (percentEl) {
                        const percent = getPercentChange(currentMetrics.netSales, comparisonMetrics.netSales);
                        percentEl.textContent = formatPercentage(percent);
                        percentEl.style.color = percent > 0 ? '#22c55e' : percent < 0 ? '#dc2626' : '#6b7280'; // Green for net sales increase
                    }
                    
                    // Update daily average percentage change
                    const avgPercentEl = dailyAvgBox.querySelector('div:nth-child(4)');
                    if (avgPercentEl && comparisonMetrics.eventCount > 0) {
                        const currentAvg = currentMetrics.netSales / currentMetrics.eventCount;
                        const compAvg = comparisonMetrics.netSales / comparisonMetrics.eventCount;
                        const percent = getPercentChange(currentAvg, compAvg);
                        avgPercentEl.textContent = formatPercentage(percent);
                        avgPercentEl.style.color = percent > 0 ? '#22c55e' : percent < 0 ? '#dc2626' : '#6b7280';
                    }
                    
                } else if (sectionName === 'attendance') {
                    // Update Attendance comparison value
                    const compValue = comparisonBox.querySelector('div:nth-child(2)');
                    if (compValue) compValue.textContent = comparisonMetrics.attendance.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    
                    // For current box, the structure is different - it shows percentage first
                    const currValueEl = currentBox.querySelector('div:nth-child(2)');
                    const currAttendanceEl = currentBox.querySelector('div:nth-child(3)');
                    
                    if (currValueEl && currAttendanceEl) {
                        // Calculate capacity percentage (assuming max capacity similar to previous)
                        const maxCapacity = 11400; // Approximate based on 61% = 6896
                        const capacityPct = (currentMetrics.attendance / maxCapacity * 100).toFixed(0);
                        currValueEl.textContent = capacityPct + '%';
                        currAttendanceEl.textContent = currentMetrics.attendance.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' Attendees';
                    }
                    
                    // Update Attendance daily average
                    const avgValue = dailyAvgBox.querySelector('div:nth-child(2)');
                    if (avgValue && currentMetrics.eventCount > 0) {
                        avgValue.textContent = Math.round(currentMetrics.attendance / currentMetrics.eventCount).toString();
                    }
                    
                    // Update percentage change
                    const percentEl = currentBox.querySelector('div:nth-child(4)');
                    if (percentEl) {
                        const percent = getPercentChange(currentMetrics.attendance, comparisonMetrics.attendance);
                        percentEl.textContent = formatPercentage(percent);
                        percentEl.style.color = percent > 0 ? '#34d399' : percent < 0 ? '#dc2626' : '#6b7280'; // Green for attendance increase
                    }
                    
                    // Update comparison capacity percentage
                    const compCapacityEl = comparisonBox.querySelector('div:nth-child(3)');
                    if (compCapacityEl) {
                        const maxCapacity = 11400;
                        const capacityPct = (comparisonMetrics.attendance / maxCapacity * 100).toFixed(0);
                        compCapacityEl.textContent = capacityPct + '% of Max';
                    }
                }
            });
        }
        
        /* DISABLED - This was conflicting with updateMonthlyRevenueChart
        function updateMonthlyCharts_DISABLED() {
            console.log('updateMonthlyCharts called');
            
            // Get the SVG element for the line chart
            const svgElement = document.querySelector('.chart-placeholder svg');
            if (!svgElement) {
                console.error('Line chart SVG not found');
                return;
            }
            
            // Get all events and apply same filters as Monthly view
            const allEvents = window.VanguardData?.getAllEvents() || [];
            console.log('Total events available:', allEvents.length);
            if (allEvents.length === 0) {
                console.log('No events available for charts');
                return;
            }
            
            // Apply location filter
            let filteredEvents = allEvents;
            console.log('Location filter:', monthlyLocationFilter);
            if (monthlyLocationFilter === 'SC') {
                filteredEvents = filteredEvents.filter(e => e.location === 'SC');
            } else if (monthlyLocationFilter === 'RWC') {
                filteredEvents = filteredEvents.filter(e => e.location === 'RWC');
            }
            // COMBINED uses all events
            console.log('After location filter:', filteredEvents.length, 'events');
            
            // Apply day/Late filters (same as Monthly view)
            // Only filter if we have day data
            const eventsWithDay = filteredEvents.filter(e => e.day);
            if (eventsWithDay.length > 0) {
                filteredEvents = filteredEvents.filter(event => {
                    const day = event.day?.toLowerCase() || '';
                    const isLate = event.isLate;
                    
                    if (!day) return true; // Don't filter out events without day info
                    
                    if (isLate) {
                        return monthlyDayFilters[`${day}-late`] || false;
                    } else {
                        return monthlyDayFilters[day] || false;
                    }
                });
            }
            console.log('After day filters:', filteredEvents.length, 'events');
            
            // Apply Hotball filter if set
            const hotballFilter = document.getElementById('monthOverMonthHotballFilter')?.value || 'all';
            if (hotballFilter !== 'all') {
                filteredEvents = filteredEvents.filter(event => {
                    const hotball = window.VanguardData.getEventValue(event, 36); // Row 36 is Hotball Total
                    if (hotballFilter === 'with') {
                        return hotball > 0;
                    } else if (hotballFilter === 'without') {
                        return hotball === 0 || hotball === null || hotball === undefined;
                    }
                    return true;
                });
            }
            
            // Apply Day Only filter if checked
            const dayOnlyChecked = document.getElementById('monthOverMonthDayFilter')?.checked || false;
            if (dayOnlyChecked) {
                const selectedDay = document.getElementById('monthOverMonthDaySelector')?.value || '';
                if (selectedDay) {
                    filteredEvents = filteredEvents.filter(event => {
                        const eventDay = event.day?.toLowerCase() || '';
                        return eventDay === selectedDay.toLowerCase();
                    });
                }
            }
            
            console.log('After all filters:', filteredEvents.length, 'events');
            if (filteredEvents.length > 0) {
                console.log('Sample filtered event:', filteredEvents[0]);
            }
            
            // Group events by month and calculate averages
            const monthlyData = {};
            filteredEvents.forEach(event => {
                const eventDate = new Date(event.date);
                if (isNaN(eventDate.getTime())) {
                    console.log('Invalid date for event:', event);
                    return;
                }
                
                const monthKey = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = eventDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }).replace(' ', '-');
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        label: monthLabel,
                        totalSales: 0,
                        netSales: 0,
                        count: 0
                    };
                }
                
                const totalSales = window.VanguardData.getEventValue(event, 12) || 0;
                const netSales = window.VanguardData.getEventValue(event, 31) || 0;
                
                monthlyData[monthKey].totalSales += totalSales;
                monthlyData[monthKey].netSales += netSales;
                monthlyData[monthKey].count++;
            });
            
            // Convert to array with averages
            const allData = Object.keys(monthlyData).sort().map(key => ({
                month: monthlyData[key].label,
                totalSales: monthlyData[key].count > 0 ? monthlyData[key].totalSales / monthlyData[key].count : 0,
                netSales: monthlyData[key].count > 0 ? monthlyData[key].netSales / monthlyData[key].count : 0,
                eventCount: monthlyData[key].count
            }));
            
            console.log('Monthly data processed:', allData.length, 'months');
            console.log('Monthly data object:', monthlyData);
            if (allData.length > 0) {
                console.log('Sample month:', allData[0]);
                console.log('All months:', allData.map(d => d.month));
            }
            
            if (allData.length === 0) {
                console.log('No data after filtering');
                return;
            }
            
            // Data is already sorted by the monthKey (YYYY-MM)
            
            // Take last 12 months
            const chartData = allData.slice(-12);
            
            // Calculate chart dimensions
            const chartWidth = 840 - 60;  // Total width minus margins
            const chartHeight = 240 - 40; // Total height minus margins
            const xStep = chartWidth / Math.max(chartData.length - 1, 1);
            
            // Find max value for scaling
            const maxValue = Math.max(
                ...chartData.map(d => d.totalSales),
                ...chartData.map(d => d.netSales),
                100000 // Minimum scale
            );
            
            // Round up to nice number for Y axis (smaller scale for averages)
            const yMax = Math.ceil(maxValue / 5000) * 5000;
            const yScale = chartHeight / yMax;
            
            // Create points for gross revenue line
            const grossPoints = chartData.map((d, i) => {
                const x = 60 + (i * xStep);
                const y = 240 - (d.totalSales * yScale);
                return `${x},${y}`;
            }).join(' ');
            
            // Create points for net revenue line
            const netPoints = chartData.map((d, i) => {
                const x = 60 + (i * xStep);
                const y = 240 - (d.netSales * yScale);
                return `${x},${y}`;
            }).join(' ');
            
            // Update the polylines using IDs
            const grossLine = document.getElementById('grossRevenueLine');
            const netLine = document.getElementById('netRevenueLine');
            
            if (grossLine) {
                grossLine.setAttribute('points', grossPoints);
                console.log('Updated gross line with points:', grossPoints.substring(0, 50) + '...');
            } else {
                console.error('Could not find grossRevenueLine element');
            }
            
            if (netLine) {
                netLine.setAttribute('points', netPoints);
                console.log('Updated net line with points:', netPoints.substring(0, 50) + '...');
            } else {
                console.error('Could not find netRevenueLine element');
            }
            
            // Update Y axis labels
            const yLabels = svgElement.querySelectorAll('.y-axis-labels text');
            const yStep = yMax / 6;
            yLabels.forEach((label, i) => {
                const value = yMax - (i * yStep);
                label.textContent = '$' + Math.round(value / 1000) + 'K';
            });
            
            // Update X axis labels with actual months
            const xLabels = svgElement.querySelectorAll('.x-axis-labels text');
            chartData.forEach((d, i) => {
                if (xLabels[i]) {
                    xLabels[i].textContent = d.month.split('-')[0]; // Just show month abbreviation
                }
            });
            
            // Clear remaining x-axis labels if we have fewer months
            for (let i = chartData.length; i < xLabels.length; i++) {
                if (xLabels[i]) {
                    xLabels[i].textContent = '';
                }
            }
            
            // Update legend to show it's averages
            const legendTexts = svgElement.querySelectorAll('.legend text');
            if (legendTexts[0]) legendTexts[0].textContent = 'Avg Gross/Event';
            if (legendTexts[1]) legendTexts[1].textContent = 'Avg Net/Event';
            
            console.log(`Line chart updated: ${chartData.length} months, Hotball: ${hotballFilter}, Day Only: ${dayOnlyChecked ? 'Yes' : 'No'}`);
        }
        */
        
        // Replace with a simple wrapper that calls the correct function
        function updateMonthlyCharts() {
            console.log('Calling updateMonthlyRevenueChart instead');
            updateMonthlyRevenueChart();
        }
        
        function updateComparisonPeriod(value) {
            // Update all comparison box labels based on selected comparison period
            const comparisonBoxes = document.querySelectorAll('[data-comparison-label]');
            let labelText = 'Previous 30 Days';
            
            switch(value) {
                case '30':
                    labelText = 'Previous 30 Days';
                    break;
                case 'prev-month':
                    labelText = 'Previous Month';
                    break;
                case '3months':
                    labelText = '3 Month Average';
                    break;
                case '12months':
                    labelText = '12 Month Average';
                    break;
            }
            
            comparisonBoxes.forEach(box => {
                box.textContent = labelText;
            });
            
            console.log('Comparison period updated to:', labelText);
            
            // Refresh the view with the new comparison period
            const currentPeriod = document.getElementById('monthOverMonthTimePeriod')?.value || '30';
            updateMonthlyView(currentPeriod);
        }
        
        // Toggle expandable sections in Month over Month view
        function toggleSection(sectionName) {
            const sectionId = sectionName + 'Details';
            const details = document.getElementById(sectionId);
            
            if (details) {
                if (details.style.display === 'none' || !details.style.display) {
                    details.style.display = 'block';
                    // Add smooth animation
                    details.style.animation = 'slideDown 0.3s ease-out';
                } else {
                    details.style.display = 'none';
                }
            }
        }
        
        // Navigate to Events tab and select specific event
        function goToEvent(eventName) {
            // Switch to Events view
            switchView('events');
            
            // Update the active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab')[0].classList.add('active');
            
            // Find and select the event in the Events view
            // This would need to be implemented based on your Events view structure
            console.log('Navigating to event:', eventName);
        }
        
        // Cache for tracking rendered events
        let sheetsViewCache = {
            renderedEvents: new Set(),
            currentLocation: null,
            currentSubview: 'daily',
            tableInitialized: false
        };

        // Update Data Subview (Daily/Monthly/Data Test)
        function updateDataSubview() {
            const subview = document.getElementById('dataSubviewFilter')?.value || 'daily';
            const location = document.getElementById('dataLocationFilter')?.value || 'SC';
            const title = document.getElementById('dataViewTitle');
            
            sheetsViewCache.currentSubview = subview;
            
            // Update title based on subview
            if (subview === 'daily') {
                title.textContent = `Master Sheet View - ${location} Daily`;
            } else if (subview === 'monthly') {
                title.textContent = `Master Sheet View - ${location} Monthly`;
            } else if (subview === 'datatest') {
                title.textContent = `Data Test - ${location} Monthly Validation`;
            }
            
            // Keep location filter visible for all views
            document.getElementById('dataLocationFilter').style.display = 'block';
            
            // Force rebuild when switching subviews
            updateSheetsView(true);
        }

        // Update Sheets View with differential rendering
        function updateSheetsView(forceRebuild = false) {
            console.log('updateSheetsView called');
            if (!window.VanguardData || !window.VanguardData.data) {
                console.error('Data not loaded yet - VanguardData:', window.VanguardData);
                return;
            }
            
            const subview = document.getElementById('dataSubviewFilter')?.value || 'daily';
            const location = document.getElementById('dataLocationFilter')?.value || 'SC';
            
            let data;
            if (subview === 'daily') {
                data = location === 'SC' ? window.VanguardData.data.sc : window.VanguardData.data.rwc;
            } else if (subview === 'monthly') {
                data = location === 'SC' ? window.VanguardData.data.scMonthly : window.VanguardData.data.rwcMonthly;
            } else if (subview === 'datatest') {
                // Data Test needs both SC and RWC monthly data
                data = {
                    sc: window.VanguardData.data.scMonthly,
                    rwc: window.VanguardData.data.rwcMonthly,
                    events: window.VanguardData.getAllEvents()
                };
            }
            const table = document.getElementById('sheetsTable');
            
            if (!table || !data) return;
            
            // Check if we need to rebuild (subview changed, location changed, or force rebuild)
            if (forceRebuild || 
                location !== sheetsViewCache.currentLocation || 
                subview !== sheetsViewCache.currentSubview ||
                !sheetsViewCache.tableInitialized) {
                
                // Full rebuild based on subview
                if (subview === 'daily') {
                    buildSheetsTable(table, data, location);
                    sheetsViewCache.renderedEvents = new Set(data.columns?.map(col => col.header) || []);
                } else if (subview === 'monthly') {
                    buildMonthlyTable(table, data, location);
                    sheetsViewCache.renderedEvents = new Set(data.columns?.map(col => col.header) || []);
                } else if (subview === 'datatest') {
                    buildDataTestTable(table, data, location);
                    sheetsViewCache.renderedEvents = new Set();
                }
                
                sheetsViewCache.currentLocation = location;
                sheetsViewCache.currentSubview = subview;
                sheetsViewCache.tableInitialized = true;
            } else if (subview === 'daily' || subview === 'monthly') {
                // Differential update - only add new columns for daily/monthly views
                const currentColumns = data.columns || [];
                const newColumns = currentColumns.filter(col => !sheetsViewCache.renderedEvents.has(col.header));
                
                if (newColumns.length > 0) {
                    console.log(`Adding ${newColumns.length} new columns to Data tab`);
                    if (subview === 'daily') {
                        appendNewColumns(table, newColumns, location);
                    } else if (subview === 'monthly') {
                        appendMonthlyColumns(table, newColumns, location);
                    }
                    
                    // Update cache
                    newColumns.forEach(col => sheetsViewCache.renderedEvents.add(col.header));
                }
            }
        }
        
        // Build the complete table (used for initial load or location change)
        function buildSheetsTable(table, data, location) {
            // Clear table
            table.innerHTML = '';
            
            // Get all columns (events)
            const columns = data.columns || [];
            
            // Get row labels dynamically from the first column's data
            const rowLabels = [];
            const firstColumn = columns[0];
            
            // Extract labels from the first column's data
            for (let i = 1; i <= 62; i++) {
                if (firstColumn && firstColumn.data && firstColumn.data[`row${i}`]) {
                    rowLabels[i - 1] = firstColumn.data[`row${i}`].label || '';
                } else {
                    rowLabels[i - 1] = '';
                }
            }
            
            // Override certain labels for clarity if needed
            if (rowLabels[0] === 'Santa Clara - Daily Bingo ' || rowLabels[0] === 'Redwood City - Daily Bingo ') {
                rowLabels[0] = 'Location';
            }
            if (rowLabels[39] === 'SC Attendance' || rowLabels[39] === 'RWC Attendance') {
                rowLabels[39] = 'Attendance';
            }
            
            // Create header row with column numbers
            const headerRow = document.createElement('tr');
            headerRow.id = 'sheetsHeaderRow';
            headerRow.innerHTML = '<th style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; width: 25px; text-align: center; color: #6b7280; font-weight: normal;"></th>';
            
            // Add column headers (A, B, C, etc.)
            columns.forEach((col, idx) => {
                const letter = String.fromCharCode(65 + idx); // A, B, C...
                headerRow.innerHTML += `<th style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; text-align: center; color: #6b7280; font-weight: normal; min-width: 80px;">${letter}</th>`;
            });
            table.appendChild(headerRow);
            
            // Create data rows (1-62) with IDs for easy access
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            for (let rowNum = 1; rowNum <= 62; rowNum++) {
                const row = document.createElement('tr');
                row.id = `sheetsRow${rowNum}`;
                
                // Row number
                const rowNumCell = document.createElement('td');
                rowNumCell.style.cssText = 'border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; text-align: center; color: #6b7280; font-weight: normal;';
                rowNumCell.textContent = rowNum;
                row.appendChild(rowNumCell);
                
                // Column A - Row label/description
                const labelCell = document.createElement('td');
                labelCell.style.cssText = 'border: 1px solid #d1d5db; background: #f9fafb; padding: 3px 6px; text-align: left; color: #1e293b; font-weight: 600; min-width: 120px;';
                labelCell.textContent = rowLabels[rowNum - 1] || '';
                row.appendChild(labelCell);
                
                // Add data cells (B, C, D, etc.)
                columns.forEach(col => {
                    row.appendChild(createDataCell(col, rowNum, location, rowLabels));
                });
                
                fragment.appendChild(row);
            }
            
            // Append all rows at once
            table.appendChild(fragment);
        }
        
        // Build Monthly table - different row structure than Daily
        function buildMonthlyTable(table, data, location) {
            // Clear table
            table.innerHTML = '';
            
            if (!data || !data.columns) {
                table.innerHTML = '<tr><td>Monthly data not available yet</td></tr>';
                return;
            }
            
            // Filter out Average and Total columns - they're not actual months
            const columns = (data.columns || []).filter(col => {
                const header = (col.header || '').toLowerCase();
                return !header.includes('average') && 
                       !header.includes('total') && 
                       !header.includes('avg') && 
                       !header.includes('sum');
            });
            
            // Define row labels for Monthly data (rows 1-62)
            const monthlyRowLabels = {
                1: 'Location',
                2: 'Month',
                3: 'Date Range',
                4: 'Days',
                5: '',
                6: 'Flash',
                7: 'Cherries',
                8: 'Paper',
                9: 'Strips',
                10: 'Merch',
                11: '',
                12: 'Total Sales',
                13: '',
                14: '',
                15: '',
                16: 'Strip Payouts',
                17: 'Paper Payouts',
                18: 'Flash Payouts',
                19: 'Numbers Payouts',
                20: 'Double Action',
                21: 'Winnemucca',
                22: 'RWB',
                23: 'Color',
                24: 'Fast5',
                25: 'Wild1',
                26: 'Bonanza',
                27: 'Super Payout',
                28: '',
                29: 'Total Payouts',
                30: '',
                31: 'Net Sales',
                32: '',
                33: '',
                34: '',
                35: 'Hotball Change',
                36: 'Hotball Total',
                37: '',
                38: '',
                39: '',
                40: 'Attendance',
                41: '',
                42: 'RPA',
                43: 'Payout %',
                44: '',
                45: 'Flash %',
                46: 'Cherries %',
                47: 'Paper %',
                48: 'Strips %',
                49: 'Merch %',
                50: '',
                51: 'Strip Payout %',
                52: 'Paper Payout %',
                53: 'Flash Payout %',
                54: 'Numbers Payout %',
                55: 'Double Action %',
                56: 'Winnemucca %',
                57: 'RWB %',
                58: 'Color %',
                59: 'Fast5 %',
                60: 'Wild1 %',
                61: 'Bonanza %',
                62: 'Super Payout %'
            };
            
            // Create header row with column A for row labels
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; width: 25px; text-align: center; color: #6b7280; font-weight: normal;"></th>';
            headerRow.innerHTML += '<th style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; min-width: 120px; text-align: left; color: #6b7280; font-weight: normal;">A</th>';
            
            columns.forEach((col, idx) => {
                const letter = String.fromCharCode(66 + idx); // Start from B since A is row labels
                headerRow.innerHTML += `<th style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; text-align: center; color: #6b7280; font-weight: normal; min-width: 80px;">${letter}</th>`;
            });
            table.appendChild(headerRow);
            
            // Build rows based on Monthly structure
            const fragment = document.createDocumentFragment();
            const maxRow = 62; // Always show all 62 rows for Monthly
            
            for (let rowNum = 1; rowNum <= maxRow; rowNum++) {
                const row = document.createElement('tr');
                
                // Check if this row should be bold (Total Sales, Total Payouts, Net Sales)
                const isBoldRow = (rowNum === 12 || rowNum === 29 || rowNum === 31);
                
                // Row number
                row.innerHTML = `<td style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; text-align: center; color: #6b7280; font-weight: normal;">${rowNum}</td>`;
                
                // Add column A with row label
                const labelCell = document.createElement('td');
                labelCell.style.cssText = `border: 1px solid #d1d5db; padding: 3px 6px; font-size: 12px; text-align: left; background: #f9fafb;${isBoldRow ? ' font-weight: bold;' : ''}`;
                labelCell.textContent = monthlyRowLabels[rowNum] || '';
                row.appendChild(labelCell);
                
                // Add cells for each column
                columns.forEach(col => {
                    const cell = document.createElement('td');
                    let cellValue = '';
                    let cellStyle = `border: 1px solid #d1d5db; padding: 3px 6px; font-size: 12px;${isBoldRow ? ' font-weight: bold;' : ''}`;
                    
                    if (rowNum === 1) {
                        // Location row
                        cellValue = location === 'SC' ? 'Santa Clara - Monthly' : 'Redwood City - Monthly';
                        cellStyle += ' font-weight: bold; background: #f9fafb;';
                    } else if (rowNum === 2) {
                        // Month header (e.g., "Sept-2024") - remove any timestamp
                        let monthHeader = col.header || '';
                        // Remove various timestamp formats
                        monthHeader = monthHeader.replace(/T\d{2}:\d{2}:\d{2}(\.\d{3})?Z?/g, '');
                        monthHeader = monthHeader.replace(/\s+\d{2}:\d{2}:\d{2}/g, '');
                        monthHeader = monthHeader.replace(/\s+GMT[+-]\d{4}/g, '');
                        cellValue = monthHeader;
                        cellStyle += ' text-align: center; font-weight: bold;';
                    } else if (col.data && col.data[`row${rowNum}`]) {
                        let val = col.data[`row${rowNum}`].value;
                        if (val !== undefined && val !== null && val !== '') {
                            // Special handling for row 3 - remove timestamps from dates
                            if (rowNum === 3 && typeof val === 'string') {
                                val = val.replace(/T\d{2}:\d{2}:\d{2}(\.\d{3})?Z?/g, '');
                                val = val.replace(/\s+\d{2}:\d{2}:\d{2}/g, '');
                                val = val.replace(/\s+GMT[+-]\d{4}/g, '');
                                val = val.replace(/\s*\(Pacific Daylight Time\)/gi, '');
                                val = val.replace(/\s*\(Pacific Standard Time\)/gi, '');
                                val = val.replace(/\s*\(PDT\)/gi, '');
                                val = val.replace(/\s*\(PST\)/gi, '');
                                cellValue = val;
                            } else {
                                cellValue = formatMonthlyValue(val, rowNum, monthlyRowLabels[rowNum], location);
                            }
                        }
                    }
                    
                    cell.style.cssText = cellStyle;
                    cell.textContent = cellValue;
                    row.appendChild(cell);
                });
                
                fragment.appendChild(row);
            }
            
            table.appendChild(fragment);
        }
        
        // Build Data Test table - comparison view for selected location
        function buildDataTestTable(table, data, selectedLocation) {
            // Clear table
            table.innerHTML = '';
            
            if (!data || !data.sc || !data.rwc) {
                table.innerHTML = '<tr><td>Monthly data not available for validation</td></tr>';
                return;
            }
            
            // Get the current location from dropdown if not passed
            const location = selectedLocation || document.getElementById('dataLocationFilter')?.value || 'SC';
            
            // Get data for selected location
            const monthlyData = location === 'SC' ? data.sc : data.rwc;
            const events = data.events.filter(e => e.location === location);
            const monthlyCalculated = calculateMonthlyTotals(events);
            
            // Build the test table for selected location
            buildLocationTestTable(table, monthlyData, monthlyCalculated, location);
        }
        
        // Build test table for a specific location
        function buildLocationTestTable(table, monthlyData, calculatedData, location) {
            if (!monthlyData || !monthlyData.columns || monthlyData.columns.length === 0) {
                table.innerHTML = `<tr><td>No ${location} monthly data available</td></tr>`;
                return;
            }
            
            // Filter out Average and Total columns - they're not actual months
            const months = (monthlyData.columns || []).filter(col => {
                const header = (col.header || '').toLowerCase();
                return !header.includes('average') && 
                       !header.includes('total') && 
                       !header.includes('avg') && 
                       !header.includes('sum');
            });
            
            // Create header row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
                <th style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; text-align: center;">Row</th>
                <th style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; min-width: 150px;">Label</th>`;
            
            // Add headers for each month
            months.forEach(month => {
                // Remove various timestamp formats from header
                let cleanHeader = (month.header || '');
                cleanHeader = cleanHeader.replace(/T\d{2}:\d{2}:\d{2}(\.\d{3})?Z?/g, '');
                cleanHeader = cleanHeader.replace(/\s+\d{2}:\d{2}:\d{2}/g, '');
                cleanHeader = cleanHeader.replace(/\s+GMT[+-]\d{4}/g, '');
                headerRow.innerHTML += `
                    <th colspan="3" style="border: 1px solid #d1d5db; background: #e5e7eb; padding: 3px 6px; text-align: center;">${cleanHeader}</th>`;
            });
            
            table.appendChild(headerRow);
            
            // Sub-header for Manual/Calculated/Diff
            const subHeaderRow = document.createElement('tr');
            subHeaderRow.innerHTML = `
                <th style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px;"></th>
                <th style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px;"></th>`;
            
            months.forEach(() => {
                subHeaderRow.innerHTML += `
                    <th style="border: 1px solid #d1d5db; background: #f9fafb; padding: 3px 6px; font-size: 11px;">Manual</th>
                    <th style="border: 1px solid #d1d5db; background: #f9fafb; padding: 3px 6px; font-size: 11px;">Calc</th>
                    <th style="border: 1px solid #d1d5db; background: #fef2f2; padding: 3px 6px; font-size: 11px;">Diff</th>`;
            });
            
            table.appendChild(subHeaderRow);
            
            // Build data rows
            const fragment = document.createDocumentFragment();
            
            // Get max row number from first column
            const firstColumn = months[0];
            const maxRow = Math.max(...Object.keys(firstColumn?.data || {}).map(k => parseInt(k.replace('row', '')) || 0));
            
            // Start from row 3 (skip location and header rows)
            for (let rowNum = 3; rowNum <= maxRow; rowNum++) {
                const row = document.createElement('tr');
                const label = firstColumn?.data?.[`row${rowNum}`]?.label || '';
                
                // Skip empty rows
                if (!label) continue;
                
                row.innerHTML = `
                    <td style="border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; text-align: center; font-size: 11px;">${rowNum}</td>
                    <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 11px;">${label}</td>`;
                
                months.forEach(monthCol => {
                    const monthHeader = monthCol.header;
                    
                    // Get manual value from Monthly sheet
                    let manualVal = monthCol.data?.[`row${rowNum}`]?.value || 0;
                    
                    // Special handling for row 3 - clean timestamps from dates
                    if (rowNum === 3 && typeof manualVal === 'string') {
                        manualVal = manualVal.replace(/T\d{2}:\d{2}:\d{2}(\.\d{3})?Z?/g, '');
                        manualVal = manualVal.replace(/\s+\d{2}:\d{2}:\d{2}/g, '');
                        manualVal = manualVal.replace(/\s+GMT[+-]\d{4}/g, '');
                    }
                    
                    // Get calculated value from events
                    let calcVal = calculatedData[monthHeader]?.[`row${rowNum}`] || 0;
                    
                    // Special handling for RWC row 4 (Events count)
                    if (location === 'RWC' && rowNum === 4) {
                        // For calculated value, count the number of events in this month
                        const monthEvents = calculatedData[monthHeader]?.eventCount || 0;
                        calcVal = monthEvents;
                    }
                    
                    // Calculate difference
                    const diff = manualVal - calcVal;
                    const hasDiff = Math.abs(diff) > 0.01;
                    
                    // Format values - pass location for context
                    // Special handling for row 3 (dates) - don't format as currency, just copy manual value
                    let formattedManual, formattedCalc, formattedDiff;
                    if (rowNum === 3) {
                        formattedManual = manualVal;
                        formattedCalc = manualVal; // Copy date from manual to calc
                        formattedDiff = '-'; // No diff for dates
                    } else {
                        formattedManual = formatMonthlyValue(manualVal, rowNum, label, location);
                        formattedCalc = formatMonthlyValue(calcVal, rowNum, label, location);
                        formattedDiff = hasDiff ? formatMonthlyValue(diff, rowNum, label, location) : '-';
                    }
                    
                    // Style cells
                    const diffStyle = hasDiff ? 'background: #fee2e2; color: #dc2626; font-weight: bold;' : 'color: #16a34a;';
                    
                    row.innerHTML += `
                        <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 11px; text-align: right;">${formattedManual}</td>
                        <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 11px; text-align: right;">${formattedCalc}</td>
                        <td style="border: 1px solid #d1d5db; padding: 3px 6px; font-size: 11px; text-align: right; ${diffStyle}">${formattedDiff}</td>`;
                });
                
                fragment.appendChild(row);
            }
            
            table.appendChild(fragment);
        }
        
        // Calculate monthly totals from daily events
        function calculateMonthlyTotals(events) {
            const monthlyTotals = {};
            
            events.forEach(event => {
                // Debug late events
                if (event.isLate && event.location === 'SC') {
                    console.log('Processing Late SC event:', event.date, event);
                }
                
                // Clean date string - remove "Late" or "PM" suffix to parse correctly
                let cleanDate = event.date;
                if (typeof cleanDate === 'string') {
                    // Remove Late, PM, LATE designations for parsing
                    cleanDate = cleanDate.replace(/\s+(Late|LATE|PM)/gi, '').trim();
                }
                
                // Parse date and get month key (e.g., "Sep-2024")
                const date = new Date(cleanDate);
                if (isNaN(date.getTime())) {
                    console.error('Failed to parse date:', event.date, 'cleaned to:', cleanDate);
                    return; // Skip this event if date can't be parsed
                }
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthKey = `${monthNames[date.getMonth()]}-${date.getFullYear()}`;
                
                if (!monthlyTotals[monthKey]) {
                    monthlyTotals[monthKey] = {
                        eventCount: 0  // Track number of events
                    };
                }
                
                // Count this event
                monthlyTotals[monthKey].eventCount++;
                
                // Aggregate values for each row - includes both regular and Late events
                // This needs to match the row mappings from VanguardData.ROWS
                const rowMappings = window.VanguardData.ROWS;
                Object.entries(rowMappings).forEach(([field, rowNum]) => {
                    const value = window.VanguardData.getEventValue(event, rowNum);
                    if (value !== null && !isNaN(value)) {
                        monthlyTotals[monthKey][`row${rowNum}`] = 
                            (monthlyTotals[monthKey][`row${rowNum}`] || 0) + value;
                    }
                });
            });
            
            return monthlyTotals;
        }
        
        // Format values for Monthly view
        function formatMonthlyValue(val, rowNum, label, location) {
            if (val === undefined || val === null || val === '') return '';
            
            // Special case: RWC row 4 is "Events" count, not a dollar amount
            if (location === 'RWC' && rowNum === 4) {
                return typeof val === 'number' ? val.toFixed(0) : val.toString();
            }
            
            // Determine formatting based on row number or label
            const percentageRows = [32, 43, 48]; // Margin and other percentages
            const attendanceRow = 40;
            const perAttendeeRows = [51, 52, 54];
            
            if (typeof val === 'number') {
                if (rowNum === attendanceRow) {
                    return val.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                } else if (percentageRows.includes(rowNum)) {
                    return val.toFixed(rowNum === 32 ? 1 : 2) + '%';
                } else if (perAttendeeRows.includes(rowNum)) {
                    return '$' + val.toFixed(2);
                } else {
                    return '$' + val.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                }
            }
            
            return val.toString();
        }
        
        // Append new monthly columns
        function appendMonthlyColumns(table, newColumns, location) {
            // Similar to appendNewColumns but for Monthly structure
            // Implementation would follow the same pattern as buildMonthlyTable
            console.log('Adding monthly columns:', newColumns.length);
        }
        
        // Append new columns to existing table
        function appendNewColumns(table, newColumns, location) {
            // Get row labels dynamically from the first existing column
            const existingFirstColumn = window.VanguardData?.data?.[location.toLowerCase()]?.columns?.[0];
            const rowLabels = [];
            
            for (let i = 1; i <= 62; i++) {
                if (existingFirstColumn && existingFirstColumn.data && existingFirstColumn.data[`row${i}`]) {
                    rowLabels[i - 1] = existingFirstColumn.data[`row${i}`].label || '';
                } else {
                    rowLabels[i - 1] = '';
                }
            }
            
            // Override certain labels for clarity
            if (rowLabels[0] === 'Santa Clara - Daily Bingo ' || rowLabels[0] === 'Redwood City - Daily Bingo ') {
                rowLabels[0] = 'Location';
            }
            if (rowLabels[39] === 'SC Attendance' || rowLabels[39] === 'RWC Attendance') {
                rowLabels[39] = 'Attendance';
            }
            
            // Add new column headers
            const headerRow = document.getElementById('sheetsHeaderRow');
            if (headerRow) {
                const existingColumns = headerRow.children.length - 1; // Subtract 1 for row number column
                newColumns.forEach((col, idx) => {
                    const letter = String.fromCharCode(65 + existingColumns + idx);
                    const th = document.createElement('th');
                    th.style.cssText = 'border: 1px solid #d1d5db; background: #f3f4f6; padding: 3px 6px; text-align: center; color: #6b7280; font-weight: normal; min-width: 80px;';
                    th.textContent = letter;
                    headerRow.appendChild(th);
                });
            }
            
            // Add new data cells to each row
            for (let rowNum = 1; rowNum <= 62; rowNum++) {
                const row = document.getElementById(`sheetsRow${rowNum}`);
                if (row) {
                    newColumns.forEach(col => {
                        row.appendChild(createDataCell(col, rowNum, location, rowLabels));
                    });
                }
            }
        }
        
        // Create a single data cell
        function createDataCell(col, rowNum, location, rowLabels) {
            const td = document.createElement('td');
            let cellValue = '';
            let cellStyle = 'border: 1px solid #d1d5db; padding: 2px 4px; text-align: right; color: #1e293b;';
            
            // Special handling for specific rows
            if (rowNum === 1) {
                cellValue = location;
                cellStyle += ' text-align: center; font-weight: bold;';
            } else if (rowNum === 3) {
                // Date row - remove timestamp if present
                let dateStr = col.header || '';
                // Remove various timestamp formats
                dateStr = dateStr.replace(/T\d{2}:\d{2}:\d{2}(\.\d{3})?Z?/g, ''); // T00:00:00.000Z or T00:00:00Z
                dateStr = dateStr.replace(/\s+\d{2}:\d{2}:\d{2}/g, ''); // Space followed by time
                dateStr = dateStr.replace(/\s+GMT[+-]\d{4}/g, ''); // GMT timezone
                dateStr = dateStr.replace(/\s*\(Pacific Daylight Time\)/gi, ''); // (Pacific Daylight Time)
                dateStr = dateStr.replace(/\s*\(Pacific Standard Time\)/gi, ''); // (Pacific Standard Time)
                dateStr = dateStr.replace(/\s*\(PDT\)/gi, ''); // (PDT)
                dateStr = dateStr.replace(/\s*\(PST\)/gi, ''); // (PST)
                cellValue = dateStr;
                cellStyle += ' text-align: center;';
            } else if (rowNum === 4) {
                // Day row - try multiple ways to get the value, then calculate from date if not provided
                const dayValue = col.data?.row4?.value || col.data?.row4 || col.data?.['row4']?.value || col.data?.['row4'] || '';
                const headerHasLate = col.header && (col.header.includes('Late') || col.header.includes('LATE'));
                
                // Debug row4 data structure
                if (col.header && col.header.includes('8/10')) {
                    console.log('Row 4 data for 8/10:', {
                        'col.data?.row4': col.data?.row4,
                        'typeof col.data?.row4': typeof col.data?.row4,
                        'dayValue': dayValue,
                        'headerHasLate': headerHasLate
                    });
                }
                
                if (dayValue && dayValue !== '' && dayValue !== 'undefined') {
                    // Use existing day value - it might already have (Late) appended
                    cellValue = dayValue;
                } else {
                    // Calculate day from date in header
                    const dateStr = col.header || '';
                    const cleanDateStr = dateStr.replace(/\s*Late/i, '').trim();
                    
                    if (cleanDateStr) {
                        const date = new Date(cleanDateStr);
                        if (!isNaN(date.getTime())) {
                            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                            const dayName = days[date.getDay()];
                            cellValue = headerHasLate ? `${dayName} (Late)` : dayName;
                        } else {
                            cellValue = headerHasLate ? 'Late' : '';
                        }
                    } else {
                        cellValue = '';
                    }
                }
                cellStyle += ' text-align: center;';
            } else if (col.data && col.data[`row${rowNum}`]) {
                // Regular data
                const val = col.data[`row${rowNum}`].value;
                if (val !== undefined && val !== null && val !== '') {
                    // Format numbers
                    if (typeof val === 'number') {
                        // Apply $ to everything EXCEPT attendance (row 40) and percentages (rows 32, 43, 48)
                        if (rowNum === 40) {
                            // Attendance - no dollar sign
                            cellValue = val.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        } else if (rowNum === 32) {
                            // Margin percentage - 1 decimal place
                            cellValue = val.toFixed(1) + '%';
                        } else if (rowNum === 43 || rowNum === 48) {
                            // Percentage rows - 2 decimal places
                            cellValue = val.toFixed(2) + '%';
                        } else if (rowNum === 51 || rowNum === 52 || rowNum === 54) {
                            // Per attendee values - 2 decimal places
                            cellValue = '$' + val.toFixed(2);
                        } else {
                            // Everything else gets dollar sign
                            cellValue = '$' + val.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        }
                    } else {
                        cellValue = val.toString();
                    }
                }
                
                // Make Total rows bold (12, 29, 31)
                if (rowNum === 12 || rowNum === 29 || rowNum === 31) {
                    cellStyle += ' font-weight: bold;';
                }
            }
            
            td.style.cssText = cellStyle;
            td.textContent = cellValue;
            return td;
        }
        
        // Export Sheets View to CSV
        function exportSheetsView() {
            AppSounds.play('success');
            if (!window.VanguardData || !window.VanguardData.data) {
                alert('Data not loaded yet');
                return;
            }
            
            const location = document.getElementById('dataLocationFilter')?.value || 'SC';
            const subview = document.getElementById('dataSubviewSelector')?.value || 'daily';
            
            let data;
            if (subview === 'monthly') {
                data = location === 'SC' ? window.VanguardData.data.scMonthly : window.VanguardData.data.rwcMonthly;
            } else {
                data = location === 'SC' ? window.VanguardData.data.sc : window.VanguardData.data.rwc;
            }
            
            if (!data || !data.columns) {
                alert('No data available for export');
                return;
            }
            
            let csv = '';
            const columns = data.columns || [];
            
            // Add header row with column A label
            csv += 'Row Label,';
            columns.forEach((col, idx) => {
                csv += `"${col.header}"${idx < columns.length - 1 ? ',' : ''}`;
            });
            csv += '\n';
            
            // Add data rows (1-62) with proper row labels from column A
            for (let rowNum = 1; rowNum <= 62; rowNum++) {
                // Get the row label from the first column's data or from data.rows
                let rowLabel = '';
                if (data.rows && data.rows[`row${rowNum}`]) {
                    rowLabel = data.rows[`row${rowNum}`].label || '';
                } else if (columns[0] && columns[0].data && columns[0].data[`row${rowNum}`]) {
                    rowLabel = columns[0].data[`row${rowNum}`].label || '';
                }
                
                csv += `"${rowLabel}",`;
                
                columns.forEach((col, idx) => {
                    let cellValue = '';
                    
                    if (rowNum === 1) {
                        cellValue = location;
                    } else if (rowNum === 3) {
                        cellValue = col.header;
                    } else if (rowNum === 4) {
                        cellValue = col.data?.row4?.value || '';
                    } else if (col.data && col.data[`row${rowNum}`]) {
                        cellValue = col.data[`row${rowNum}`].value || '';
                    }
                    
                    csv += `"${cellValue}"${idx < columns.length - 1 ? ',' : ''}`;
                });
                csv += '\n';
            }
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            const filePrefix = subview === 'monthly' ? `${location}_monthly` : `${location}_daily`;
            a.setAttribute('download', `${filePrefix}_${new Date().toISOString().split('T')[0]}.csv`);
            a.click();
        }
        
        // Export to CSV (old function - kept for compatibility)
        function exportToCSV() {
            if (!window.VanguardData || !window.VanguardData.data) {
                alert('Data not loaded yet');
                return;
            }
            
            const filter = document.getElementById('dataLocationFilter')?.value || 'all';
            const events = window.VanguardData.getAllEvents();
            const filteredEvents = filter === 'all' ? events : events.filter(e => e.location === filter);
            
            // Create CSV header
            let csv = 'Date,Day,Location,Session,Attendance,Capacity %,Total Sales,Payouts,Net Sales,Margin %,RPA,Flash,Cherries,Paper,Strips\n';
            
            // Add data rows
            filteredEvents.forEach(event => {
                const attendance = window.VanguardData.getEventValue(event, 37);
                const maxCapacity = event.location === 'SC' ? 430 : 200;
                const capacityPercent = (attendance / maxCapacity) * 100;
                const totalSales = window.VanguardData.getEventValue(event, 12);
                const payouts = window.VanguardData.getEventValue(event, 29);
                const netSales = window.VanguardData.getEventValue(event, 31);
                const margin = totalSales > 0 ? (netSales / totalSales) * 100 : 0;
                const rpa = attendance > 0 ? totalSales / attendance : 0;
                const flash = window.VanguardData.getEventValue(event, 6);
                const cherries = window.VanguardData.getEventValue(event, 7);
                const paper = window.VanguardData.getEventValue(event, 8);
                const strips = window.VanguardData.getEventValue(event, 9);
                
                csv += `"${event.date}","${event.day}","${event.location}","${event.isLate ? 'Late' : 'Regular'}",`;
                csv += `${Math.round(attendance)},${capacityPercent.toFixed(1)},${totalSales.toFixed(0)},`;
                csv += `${payouts.toFixed(0)},${netSales.toFixed(0)},${margin.toFixed(1)},${rpa.toFixed(0)},`;
                csv += `${flash.toFixed(0)},${cherries.toFixed(0)},${paper.toFixed(0)},${strips.toFixed(0)}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `bingo_data_${new Date().toISOString().split('T')[0]}.csv`);
            a.click();
        }
        
        // Add toggle dropdown function
        function toggleDropdown() {
            AppSounds.play('click');
            const dropdown = document.getElementById('eventDropdown');
            if (dropdown) {
                if (dropdown.style.display === 'none' || !dropdown.style.display) {
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            }
        }
        
        // Install PWA function
        function installPWA() {
            if (deferredPrompt) {
                // Show the install prompt
                deferredPrompt.prompt();
                
                // Wait for the user to respond to the prompt
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // Force data refresh with popup
        function forceDataRefresh() {
            // Show refresh confirmation popup
            const popup = document.getElementById('refreshPopup');
            const overlay = document.getElementById('refreshOverlay');
            
            overlay.style.display = 'block';
            popup.style.display = 'block';
            
            setTimeout(() => {
                overlay.classList.add('show');
                popup.classList.add('show');
                AppSounds.play('click');
            }, 10);
        }
        
        // Confirm refresh action
        async function confirmRefresh() {
            const popup = document.getElementById('refreshPopup');
            const overlay = document.getElementById('refreshOverlay');
            
            // Close confirmation popup
            popup.classList.remove('show');
            overlay.classList.remove('show');
            
            try {
                AppSounds.play('refresh');
                
                // Clear cache and last check time
                localStorage.removeItem('vanguard_data_cache');
                localStorage.removeItem('vanguard_last_check');
                
                // Clear EventManager data to force reload
                if (window.EventManager) {
                    window.EventManager.events = [];
                    window.EventManager.eventsById = {};
                    window.EventManager.eventsByLocation = { SC: [], RWC: [] };
                    console.log('🔄 Cleared EventManager cache');
                }
                
                // Show loading indicator on refresh button
                const btn = document.querySelector('button[onclick="forceDataRefresh()"]');
                if (btn) {
                    btn.textContent = '⏳ Loading...';
                    btn.disabled = true;
                }
                
                // Set flag to prevent welcome popup on refresh
                window.isDataRefresh = true;
                
                // Fetch fresh data
                await window.VanguardData.fetchData();
                
                // Reinitialize the app with new data (but don't show welcome popup)
                initializeAppWithData();
                
                // Restore button
                if (btn) {
                    btn.textContent = '↻ Refresh';
                    btn.disabled = false;
                }
                
                // Show success popup with event count
                setTimeout(() => {
                    const eventCount = window.VanguardData?.getAllEvents()?.length || 0;
                    showSuccessPopup(`Data refreshed successfully! ${eventCount} events loaded.`);
                }, 300);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                
                // Restore button
                const btn = document.querySelector('button[onclick="forceDataRefresh()"]');
                if (btn) {
                    btn.textContent = '↻ Refresh';
                    btn.disabled = false;
                }
                
                // Show error popup
                setTimeout(() => {
                    showErrorPopup('Failed to refresh data. Please try again.');
                }, 300);
            }
        }
        
        // Close refresh popup
        function closeRefreshPopup() {
            const popup = document.getElementById('refreshPopup');
            const overlay = document.getElementById('refreshOverlay');
            
            AppSounds.play('click');
            popup.classList.remove('show');
            overlay.classList.remove('show');
            
            setTimeout(() => {
                popup.style.display = 'none';
                overlay.style.display = 'none';
            }, 300);
        }
        
        // Show success popup
        function showSuccessPopup(message) {
            const popup = document.getElementById('successPopup');
            const overlay = document.getElementById('successOverlay');
            const messageEl = document.getElementById('successMessage');
            
            if (messageEl) messageEl.textContent = message;
            
            overlay.style.display = 'block';
            popup.style.display = 'block';
            
            setTimeout(() => {
                overlay.classList.add('show');
                popup.classList.add('show');
                AppSounds.play('success');
            }, 10);
        }
        
        // Close success popup
        function closeSuccessPopup() {
            const popup = document.getElementById('successPopup');
            const overlay = document.getElementById('successOverlay');
            
            AppSounds.play('click');
            popup.classList.remove('show');
            overlay.classList.remove('show');
            
            setTimeout(() => {
                popup.style.display = 'none';
                overlay.style.display = 'none';
            }, 300);
        }
        
        // Show update notification
        window.showUpdateNotification = function() {
            // Create a simple notification bar
            const updateBar = document.createElement('div');
            updateBar.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
                color: white;
                padding: 12px;
                text-align: center;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            updateBar.innerHTML = `
                📱 New version available! 
                <button onclick="location.reload()" style="
                    background: white;
                    color: #16a34a;
                    border: none;
                    padding: 4px 12px;
                    border-radius: 4px;
                    margin-left: 10px;
                    cursor: pointer;
                    font-weight: 600;
                ">Update Now</button>
            `;
            document.body.appendChild(updateBar);
        };
        
        // Show error popup
        function showErrorPopup(message) {
            const popup = document.getElementById('errorPopup');
            const overlay = document.getElementById('errorOverlay');
            const messageEl = document.getElementById('errorMessage');
            
            if (messageEl) messageEl.textContent = message;
            
            overlay.style.display = 'block';
            popup.style.display = 'block';
            
            setTimeout(() => {
                overlay.classList.add('show');
                popup.classList.add('show');
                AppSounds.play('event');
            }, 10);
        }
        
        // Close error popup
        function closeErrorPopup() {
            const popup = document.getElementById('errorPopup');
            const overlay = document.getElementById('errorOverlay');
            
            AppSounds.play('click');
            popup.classList.remove('show');
            overlay.classList.remove('show');
            
            setTimeout(() => {
                popup.style.display = 'none';
                overlay.style.display = 'none';
            }, 300);
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            // Close event dropdown
            const eventDropdown = document.getElementById('eventDropdown');
            const dropdownBtn = event.target.closest('.dropdown-trigger');
            if (eventDropdown && !event.target.closest('#eventDropdown') && !dropdownBtn) {
                eventDropdown.style.display = 'none';
            }
            
            // Close comparison dropdown
            const comparisonDropdown = document.querySelector('.comparison-dropdown .dropdown-menu');
            const comparisonBtn = event.target.closest('.comparison-dropdown button');
            if (comparisonDropdown && comparisonDropdown.classList.contains('show') && 
                !event.target.closest('.comparison-dropdown')) {
                comparisonDropdown.classList.remove('show');
            }
        });
    </script>
<!-- Data Integration Scripts -->
<!-- DISABLED: vanguard-data-integration.js was overwriting our DOM updates
<script src="vanguard-data-integration.js"></script>
-->

<script>
// Add UI enhancements after page loads
document.addEventListener('DOMContentLoaded', function() {
    // Set install button reference for PWA
    installButton = document.getElementById('installButton');
    
    // Initialize sound system
    AppSounds.init();
    
    // Add sounds to ALL interactive elements
    setTimeout(() => {
        // Add sounds to all dropdowns/selects
        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', () => AppSounds.play('click'));
        });
        
        // Add sounds to all checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => AppSounds.play('click'));
        });
        
        // Add sounds to all radio buttons
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', () => AppSounds.play('click'));
        });
        
        // Add sounds to any remaining buttons not caught by onclick
        document.querySelectorAll('button').forEach(button => {
            if (!button.onclick) {
                button.addEventListener('click', () => AppSounds.play('click'));
            }
        });
        
        // Add sounds to event comparison buttons
        document.querySelectorAll('.comparison-btn button').forEach(btn => {
            btn.addEventListener('click', () => AppSounds.play('click'));
        });
        
        // Add sounds to month-over-month filter changes
        const monthFilters = ['monthOverMonthHotballFilter', 'monthOverMonthDayFilter', 'monthOverMonthDaySelector'];
        monthFilters.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', () => AppSounds.play('click'));
            }
        });
        
        // Add sounds to sheets view type selector
        const sheetsViewType = document.getElementById('sheetsViewType');
        if (sheetsViewType) {
            sheetsViewType.addEventListener('change', () => AppSounds.play('navigate'));
        }
        
        // Add handler for Change Comparison button
        const changeComparisonBtn = document.getElementById('changeComparisonBtn');
        if (changeComparisonBtn) {
            changeComparisonBtn.addEventListener('click', function(e) {
                e.preventDefault();
                AppSounds.play('click');
                
                // Scroll to top smoothly
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Add highlight animation to the Compare To box
                const compareBox = document.getElementById('compareToBox');
                if (compareBox) {
                    // Remove animation class if it exists (to restart animation)
                    compareBox.classList.remove('highlight-animation');
                    // Force reflow to restart animation
                    void compareBox.offsetWidth;
                    // Add animation class
                    compareBox.classList.add('highlight-animation');
                    
                    // Remove animation class after animation completes
                    setTimeout(() => {
                        compareBox.classList.remove('highlight-animation');
                    }, 2000);
                }
            });
        }
        
        // Add tooltip hover behavior for info icon
        const infoTooltip = document.querySelector('.info-tooltip');
        if (infoTooltip) {
            const tooltipContent = infoTooltip.querySelector('.tooltip-content');
            if (tooltipContent) {
                infoTooltip.addEventListener('mouseenter', function() {
                    tooltipContent.style.display = 'block';
                });
                infoTooltip.addEventListener('mouseleave', function() {
                    tooltipContent.style.display = 'none';
                });
            }
        }
        
        // Add sounds to day filter elements
        const dayFilterCheckbox = document.getElementById('dayOnlyFilter');
        if (dayFilterCheckbox) {
            dayFilterCheckbox.addEventListener('change', () => AppSounds.play('click'));
        }
        
        const daySelector = document.getElementById('daySelector');
        if (daySelector) {
            daySelector.addEventListener('change', () => AppSounds.play('click'));
        }
        
        // Add sounds to location filter
        const locationFilter = document.getElementById('locationFilter');
        if (locationFilter) {
            locationFilter.addEventListener('change', () => AppSounds.play('click'));
        }
        
        // Add sounds to hotball filter
        const hotballFilter = document.getElementById('hotballFilter');
        if (hotballFilter) {
            hotballFilter.addEventListener('change', () => AppSounds.play('click'));
        }
        
        console.log('Sound system fully initialized for all interactive elements');
    }, 500);
    
    // Load cache data for VanguardData compatibility
    if (window.VanguardData) {
        const cacheLoaded = window.VanguardData.loadFromCache();
        console.log('VanguardData cache loaded:', cacheLoaded);
        
        // Check if we have data in cache
        const hasData = window.VanguardData.data?.sc?.columns?.length > 0 || 
                       window.VanguardData.data?.rwc?.columns?.length > 0;
        
        // Always fetch fresh data on app load, regardless of cache
        console.log('Fetching fresh data from server on app load...');
        window.VanguardData.fetchData().then(() => {
            console.log('Fresh data fetched successfully from server');
            initializeAppWithData();
        }).catch(error => {
            console.error('Failed to fetch fresh data:', error);
            
            // Fall back to cache if fetch fails
            if (hasData) {
                console.log('Network error - falling back to cached data:', {
                    sc: window.VanguardData.data?.sc ? 'loaded' : 'missing',
                    rwc: window.VanguardData.data?.rwc ? 'loaded' : 'missing', 
                    scMonthly: window.VanguardData.data?.scMonthly ? 'loaded' : 'missing',
                    rwcMonthly: window.VanguardData.data?.rwcMonthly ? 'loaded' : 'missing',
                    scColumns: window.VanguardData.data?.sc?.columns?.length || 0,
                    rwcColumns: window.VanguardData.data?.rwc?.columns?.length || 0
                });
                initializeAppWithData();
            } else {
                console.error('No data available - both fetch and cache failed');
                // Show error to user
                alert('Unable to load data. Please check your internet connection and refresh the page.');
            }
        });
    }
    
    // Function to initialize app with data
    function initializeAppWithData() {
        if (window.VanguardData.data) {
            // Initialize EventManager with VanguardData
            if (window.EventManager.loadFromVanguardData()) {
                // Select and display latest event
                window.EventManager.selectEvent('latest');
                
                // Initialize comparison system
                window.EventManager.initializeComparisons();
                
                // Populate event selector buttons with real events
                window.populateEventSelector();
                
                // Initialize the YTD chart by default with a delay to ensure DOM is ready
                setTimeout(() => {
                    updateYTDStackedChart();
                }, 500);
                
                // Show welcome popup after data loads (only once, only if we have data, and not on refresh)
                if (window.VanguardData?.getAllEvents()?.length > 0 && !window.isDataRefresh) {
                    setTimeout(() => {
                        // Only show if not already shown
                        if (!window.welcomePopupShown) {
                            showWelcomePopup();
                            window.welcomePopupShown = true;
                        }
                    }, 100);
                }
                
                // Clear refresh flag after initialization
                window.isDataRefresh = false;
                
                // Ensure the Latest button is marked as active (after buttons are populated)
                setTimeout(() => {
                    const latestBtn = document.querySelector('.event-btn[onclick*="latest"]');
                    if (latestBtn && !latestBtn.classList.contains('active')) {
                        document.querySelectorAll('.event-btn').forEach(btn => btn.classList.remove('active'));
                        latestBtn.classList.add('active');
                    }
                }, 50);
            } else {
                console.error('Failed to load events into EventManager');
            }
            
            // Update Data tab if it's the active view
            setTimeout(() => {
                updateSheetsView();
            }, 100);
        }
    }
    
    // REMOVED duplicate comparison dropdown code - this was causing duplicate UI
    // The comparison controls are already in the HTML at lines 760-780
    
    /* COMMENTED OUT ENTIRE DUPLICATE BLOCK
            // Create Day Only checkbox
            const dayOnlyContainer = document.createElement('label');
            dayOnlyContainer.style.cssText = `
                display: flex;
                align-items: center;
                gap: 5px;
                font-size: 12px;
                color: #64748b;
                cursor: pointer;
                margin-left: 10px;
            `;
            dayOnlyContainer.innerHTML = `
                <input type="checkbox" id="dayOnlyFilter" style="cursor: pointer;">
                <span>Day Only</span>
            `;
            
            // Create dropdown menu
            const dropdownMenu = document.createElement('div');
            dropdownMenu.id = 'comparisonDropdown';
            dropdownMenu.className = 'dropdown-menu';
            dropdownMenu.style.cssText = `
                position: absolute;
                top: 100%;
                left: 0;
                min-width: 150px;
                background: white;
                border: 1px solid #cbd5e1;
                border-radius: 6px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
                display: none;
                margin-top: 4px;
            `;
            
            // Add dropdown options
            const options = [
                { value: 'recent', label: 'Recent' },
                { value: '1month', label: '1 Month' },
                { value: '3months', label: '3 Months' }
            ];
            
            options.forEach(option => {
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 8px 12px;
                    cursor: pointer;
                    font-size: 13px;
                    border-bottom: 1px solid #f1f5f9;
                    color: #1e293b;
                `;
                item.textContent = option.label;
                item.onmouseover = () => { item.style.background = '#f1f5f9'; };
                item.onmouseout = () => { item.style.background = 'white'; };
                item.onclick = () => {
                    comparisonBtn.textContent = option.label + ' ▼';
                    dropdownMenu.classList.remove('show');
                    dropdownMenu.style.display = 'none';
                    
                    // Update comparison period
                    if (window.VanguardData) {
                        window.VanguardData.comparisonPeriod = option.value;
                        window.VanguardData.updateDashboard();
                    }
                };
                
                if (option.value === '3months') {
                    item.style.background = '#f0f9ff';
                    item.style.fontWeight = '600';
                }
                
                dropdownMenu.appendChild(item);
            });
            
            // Assemble the components
            comparisonContainer.appendChild(comparisonBtn);
            comparisonContainer.appendChild(dropdownMenu);
            comparisonContainer.appendChild(dayOnlyContainer);
            
            // Insert after event selector group
            eventSelectorGroup.parentNode.insertBefore(comparisonContainer, eventSelectorGroup.nextSibling);
            
            // Add event listener for Day Only checkbox
            document.getElementById('dayOnlyFilter').addEventListener('change', (e) => {
                if (window.VanguardData) {
                    window.VanguardData.dayOnlyFilter = e.target.checked;
                    window.VanguardData.updateDashboard();
                }
            });
        }
    }, 1000);
    */
    
    // DISABLED - EventManager already defines selectEvent at line 2730
    // Our duplicate was overwriting the working EventManager version!
    /*
    window.selectEvent = function(eventId) {
        AppSounds.play('event');
        console.log('=== SELECT EVENT CALLED ===');
        console.log('Event ID:', eventId);
        
        // Update button states
        document.querySelectorAll('.event-btn').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = 'white';
            btn.style.color = '#1e293b';
        });
        
        // Mark clicked button as active
        if (event && event.target) {
            event.target.classList.add('active');
            event.target.style.background = '#3b82f6';
            event.target.style.color = 'white';
        }
        
        // Get event data
        if (window.VanguardData) {
            const events = window.VanguardData.getAllEvents();
            console.log('Total events available:', events ? events.length : 0);
            
            let selectedEvent = null;
            let eventIndex = -1;
            
            if (eventId === 'latest') {
                selectedEvent = events[0];
                eventIndex = 0;
            } else {
                // Try to parse as number first (for dropdown items)
                const numId = parseInt(eventId);
                if (!isNaN(numId) && numId >= 0 && numId < events.length) {
                    selectedEvent = events[numId];
                    eventIndex = numId;
                } else {
                    // Map button IDs to event indices
                    const buttonMap = {
                        'tuesday-17': 0,      // Map to actual indices
                        'wednesday-16': 1,
                        'friday-14-late': 2,
                        'thursday-13': 3,
                        'wednesday-12-late': 4,
                        'tuesday-11': 5,
                        'monday-10': 6,
                        'sunday-9-late': 7,
                        'saturday-8': 8,
                        'friday-7-late': 9
                    };
                    
                    if (buttonMap[eventId] !== undefined && buttonMap[eventId] < events.length) {
                        selectedEvent = events[buttonMap[eventId]];
                        eventIndex = buttonMap[eventId];
                    }
                }
            }
            
            console.log('Selected event index:', eventIndex);
            
            if (selectedEvent) {
                console.log('Selected event data:', {
                    date: selectedEvent.date,
                    location: selectedEvent.location,
                    isLate: selectedEvent.isLate,
                    row36: window.VanguardData.getEventValue(selectedEvent, 36),
                    row6: window.VanguardData.getEventValue(selectedEvent, 6),
                    row9: window.VanguardData.getEventValue(selectedEvent, 9)
                });
                
                // Store as current event
                window.VanguardData.currentEvent = selectedEvent;
                
                // UPDATE OUR NEW TEST ELEMENTS
                console.log('Calling updateNewElements...');
                updateNewElements(selectedEvent);
                
                // Update original elements if they exist
                const hotballValue = document.getElementById('hotballValue');
                if (hotballValue) {
                    const hotballTotal = window.VanguardData.getEventValue(selectedEvent, 36) || 0;
                    hotballValue.textContent = '$' + hotballTotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    console.log('Updated original hotball to:', hotballValue.textContent);
                }
                
                // Force update all displays
                if (window.VanguardData.updateDashboard) {
                    console.log('Calling updateDashboard...');
                    window.VanguardData.updateDashboard();
                }
            } else {
                console.log('ERROR: Could not find event for ID:', eventId);
            }
        } else {
            console.log('ERROR: VanguardData not available');
        }
    };
    */
    
    /* COMMENTED OUT - Re-wiring buttons was interfering with EventManager
    // Also call updateNewElements on initial load
    setTimeout(() => {
        if (window.VanguardData) {
            const events = window.VanguardData.getAllEvents();
            console.log('Initial load - events available:', events ? events.length : 0);
        }
        
        // DIRECTLY wire up the event buttons since onclick might not be working
        document.querySelectorAll('.event-btn').forEach((btn, index) => {
            // Remove any existing onclick to avoid conflicts
            const existingOnclick = btn.getAttribute('onclick');
            if (existingOnclick) {
                console.log('Removing existing onclick from button:', btn.textContent, existingOnclick);
                btn.removeAttribute('onclick');
            }
            
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const btnText = btn.textContent.trim();
                console.log('=== BUTTON CLICKED DIRECTLY ===');
                console.log('Button text:', btnText);
                console.log('Button index:', index);
                
                if (btnText.includes('Latest')) {
                    console.log('Selecting latest event');
                    window.selectEvent('latest');
                } else if (btnText.includes('Event 2')) {
                    console.log('Selecting event index 1');
                    window.selectEvent(1);
                } else if (btnText.includes('Event 3')) {
                    console.log('Selecting event index 2');
                    window.selectEvent(2);
                } else if (btnText.includes('Event 4')) {
                    console.log('Selecting event index 3');
                    window.selectEvent(3);
                } else if (btnText.includes('Previous')) {
                    console.log('Dropdown button - not selecting event');
                    if (typeof toggleDropdown === 'function') {
                        toggleDropdown();
                    }
                } else {
                    console.log('Unknown button, using index:', index);
                    window.selectEvent(index);
                }
            });
        });
        
        console.log('=== EVENT BUTTONS RE-WIRED ===');
        console.log('Total buttons found:', document.querySelectorAll('.event-btn').length);
    }, 2500);  // Slightly longer delay to ensure everything is loaded
    */
    
    // Add a global handler to catch button clicks that might not be wired properly
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('event-btn')) {
            const onclickAttr = e.target.getAttribute('onclick');
            console.log('Global click handler - event button detected');
            console.log('Button text:', e.target.textContent);
            console.log('Onclick attribute:', onclickAttr);
        }
        
        // Play click sound for any element with cursor:pointer that doesn't already have a sound
        const computedStyle = window.getComputedStyle(e.target);
        if (computedStyle.cursor === 'pointer') {
            // Check if this element already played a sound (to avoid double sounds)
            if (!e.target.dataset.soundPlayed) {
                // Mark that we're playing sound for this click
                e.target.dataset.soundPlayed = 'true';
                setTimeout(() => {
                    delete e.target.dataset.soundPlayed;
                }, 100);
                
                // Only play if no other sound was recently played (within 50ms)
                if (!AppSounds.lastPlayTime || Date.now() - AppSounds.lastPlayTime > 50) {
                    AppSounds.play('click');
                    AppSounds.lastPlayTime = Date.now();
                }
            }
        }
    }, true); // Use capture phase to catch events before they bubble
});
</script>

</body>
</html>